<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>İlan Ver • Takas Çemberi</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--fg:#0b0b0b;--muted:#6b7280;--line:#e6e8ee;--acc:#0ea5e9;--ok:#16a34a;--bad:#dc2626}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--fg)}
    .wrap{max-width:960px;margin:24px auto;padding:16px}
    .card{border:1px solid var(--line);border-radius:16px;padding:20px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .gals{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:8px}
    .thumb img{width:100%;height:100px;object-fit:cover;border-radius:8px}
    .prog{height:6px;background:#f5f7fb;border-radius:999px;overflow:hidden;margin-top:6px}
    .bar{height:100%;width:0}
  </style>
</head>
<body>
  <div class="wrap"><div class="card">
    <h1>İlan Ver</h1>
    <form id="f" autocomplete="off">
      <label>Başlık</label><input id="title" type="text" required maxlength="80"/>
        <textarea id="desc" required maxlength="3000"></textarea>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, serverTimestamp, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    const firebaseConfig = {
      apiKey: "AIzaSyBUUNSYxoWNUsK0C-C04qTUm6fvg",
      authDomain: "ureten-eller-v2.firebaseapp.com",
      projectId: "ureten-eller-v2",
      storageBucket: "ureten-eller-v2.firebasestorage.app",
      messagingSenderId: "621494781131",
      appId: "1:621494781131:web:13cc3b061a5e94b7cf874e",
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const st   = getStorage(app);

    const $ = (id)=>document.getElementById(id);
    const f=$('f'), state=$('state'), note=$('note'), preview=$('preview'), photos=$('photos'), submitBtn=$('submitBtn');
    let currentUser=null;
    onAuthStateChanged(auth,(u)=>{
      if(!u){ location.href="auth.html?next=listing-new.html"; return; }
      currentUser=u;
    });

    photos.addEventListener('change', ()=>{
      preview.innerHTML='';
      const files=[...(photos.files||[])].slice(0,5);
      files.forEach((file,i)=>{
        const box=document.createElement('div'); box.className='thumb';
        const img=document.createElement('img'); img.src=URL.createObjectURL(file);
        const prog=document.createElement('div'); prog.className='prog';
        const bar=document.createElement('div'); bar.className='bar'; bar.style.background='linear-gradient(90deg,#93c5fd,#60a5fa)';
        prog.appendChild(bar); box.appendChild(img); box.appendChild(prog); preview.appendChild(box);
      });
    });
    function validateFiles(files){
      const arr=[...files];
      if(arr.length>5) return "En fazla 5 görsel yükleyebilirsiniz.";
      for(const f of arr){
        if(!/^image\\//.test(f.type)) return "Sadece resim dosyası (JPG/PNG/WebP).";
        if(f.size>10*1024*1024) return "Her görsel 10MB altında olmalı.";
      }
      return null;
    }
    const mkId=()=>('L'+Date.now().toString(36)+Math.random().toString(36).slice(2,7));
    f.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentUser){ state.textContent="Oturum bulunamadı."; return; }

      const title=$('title').value.trim();
      const desc =$('desc').value.trim();
      const cat  =$('cat').value;
      const city =$('city').value.trim();
      const want =$('want').value.trim()||null;
      const price=$('price').value?Number($('price').value):null;

      if(!title||!desc||!cat||!city){ state.textContent="Gerekli alanları doldurun."; return; }
      const files=[...(photos.files||[])];
      const err=validateFiles(files); if(err){ state.textContent=err; return; }

      try{
        submitBtn.disabled=true; state.textContent="İlan oluşturuluyor…";
        const id=mkId(); const refDoc=doc(db,'listings',id);
        await setDoc(refDoc,{
          title,desc,cat,city,want,price,
          ownerId:currentUser.uid,status:'pending',
          photos:[],coverPhoto:null,
          createdAt:serverTimestamp(),updatedAt:serverTimestamp()
        });
        const urls=[];
        for(let i=0;i<files.length;i++){
          const file=files[i];
          const safeName=file.name.replace(/[^a-zA-Z0-9_.-]/g,'_');
          const path=`listings/${id}/${i+1}-${safeName}`;
          const r=ref(st,path);
          const task=uploadBytesResumable(r,file,{contentType:file.type});
          const bar=preview.querySelectorAll('.bar')[i];
          await new Promise((res,rej)=>task.on('state_changed',(s)=>{
            const p=Math.round((s.bytesTransferred/s.totalBytes)*100);
            if(bar) bar.style.width=p+'%';
          },rej,res));
          urls.push(await getDownloadURL(task.snapshot.ref));
        }
  </script>
</body>
</html>
