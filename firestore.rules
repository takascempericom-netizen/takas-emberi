rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function isOwner(uid) { return isSignedIn() && request.auth.uid == uid; }
    function isAdmin() {
      return isSignedIn() && (
        request.auth.token.admin == true ||
        (request.auth.token.role in ['admin','moderator','support'])
      );
    }

    // Geçici geliştirme penceresi: 20 Eylül 2025'e kadar bazı işlemlere tolerans
    function devWindow() { return request.time < timestamp.date(2025, 9, 20); }

    // İlanlar
    match /listings/{id} {
      allow read: if true;                         // İlanlar herkese görünsün
      allow create: if isSignedIn();               // Sadece giriş yapan oluşturur
      allow update, delete: 
        if isOwner(resource.data.ownerId) || isAdmin() || devWindow();
    }

    // Sohbet / canlı destek (örnek: /chats/** veya /threads/** kullanıyorsan aynısını çoğalt)
    match /chats/{threadId}/{sub=**} {
      allow read, write:
        if (isSignedIn() && (
              request.auth.uid == resource.data.ownerId ||
              request.auth.uid == resource.data.buyerId
            )) || isAdmin() || devWindow();
    }

    // Admin’e özel dokümanlar (onay/ret kuyrukları vs.)
    match /admin/{doc=**} {
      allow read, write: if isAdmin() || devWindow();
    }

    // Kullanıcı profilleri
    match /users/{uid} {
      allow read: if isSignedIn() && (request.auth.uid == uid || isAdmin() || devWindow());
      allow create: if isSignedIn() && request.auth.uid == uid;
      allow update, delete: if request.auth.uid == uid || isAdmin() || devWindow();
    }

    // Diğer her şey: sadece dev penceresinde okunabilir olsun
    match /{document=**} {
      allow read: if devWindow();
    }
  }
}
