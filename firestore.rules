rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Kullanıcı profilleri
    match /users/{uid} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    // İlanlar
    match /listings/{lid} {
      allow read: if true;

      // Oluşturma: sadece giriş yapan kullanıcı ve sadece pending
      allow create: if request.auth != null
                    && request.resource.data.ownerId == request.auth.uid
                    && request.resource.data.status == "pending";

      // Güncelleme
      allow update: if request.auth != null && (
        // İlan sahibi: status değiştiremez
        (request.auth.uid == resource.data.ownerId
         && request.resource.data.status == resource.data.status)
        ||
        // Admin: users/{uid}.role == "admin"
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin")
      );

      // Silme: ilan sahibi veya admin
      allow delete: if request.auth != null && (
        request.auth.uid == resource.data.ownerId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
      );
    }

    // Admin’e giden mesajlar (kullanıcı gönderir, admin okur)
    match /adminMessages/{mid} {
      allow create: if request.auth != null; // herkes mesaj atabilir
      allow read: if isAdmin();
      allow update, delete: if isAdmin();
    }

    // Şikayetler (kullanıcı oluşturur, admin okur/işler)
    match /complaints/{cid} {
      allow create: if request.auth != null;
      allow read, update, delete: if isAdmin();
    }

    // Tüm kullanıcılara bildirim (admin yazar, herkes okur)
    match /notifications/{nid} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
  }
}

function isAdmin() {
  return request.auth != null
    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
}
