<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mesajlar ‚Ä¢ Takas √áemberi</title>
  <style>
    :root{--c1:#7c3aed;--c2:#06b6d4;--c3:#10b981;--c4:#f59e0b;--fg:#0f172a;--glass:rgba(255,255,255,.78);--brd:rgba(255,255,255,.5)}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--fg);
      background:linear-gradient(120deg,var(--c1),var(--c2),var(--c3),var(--c4));background-size:300% 300%;animation:grad 18s ease infinite;min-height:100vh}
    @keyframes grad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .hdr{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.2);backdrop-filter:blur(10px);border-bottom:1px solid var(--brd)}
    .hdr .in{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    .ttl{margin:0;font-size:20px;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.25)}
    .wrap{max-width:1100px;margin:16px auto 120px;padding:0 16px}
    .chat{display:grid;grid-template-columns:300px 1fr;gap:12px}
    @media (max-width:900px){.chat{grid-template-columns:1fr}.sidebar{order:2}.panel{order:1}}
    .card{background:var(--glass);border:1px solid var(--brd);border-radius:20px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .side-head{padding:10px 12px;border-bottom:1px solid var(--brd);font-weight:700}

    /* Ara√ß √ßubuƒüu (se√ß/toplu sil) */
    .side-tools{display:flex;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px solid var(--brd);background:rgba(255,255,255,.5)}
    .side-tools .grow{flex:1}
    .btn{border:1px solid var(--brd);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.danger{color:#ef4444;border-color:#ef4444;background:#fff}
    .btn[disabled]{opacity:.5;cursor:not-allowed}

    .threads{display:flex;flex-direction:column;gap:6px;padding:10px;max-height:60vh;overflow:auto}
    /* 5 kolon: checkbox | avatar | info | saat | sil */
    .thread{
      display:grid;grid-template-columns:24px 44px 1fr auto 30px;
      gap:8px;align-items:center;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px;cursor:pointer
    }
    .thread.active{border-color:#94a3b8;box-shadow:0 4px 12px rgba(15,23,42,.08)}
    .avatar{width:44px;height:44px;border-radius:999px;object-fit:cover;background:#f1f5f9;border:1px solid #e5e7eb}
    .tname{font-weight:700;line-height:1.2}
    .tname a{color:#0f172a;text-decoration:none}
    .tname a:hover{text-decoration:underline}
    .tmuted{font-size:12px;color:#64748b}
    .ck{width:16px;height:16px}
    .delOne{border:0;background:transparent;color:#ef4444;cursor:pointer;font-size:16px;line-height:1}

    .panel{display:grid;grid-template-rows:auto 1fr auto;min-height:420px}
    .panel-head{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--brd);background:rgba(255,255,255,.5)}
    .panel-head img{width:40px;height:40px;border-radius:999px;border:1px solid #e5e7eb;background:#f1f5f9}
    .panel-head .name{font-weight:700}
    .panel-head .name a{color:#0f172a;text-decoration:none}
    .panel-head .name a:hover{text-decoration:underline}

    .msgs{padding:12px;display:flex;flex-direction:column;gap:10px;overflow:auto;background:#fff}

    /* Mesaj satƒ±rƒ±: avatar + baloncuk + isim/saat */
    .msg-row{display:flex;align-items:flex-end;gap:8px}
    .msg-row.me{flex-direction:row-reverse}
    .msg-avatar{width:28px;height:28px;border-radius:999px;object-fit:cover;background:#f1f5f9;border:1px solid #e5e7eb}
    .msg-wrap{max-width:72%;display:flex;flex-direction:column}
    .msg-name{font-size:11px;color:#64748b;margin:0 4px 2px}
    .msg-name .time{margin-left:6px;opacity:.7}

    /* Baloncuk (eski .msg) */
    .msg{max-width:100%;padding:8px 10px;border-radius:12px;border:1px solid #e5e7eb;background:#f8fafc;word-wrap:break-word;white-space:pre-wrap}
    .msg.me{margin-left:auto;background:#111827;color:#fff;border-color:#111827}
    .msg .time{display:none} /* artƒ±k isim satƒ±rƒ±nda g√∂steriyoruz */

    .input{display:grid;grid-template-columns:1fr auto;gap:8px;padding:10px;border-top:1px solid var(--brd);background:rgba(255,255,255,.6)}
    .input input{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;background:#fff}

    .fixedbar{position:fixed;left:0;right:0;bottom:0;z-index:30}
    .fixedbar .in{max-width:1100px;margin:0 auto;padding:8px 12px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .fixedbar a{display:flex;flex-direction:column;gap:2px;align-items:center;justify-content:center;padding:8px 6px;border-radius:14px;text-decoration:none;color:#111827;font-weight:600;border:1px solid var(--brd);background:var(--glass)}
    .fixedbar a.active{background:#111827;color:#fff;border-color:#111827}
    .fixedbar:before{content:"";position:absolute;inset:-20px 0 -20px 0;z-index:-1;background:linear-gradient(90deg,var(--c1),var(--c2),var(--c3),var(--c4));filter:blur(30px);opacity:.6}
  </style>
</head>
<body>
  <header class="hdr">
    <div class="in"><h1 class="ttl">Mesajlar</h1></div>
  </header>

  <main class="wrap">
    <section class="chat">
      <!-- SOL: Sohbet listesi -->
      <aside class="card sidebar">
        <div class="side-head">Sohbetler</div>

        <!-- se√ßim ara√ß √ßubuƒüu -->
        <div class="side-tools">
          <label style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="ckAll" class="ck"/> T√ºm√ºn√º Se√ß
          </label>
          <div class="grow"></div>
          <span id="selCount" class="tmuted">0 se√ßili</span>
          <button id="btnDeleteSel" class="btn danger" disabled>Se√ßilenleri Sil</button>
        </div>

        <div id="threads" class="threads"><div class="tmuted">Y√ºkleniyor‚Ä¶</div></div>
      </aside>

      <!-- SAƒû: Panel -->
      <section class="card panel">
        <div class="panel-head">
          <img id="peerAvatar" alt="">
          <div>
            <div class="name" id="peerName">Sohbet se√ß</div>
            <div class="tmuted" id="peerEmail"></div>
          </div>
        </div>
        <div id="msgs" class="msgs"><div class="tmuted">Sol taraftan bir sohbet se√ßin.</div></div>
        <div class="input">
          <input id="msgInput" placeholder="Mesaj yaz‚Ä¶" autocomplete="off" />
          <button id="btnSend" class="btn">G√∂nder</button>
        </div>
      </section>
    </section>
  </main>

  <!-- Bildirim sesi -->
  <audio id="notifySound" preload="auto">
    <source src="/assets/sounds/notify.wav" type="audio/wav">
    <source src="/sounds/notify.wav" type="audio/wav">
    <source src="assets/sounds/notify.wav" type="audio/wav">
    <source src="sounds/notify.wav" type="audio/wav">
  </audio>

  <!-- Alt bar -->
  <nav class="fixedbar">
    <div class="in">
      <a href="/" id="navHome">üè†<span>Ana Sayfa</span></a>
      <a href="/messages.html" class="active" id="navMsgs">üí¨<span>Mesajlar</span></a>
      <a href="/notifications.html" id="navNotifs">üîî<span>Bildirimler</span></a>
      <a href="/profile/profile.html" id="navProfile">üë§<span>Profil</span></a>
    </div>
  </nav>

  <script type="module">
    /* ==== Firebase ==== */
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, query, where, onSnapshot, orderBy,
      doc, getDoc, setDoc, addDoc, serverTimestamp,
      updateDoc, arrayUnion                           // <-- ar≈üivleme i√ßin
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUUNSYxoWNUsK0C-C04qTUm6KM5756fvg",
      authDomain: "ureten-eller-v2.firebaseapp.com",
      projectId: "ureten-eller-v2",
      storageBucket: "ureten-eller-v2.firebasestorage.app",
      messagingSenderId: "621494781131",
      appId: "1:621494781131:web:13cc3b061a5e94b7cf874e"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ==== UI refs ==== */
    const elThreads  = document.getElementById('threads');
    const elMsgs     = document.getElementById('msgs');
    const elInput    = document.getElementById('msgInput');
    const btnSend    = document.getElementById('btnSend');
    const peerAvatar = document.getElementById('peerAvatar');
    const peerName   = document.getElementById('peerName');
    const peerEmail  = document.getElementById('peerEmail');
    const notifyEl   = document.getElementById('notifySound');

    // toplu se√ßim ara√ßlarƒ±
    const ckAll      = document.getElementById('ckAll');
    const selCountEl = document.getElementById('selCount');
    const btnDelSel  = document.getElementById('btnDeleteSel');

    /* ==== Helpers ==== */
    const $el = (html)=>{ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild; };
    const fmt = (ts)=>{ try{ const d=ts?.toDate?ts.toDate(): (ts instanceof Date? ts: new Date(ts)); if(isNaN(d)) return "‚Äî";
      return d.toLocaleString('tr-TR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});}catch{return "‚Äî";} };

    // Ses kilidi (autoplay)
    let audioUnlocked=false;
    async function tryUnlockAudio(){
      if(audioUnlocked) return;
      try{ await notifyEl.play(); notifyEl.pause(); notifyEl.currentTime=0; audioUnlocked=true; }catch{}
    }
    ['click','keydown','touchstart'].forEach(e=>document.addEventListener(e,tryUnlockAudio,{passive:true}));
    notifyEl.addEventListener('error',()=>console.warn('notify.wav bulunamadƒ± (kaynak yollarƒ±nƒ± kontrol et).'));

    // K√º√ß√ºk profil √∂nbelleƒüi
    const userCache=new Map();
    async function getUserBrief(uid){
      if(userCache.has(uid)) return userCache.get(uid);
      const paths=[['profiles_public',uid],['users_public',uid],['users',uid],['profiles',uid]];
      let data={name:'Kullanƒ±cƒ±',email:'',photo:''};
      for(const [col,id] of paths){
        try{
          const s=await getDoc(doc(db,col,id));
          if(s.exists()){
            const p=s.data()||{};
            data={
              name:(p.firstName&&p.lastName)?(p.firstName+' '+p.lastName):(p.displayName||p.username||'Kullanƒ±cƒ±'),
              email:p.email||'',
              photo:p.photoURL||p.photo||''
            };
            break;
          }
        }catch{}
      }
      userCache.set(uid,data);
      return data;
    }

    /* ==== URL param ==== */
    const params=new URLSearchParams(location.search);
    let initialChatId=params.get('chat')||params.get('chatId')||'';
    const peerParam=params.get('peer')||'';

    /* ==== State ==== */
    let me=null, activeChatId='', activePeerUid='', unsubMsgs=null, unsubThreads=null;

    async function ensureDmChat(myUid,peerUid){
      const pair=[myUid,peerUid].sort();
      const chatId=`dm_${pair[0]}_${pair[1]}`;
      const ref=doc(db,'chats',chatId);
      const snap=await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref,{participants:pair,type:'dm',createdAt:serverTimestamp(),lastMsgAt:serverTimestamp()},{merge:true});
      }
      return chatId;
    }

    /* ==== Se√ßim durumu ==== */
    function selectedIds(){
      return Array.from(elThreads.querySelectorAll('input.ck.thread-ck:checked')).map(x=>x.dataset.id);
    }
    function refreshSelectionUI(){
      const allCks = elThreads.querySelectorAll('input.ck.thread-ck');
      const sel    = selectedIds();
      selCountEl.textContent = `${sel.length} se√ßili`;
      btnDelSel.disabled = sel.length === 0;
      ckAll.checked = sel.length > 0 && sel.length === allCks.length;
    }
    ckAll.addEventListener('change', ()=>{
      const all = !!ckAll.checked;
      elThreads.querySelectorAll('input.ck.thread-ck').forEach(ck=>{ ck.checked = all; });
      refreshSelectionUI();
    });
    btnDelSel.addEventListener('click', async ()=>{
      const ids = selectedIds();
      if(ids.length===0) return;
      if(!confirm(`${ids.length} sohbet ar≈üivlensin mi? (Sadece sizde gizlenir)`)) return;
      for(const id of ids){
        try{ await updateDoc(doc(db,'chats',id), { hiddenFor: arrayUnion(me.uid) }); }
        catch(e){ console.warn('Ar≈üivlenemedi:', id, e); }
      }
    });

    /* ==== Sohbet listesi ==== */
    function watchThreads(){
      if(unsubThreads) unsubThreads();
      elThreads.innerHTML='<div class="tmuted">Y√ºkleniyor‚Ä¶</div>';

      const qy=query(collection(db,'chats'), where('participants','array-contains',me.uid));
      unsubThreads=onSnapshot(qy, async (snap)=>{
        if(snap.empty){ elThreads.innerHTML='<div class="tmuted">Sohbet yok.</div>'; refreshSelectionUI(); return; }

        let rows=snap.docs.map(d=>({id:d.id,...d.data()})).filter(d=>(d.type||'dm')==='dm');
        // Gizlenenleri √ßƒ±kar
        rows = rows.filter(d => !((d.hiddenFor||[]).includes(me.uid)));
        // Tarihe g√∂re sƒ±rala
        rows.sort((a,b)=> (b.lastMsgAt?.toMillis?.()||0)-(a.lastMsgAt?.toMillis?.()||0));

        elThreads.innerHTML='';
        for(const d of rows){
          const peerUid=(d.participants||[]).find(x=>x!==me.uid)||'';
          const info=peerUid?await getUserBrief(peerUid):{name:'‚Äî',email:'',photo:''};
          const profUrl=`/profile/profile.html?uid=${encodeURIComponent(peerUid)}`;
          const row=$el(`
            <div class="thread ${d.id===activeChatId?'active':''}" data-id="${d.id}" data-peer="${peerUid}">
              <input type="checkbox" class="ck thread-ck" data-id="${d.id}" title="Se√ß"/>
              <img class="avatar" src="${info.photo||'/assets/img/seffaf.png'}" alt="">
              <div>
                <div class="tname"><a href="${profUrl}" data-prof="${peerUid}">${info.name||'Kullanƒ±cƒ±'}</a></div>
                <div class="tmuted">${(d.lastMsg||'').slice(0,50)}</div>
              </div>
              <div class="tmuted">${d.lastMsgAt?new Date(d.lastMsgAt.toMillis()).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}):''}</div>
              <button class="delOne" data-id="${d.id}" title="Sohbeti ar≈üivle">‚úï</button>
            </div>
          `);

          // Satƒ±r tƒ±klanƒ±nca sohbeti a√ß (profil linki/checkbox/sil‚Äôe tƒ±klanƒ±rsa a√ßma)
          row.addEventListener('click',(e)=>{
            if (e.target.closest('a[data-prof]')) { e.stopPropagation(); return; }
            if (e.target.closest('input.thread-ck')) { e.stopPropagation(); return; }
            if (e.target.closest('.delOne'))        { e.stopPropagation(); return; }
            openChat(d.id,peerUid);
          });

          // Checkbox deƒüi≈üince saya√ß g√ºncelle
          row.querySelector('input.thread-ck').addEventListener('change', refreshSelectionUI);

          // Tekli ar≈üiv
          row.querySelector('.delOne').addEventListener('click', async ()=>{
            if(!confirm('Bu sohbet ar≈üivlensin mi? (Sadece sizde gizlenir)')) return;
            try{ await updateDoc(doc(db,'chats',d.id), { hiddenFor: arrayUnion(me.uid) }); }
            catch(e){ alert('Ar≈üivlenemedi: ' + (e.code||e.message||'hata')); }
          });

          elThreads.appendChild(row);
        }
        refreshSelectionUI();

        // ƒ∞lk se√ßim
        if(!activeChatId && rows.length){
          if(initialChatId){
            const ex=rows.find(x=>x.id===initialChatId);
            if(ex){ const peer=ex.participants.find(x=>x!==me.uid)||''; openChat(initialChatId,peer); }
            initialChatId='';
          }else{
            const d0=rows[0]; const peer0=d0.participants.find(x=>x!==me.uid)||''; openChat(d0.id,peer0);
          }
        }
        if(rows.length===0){ elMsgs.innerHTML='<div class="tmuted">Sohbet yok.</div>'; }
      });
    }

    /* ==== Mesajlar (isim + avatar ile) ==== */
    async function watchMessages(chatId){
      if(unsubMsgs){unsubMsgs();unsubMsgs=null;}
      elMsgs.innerHTML='<div class="tmuted">Y√ºkleniyor‚Ä¶</div>';

      // Me & Peer bilgilerini √∂nceden al
      let meInfo = await getUserBrief(me.uid);
      let peerInfo = null;
      if(activePeerUid) peerInfo = await getUserBrief(activePeerUid);

      let firstLoad=true;
      const qy=query(collection(db,'chats',chatId,'messages'), orderBy('createdAt','asc'));
      unsubMsgs=onSnapshot(qy, async (snap)=>{
        if(snap.empty){
          elMsgs.innerHTML='<div class="tmuted">Hen√ºz mesaj yok. ƒ∞lk mesajƒ± sen g√∂nder.</div>';
          firstLoad=false;
          return;
        }
        elMsgs.innerHTML='';

        for (const d of snap.docs){
          const m=d.data()||{};
          const mine = m.senderUid===me.uid;
          // G√∂nderen bilgisi (cache kullanƒ±yor)
          let info = mine ? meInfo : (peerInfo || await getUserBrief(m.senderUid));

          const row = $el(`
            <div class="msg-row ${mine?'me':''}">
              <img class="msg-avatar" src="${info.photo||'/assets/img/seffaf.png'}" alt="">
              <div class="msg-wrap">
                <div class="msg-name">${info.name||'Kullanƒ±cƒ±'} <span class="time">${fmt(m.createdAt)}</span></div>
                <div class="msg ${mine?'me':''}"><div class="text"></div></div>
              </div>
            </div>
          `);
          row.querySelector('.text').textContent = m.text || '';
          elMsgs.appendChild(row);
        }

        elMsgs.scrollTop=elMsgs.scrollHeight;

        // Yeni gelen kar≈üƒ± mesaj i√ßin ses
        if(!firstLoad){
          const hasIncoming=snap.docChanges().some(ch=>ch.type==='added' && ch.doc.data()?.senderUid!==me.uid);
          if(hasIncoming) playNotify();
        }
        firstLoad=false;
      });
    }

    async function playNotify(){
      try{ await notifyEl.play(); }
      catch{
        const retry=async()=>{ try{ await notifyEl.play(); document.removeEventListener('click',retry); document.removeEventListener('keydown',retry);}catch{} };
        document.addEventListener('click',retry,{once:true});
        document.addEventListener('keydown',retry,{once:true});
      }
    }

    /* ==== Sohbet a√ß ==== */
    async function openChat(chatId,peerUid){
      activeChatId=chatId; activePeerUid=peerUid||'';
      document.querySelectorAll('.thread').forEach(t=>t.classList.toggle('active',t.dataset.id===chatId));

      if(activePeerUid){
        const info=await getUserBrief(activePeerUid);
        const profUrl=`/profile/profile.html?uid=${encodeURIComponent(activePeerUid)}`;
        peerName.innerHTML=`<a href="${profUrl}" id="peerNameLink">${info.name||'Sohbet'}</a>`;
        peerEmail.textContent=info.email||'';
        if(info.photo) peerAvatar.src=info.photo; else peerAvatar.removeAttribute('src');
      }else{
        peerName.textContent='Sohbet'; peerEmail.textContent=''; peerAvatar.removeAttribute('src');
      }

      watchMessages(chatId);
      history.replaceState(null,'',`/messages.html?chatId=${encodeURIComponent(chatId)}`);
    }

    /* ==== G√∂nder ==== */
    async function sendMessage(){
      const text=(elInput.value||'').trim();
      if(!text||!activeChatId) return;

      await addDoc(collection(db,'chats',activeChatId,'messages'),{
        text, senderUid:me.uid, createdAt:serverTimestamp()
      });
      await setDoc(doc(db,'chats',activeChatId),{
        lastMsg:text, lastMsgAt:serverTimestamp(), lastSenderUid: me.uid
      },{merge:true});

      elInput.value='';
    }
    btnSend.addEventListener('click',sendMessage);
    elInput.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendMessage(); }});

    /* ==== Auth ==== */
    onAuthStateChanged(auth, async (user)=> {
      if (!user) {
        location.href="/auth.html?next=/messages.html";
        return;
      }

      // Public profilini garantiye al (firebase-init.js i√ßinde tanƒ±mlƒ±ysa)
      try { await window.__fb?.upsertPublicProfile?.(user); } catch {}

      me = user;
      tryUnlockAudio();

      // ?peer= ile geldiyse DM olu≈ütur/a√ß
      if (peerParam) {
        try {
          const chatId = await ensureDmChat(me.uid, peerParam);
          initialChatId = chatId;
        } catch (e) { console.error('DM a√ßƒ±lamadƒ±', e); }
      }

      watchThreads();
    });

    /* ==== Alt bar aktifliƒüi ==== */
    const path=location.pathname;
    document.querySelectorAll('.fixedbar a').forEach(a=>{
      a.classList.toggle('active', a.getAttribute('href')===path || (path.startsWith('/messages') && a.id==='navMsgs'));
    });
  </script>
</body>
</html>
