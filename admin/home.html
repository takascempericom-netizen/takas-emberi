<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Panel â€¢ Takas Ã‡emberi</title>
  <style>
    :root{ --bg:#0b0b0b; --panel:#121212; --muted:#9ca3af; --line:#1f2937; --blue:#3b82f6; --green:#10b981; --red:#ef4444; --amber:#f59e0b; --fg:#f9fafb; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit}
    header{display:flex;align-items:center;gap:14px;padding:10px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,.2));backdrop-filter:saturate(140%) blur(4px);z-index:10}
    header .flag{width:64px;height:40px;position:relative;overflow:hidden;border-radius:6px;box-shadow:0 4px 16px rgba(0,0,0,.6)}
    .flag::before{content:"";position:absolute;inset:0;background:#e10600}
    .flag::after{content:"";position:absolute;left:18px;top:7px;width:20px;height:20px;border-radius:50%;box-shadow:-8px 0 0 5px #fff inset,-8px 0 0 5px #fff;background:#e10600}
    .star{position:absolute;left:40px;top:12px;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:12px solid #fff;transform:rotate(35deg)}
    .star:before,.star:after{content:"";position:absolute;left:-6px;top:8px;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:12px solid #fff}
    .star:before{transform:rotate(-70deg)} .star:after{top:4px;transform:rotate(70deg)}
    .flag{transform-origin:left center;animation:wave 2.4s ease-in-out infinite}
    @keyframes wave{0%{transform:skewY(0deg)}50%{transform:skewY(3deg)}100%{transform:skewY(0deg)}}
    header img.logo{height:34px;filter:drop-shadow(0 2px 8px rgba(0,0,0,.6))}
    header .sp{flex:1} header .user{font-size:13px;color:var(--muted)}
    header .btn{border:1px solid var(--line);padding:8px 10px;border-radius:10px;background:#181818;cursor:pointer}
    .layout{display:grid;grid-template-columns:260px 1fr;gap:0;min-height:calc(100vh - 62px)}
    aside{border-right:1px solid var(--line);background:#0f0f0f}
    .brand{padding:14px;border-bottom:1px solid var(--line);font-weight:700;font-size:13px;color:#d1d5db}
    .menu{list-style:none;margin:0;padding:8px} .menu li{margin:4px 0}
    .menu a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:#d1d5db;text-decoration:none;border:1px solid transparent}
    .menu a.active,.menu a:hover{background:#141414;border-color:#1f2937}
    main{padding:18px}
    .cards{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;min-width:200px;box-shadow:0 6px 18px rgba(0,0,0,.3)}
    .card h3{margin:0 0 6px;font-size:13px;color:var(--muted);font-weight:600} .card p{margin:0;font-size:22px;font-weight:800}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 6px 18px rgba(0,0,0,.3)}
    .panel h2{margin:0 0 10px;font-size:16px} .muted{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--line);font-size:14px}
    th{color:#cbd5e1;text-align:left;background:#121212} tr:hover td{background:#111213}
    .btn{padding:7px 10px;border-radius:8px;border:1px solid #1f2937;background:#161616;color:#e5e7eb;cursor:pointer}
    .btn.ok{background:var(--green);border-color:#065f46} .btn.no{background:var(--red);border-color:#7f1d1d}
    .btn.info{background:var(--blue);border-color:#1e3a8a} .btn.warn{background:var(--amber);border-color:#7c4a03}
    #modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
    #modal .inner{background:#0f0f0f;border:1px solid var(--line);border-radius:14px;max-width:720px;width:96%;max-height:85vh;overflow:auto;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.6)}
    #modal h3{margin:0 0 8px} .images img{max-width:100%;border-radius:10px;margin:6px 0;border:1px solid var(--line)}
    .hdr-right{display:flex;align-items:center;gap:10px} .notif-dot{display:inline-block;width:8px;height:8px;background:#ef4444;border-radius:50%;box-shadow:0 0 0 3px rgba(239,68,68,.25)}
  </style>
</head>
<body>
  <header>
    <div class="flag"><span class="star"></span></div>
    <img class="logo" src="/assets/img/seffaf.png" alt="logo">
    <div class="sp"></div>
    <div class="hdr-right">
      <span class="user" id="hdrUser">â€”</span>
      <button class="btn" id="logoutBtn">Ã‡Ä±kÄ±ÅŸ</button>
    </div>
  </header>

  <div class="layout">
    <aside>
      <div class="brand">YÃ¶netim MenÃ¼sÃ¼</div>
      <ul class="menu" id="menu">
        <li><a href="#messages" data-section="messages" class="active">ğŸ“¨ KullanÄ±cÄ± MesajlarÄ± <span id="msgDot" class="notif-dot" style="display:none"></span></a></li>
        <li><a href="#complaints" data-section="complaints">ğŸš© Åikayetler</a></li>
        <li><a href="#pending" data-section="pending">â³ Onay Bekleyen Ä°lanlar</a></li>
        <li><a href="#broadcast" data-section="broadcast">ğŸ“£ Bildirim GÃ¶nder</a></li>
        <li><a href="#users" data-section="users">ğŸ‘¥ KullanÄ±cÄ±lar</a></li>
      </ul>
    </aside>

    <main>
      <div class="cards" id="statsRow">
        <div class="card"><h3>YayÄ±nda Olan</h3><p id="countPublished">0</p></div>
        <div class="card"><h3>Onay Bekleyen</h3><p id="countPending">0</p></div>
        <div class="card"><h3>SÃ¼resi Dolan</h3><p id="countExpired">0</p></div>
      </div>

      <section id="sec-messages" class="section active">
        <div class="panel">
          <h2>ğŸ“¨ KullanÄ±cÄ±larÄ±n Adminâ€™e GÃ¶nderdiÄŸi Mesajlar</h2>
          <div class="muted">Koleksiyon: <code>adminMessages</code></div>
          <table id="tblMessages"><thead><tr><th>GÃ¶nderen</th><th>Mesaj</th><th>Tarih</th><th>Ä°ÅŸlem</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <section id="sec-complaints" class="section">
        <div class="panel">
          <h2>ğŸš© Åikayetler</h2>
          <div class="muted">Koleksiyon: <code>complaints</code></div>
          <table id="tblComplaints"><thead><tr><th>Raporlayan</th><th>Hedef</th><th>Ä°Ã§erik</th><th>Tarih</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <section id="sec-pending" class="section">
        <div class="panel">
          <h2>â³ Onay Bekleyen Ä°lanlar</h2>
        <table id="pendingTable"><thead><tr><th>BaÅŸlÄ±k</th><th>Sahip</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <section id="sec-broadcast" class="section">
        <div class="panel">
          <h2>ğŸ“£ TÃ¼m KullanÄ±cÄ±lara Bildirim</h2>
          <div class="muted">Koleksiyon: <code>notifications</code></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <input id="notifTitle" placeholder="BaÅŸlÄ±k" style="flex:1;min-width:220px;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0e0e0e;color:#e5e7eb">
            <input id="notifMsg" placeholder="Mesaj" style="flex:2;min-width:260px;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0e0e0e;color:#e5e7eb">
            <button id="btnBroadcast" class="btn info">GÃ¶nder</button>
          </div>
        </div>
      </section>

      <section id="sec-users" class="section">
        <div class="panel">
          <h2>ğŸ‘¥ KullanÄ±cÄ±lar</h2>
          <div class="muted">Kaynak: <code>users</code></div>
          <div style="display:flex;gap:8px;margin:8px 0 12px">
            <input id="userSearch" placeholder="KullanÄ±cÄ± araâ€¦" style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0e0e0e;color:#e5e7eb">
            <button id="btnClearSearch" class="btn">Temizle</button>
          </div>
          <table id="tblUsers"><thead><tr><th>Ad</th><th>E-posta</th><th>Rol</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead><tbody></tbody></table>
        </div>
      </section>
    </main>
  </div>

  <!-- Ses -->
  <audio id="notifySound" src="/assets/sounds/notify.wav" preload="auto"></audio>

  <!-- Modal -->
  <div id="modal"><div class="inner" id="modalInner"></div></div>

  <script type="module">
    import { app } from "../js/firebase-config.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, updateDoc, addDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const auth = getAuth(app);
    const db   = getFirestore(app);
    const sound = document.getElementById("notifySound");

    // Sol menÃ¼
    const map = {
      messages: document.getElementById('sec-messages'),
      complaints: document.getElementById('sec-complaints'),
      pending: document.getElementById('sec-pending'),
      broadcast: document.getElementById('sec-broadcast'),
      users: document.getElementById('sec-users'),
    };
    document.getElementById('menu').addEventListener('click',(e)=>{
      const a=e.target.closest('a[data-section]'); if(!a) return; e.preventDefault();
      [...document.querySelectorAll('.menu a')].forEach(x=>x.classList.remove('active'));
      a.classList.add('active'); const key=a.dataset.section;
      Object.values(map).forEach(sec=>sec.classList.remove('active')); map[key].classList.add('active');
    });

    // Ã‡Ä±kÄ±ÅŸ
    document.getElementById('logoutBtn').onclick=()=>signOut(auth);

    // Ä°lk yÃ¼kleme sÄ±rasÄ±nda ses Ã§almasÄ±n
    let init = {pending:true, messages:true, complaints:true};

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="/admin/login.html"; return; }
      document.getElementById('hdrUser').textContent = user.email || user.uid;

      const uref = doc(db,'users',user.uid);
      const us   = await getDoc(uref);
      const role = us.exists()? (us.data().role||'user') : 'user';
      if(role!=='admin'){ alert('Admin yetkisi yok'); await signOut(auth); return; }

      // SayaÃ§lar + dinleyiciler
      onSnapshot(query(collection(db,'listings'), where('status','==','published')),(s)=>{ qs('#countPublished').textContent=s.size; });
      onSnapshot(query(collection(db,'listings'), where('status','==','pending')),(s)=>{ qs('#countPending').textContent=s.size; renderPending(s); if(!init.pending) play(); init.pending=false; });
      onSnapshot(query(collection(db,'listings'), where('status','==','expired')),(s)=>{ qs('#countExpired').textContent=s.size; });

      onSnapshot(query(collection(db,'adminMessages'), orderBy('createdAt','desc'), limit(200)),(s)=>{ renderMessages(s); if(!init.messages) play(); init.messages=false; });
      onSnapshot(query(collection(db,'complaints'), orderBy('createdAt','desc'), limit(200)),(s)=>{ renderComplaints(s); if(!init.complaints) play(); init.complaints=false; });
    });

    // ==== RENDER FONKSÄ°YONLARI (EKSÄ°K OLANLAR) ====
    function renderPending(snapshot){
      const tb = qs('#pendingTable tbody'); tb.innerHTML='';
      snapshot.forEach(docSnap=>{
        const v=docSnap.data();
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(v.title||'-')}</td>
          <td>${esc(v.ownerId||'-')}</td>
          <td>${esc(v.status||'-')}</td>
          <td>
            <button class="btn info" onclick="viewListing('${docSnap.id}')">Detay</button>
            <button class="btn ok"   onclick="approveListing('${docSnap.id}')">Onayla</button>
            <button class="btn no"   onclick="rejectListing('${docSnap.id}')">Reddet</button>
          </td>`;
        tb.appendChild(tr);
      });
    }

    function renderMessages(snapshot){
      const tb = qs('#tblMessages tbody'); tb.innerHTML='';
      qs('#msgDot').style.display = snapshot.size ? 'inline-block' : 'none';
      snapshot.forEach(d=>{
        const v=d.data();
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(v.fromUid||'-')}</td>
          <td>${esc(v.text||'')}</td>
          <td>${fmt(v.createdAt)}</td>
          <td><button class="btn info" onclick="viewUser('${v.fromUid||''}')">Profili AÃ§</button></td>`;
        tb.appendChild(tr);
      });
    }

    function renderComplaints(snapshot){
      const tb = qs('#tblComplaints tbody'); tb.innerHTML='';
      snapshot.forEach(d=>{
        const v=d.data();
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(v.reporterUid||'-')}</td>
          <td>${esc(v.targetUid||v.listingId||'-')}</td>
          <td>${esc(v.text||'')}</td>
          <td>${fmt(v.createdAt)}</td>
          <td>${esc(v.status||'open')}</td>
          <td>
            <button class="btn info" onclick="viewUser('${v.reporterUid||''}')">Raporlayan</button>
            ${v.targetUid? `<button class="btn warn" onclick="banUser('${v.targetUid}')">Engelle</button>`:''}
          </td>`;
        tb.appendChild(tr);
      });
    }
    // ==== /RENDER FONKSÄ°YONLARI ====

    // Broadcast
    qs('#btnBroadcast').onclick = async ()=>{
      const title = qs('#notifTitle').value.trim();
      const msg   = qs('#notifMsg').value.trim();
      if(!title || !msg){ alert('BaÅŸlÄ±k ve mesaj zorunlu.'); return; }
      await addDoc(collection(db,'notifications'),{ title, message: msg, createdAt: serverTimestamp() });
      qs('#notifTitle').value=''; qs('#notifMsg').value='';
      alert('Bildirim kaydedildi.');
    };

    // KullanÄ±cÄ± listesi (canlÄ± + arama)
    let allUsers = [];
    onSnapshot(collection(db,'users'),(s)=>{ allUsers = s.docs.map(d=>({id:d.id, ...d.data()})); renderUsers(); });
    qs('#btnClearSearch').onclick=()=>{ qs('#userSearch').value=''; renderUsers(); }
    qs('#userSearch').addEventListener('input', renderUsers);
    function renderUsers(){
      const q = (qs('#userSearch').value||'').toLowerCase();
      const tb = qs('#tblUsers tbody'); tb.innerHTML='';
      allUsers.filter(u=>{
        const hay=(u.displayName||'')+' '+(u.email||'')+' '+(u.username||'');
        return hay.toLowerCase().includes(q);
      }).forEach(u=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(u.displayName||u.username||u.id)}</td>
          <td>${esc(u.email||'-')}</td>
          <td>${esc(u.role||'user')}</td>
          <td>${esc(u.status||'active')}</td>
          <td>
            <button class="btn info" onclick="viewUser('${u.id}')">Ä°ncele</button>
            <button class="btn no"   onclick="banUser('${u.id}')">Engelle</button>
          </td>`;
        tb.appendChild(tr);
      });
    }

    // Modal & aksiyonlar
    window.viewUser = async (uid)=>{
      if(!uid) return; const s=await getDoc(doc(db,'users',uid)); if(!s.exists()) return alert('KullanÄ±cÄ± bulunamadÄ±');
      const u=s.data();
      showModal(`
        <h3>KullanÄ±cÄ± Profili</h3>
        <div class="muted">${uid}</div>
        <p><b>Ad:</b> ${esc(u.displayName||u.username||'-')}</p>
        <p><b>E-posta:</b> ${esc(u.email||'-')}</p>
        <p><b>Rol:</b> ${esc(u.role||'user')}</p>
        <p><b>Durum:</b> ${esc(u.status||'active')}</p>
        ${u.photoURL? '<div class="images"><img src="'+esc(u.photoURL)+'" alt="avatar"></div>':''}
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn warn" onclick="banUser('${uid}')">Engelle</button>
          <button class="btn" onclick="closeModal()">Kapat</button>
        </div>
      `);
    };
    window.banUser = async (uid)=>{ if(!confirm('Bu kullanÄ±cÄ±yÄ± engellemek istiyor musunuz?')) return; await updateDoc(doc(db,'users',uid),{status:'banned'}); alert('KullanÄ±cÄ± engellendi.'); };
    window.viewListing = async (id)=>{
      const s= await getDoc(doc(db,'listings',id)); if(!s.exists()) return alert('Ä°lan bulunamadÄ±');
      const d = s.data();
      showModal(`
        <h3>${esc(d.title||'-')}</h3>
        <div class="muted">Sahip: ${esc(d.ownerId||'-')} â€¢ Durum: ${esc(d.status||'-')}</div>
        <p>${esc(d.description||'')}</p>
        <div class="images">${(d.images||[]).map(u=>'<img src="'+esc(u)+'">').join('')}</div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn ok" onclick="approveListing('${id}')">Onayla</button>
          <button class="btn no" onclick="rejectListing('${id}')">Reddet</button>
          <button class="btn" onclick="closeModal()">Kapat</button>
        </div>
      `);
    };
    window.approveListing = async (id)=>{ await updateDoc(doc(db,'listings',id),{status:'published',publishedAt:serverTimestamp()}); closeModal(); alert('Ä°lan yayÄ±na alÄ±ndÄ±.'); };
    window.rejectListing  = async (id)=>{ await updateDoc(doc(db,'listings',id),{status:'rejected',rejectedAt:serverTimestamp()});  closeModal(); alert('Ä°lan reddedildi.');  };

    // YardÄ±mcÄ±lar
    function qs(s){ return document.querySelector(s); }
    function esc(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function fmt(ts){ if(!ts) return '-'; try{ const d=ts.toDate(); return d.toLocaleString('tr-TR'); }catch{ return '-'; } }
    function showModal(html){ qs('#modalInner').innerHTML=html; qs('#modal').style.display='flex'; }
    window.closeModal = ()=>{ qs('#modal').style.display='none'; };

    function play(){ try{ sound.currentTime=0; sound.play(); }catch(e){ /* sessiz */ } }
  </script>
</body>
</html>
