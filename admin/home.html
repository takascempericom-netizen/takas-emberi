<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Panel • Takas Çemberi</title>
  <!-- buraya kadar CSS aynı -->
  <style>
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b0b0b;color:#f9fafb}
    /* ... önceki CSS kodların burada ... */
  </style>
</head>
<body>
  <!-- header + sidebar kodların burada kalıyor -->

  <!-- Ses dosyası preload -->
  <audio id="notifySound" src="/assets/sounds/notify.wav" preload="auto"></audio>

  <!-- sayfanın geri kalanı burada kalıyor -->

  <script type="module">
    import { app } from "../js/firebase-config.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, query, where, onSnapshot, doc, getDoc, updateDoc, addDoc, serverTimestamp, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const auth = getAuth(app);
    const db   = getFirestore(app);
    const sound = document.getElementById("notifySound");

    // Son snapshot sayacı -> yenisi gelirse ses çal
    let lastCounts = { pending:0, messages:0, complaints:0 };

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href="/admin/login.html"; return; }
      const roleSnap = await getDoc(doc(db,"users",user.uid));
      if(!roleSnap.exists() || roleSnap.data().role!=="admin"){ await signOut(auth); return; }

      // Pending ilanlar
      onSnapshot(query(collection(db,"listings"), where("status","==","pending")),(s)=>{
        if(s.size>lastCounts.pending){ playNotify(); }
        lastCounts.pending = s.size;
        renderPending(s);
      });

      // Admin mesajları
      onSnapshot(query(collection(db,"adminMessages"), orderBy("createdAt","desc"), limit(200)),(s)=>{
        if(s.size>lastCounts.messages){ playNotify(); }
        lastCounts.messages = s.size;
        renderMessages(s);
      });

      // Şikayetler
      onSnapshot(query(collection(db,"complaints"), orderBy("createdAt","desc"), limit(200)),(s)=>{
        if(s.size>lastCounts.complaints){ playNotify(); }
        lastCounts.complaints = s.size;
        renderComplaints(s);
      });
    });

    function playNotify(){
      try{ sound.currentTime=0; sound.play(); }catch(e){ console.warn("Ses çalınamadı:",e); }
    }

    // --- render fonksiyonların buraya kalacak (renderPending, renderMessages, renderComplaints) ---
  </script>
</body>
</html>
