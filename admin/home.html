<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Takas Ã‡emberi â€¢ Admin Panel</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1324; --card:#0f1a33; --ring:#1f2a44; --muted:#9aa4bf; --text:#e8ecf8;
  --pri:#3b82f6; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
.app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
.aside{background:linear-gradient(180deg,#0e1831,#0b1324);border-right:1px solid var(--ring);padding:14px;position:sticky;top:0;height:100vh}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}
.brand img{height:34px}
.nav{display:grid;gap:6px;margin-top:14px}
.nav button{display:flex;gap:10px;align-items:center;border:1px solid transparent;background:transparent;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
.nav button:hover{background:#111a33}
.nav button.active{background:#132044;border-color:#1f2a44}
.top{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--ring);background:#0f1a33;position:sticky;top:0;z-index:10}
.top .right{display:flex;align-items:center;gap:10px}
.tag{padding:3px 8px;border:1px solid var(--ring);border-radius:999px;color:var(--muted);font-size:12px}
.main{padding:16px}
.card{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:14px}
.grid{display:grid;gap:14px}
.grid.cols-2{grid-template-columns:1fr 1fr}
.grid.cols-3{grid-template-columns:1fr 1fr 1fr}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--ring);padding:10px;text-align:left;vertical-align:top}
.table th{color:#c8d2ea;font-weight:700}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--ring);background:#111b36;color:#e8ecf8;cursor:pointer}
.btn.pri{background:linear-gradient(90deg,#2563eb,#3b82f6);border:0}
.btn.ok{background:linear-gradient(90deg,#059669,#10b981);border:0}
.btn.warn{background:linear-gradient(90deg,#f59e0b,#fbbf24);border:0;color:#0d0d0d}
.btn.err{background:linear-gradient(90deg,#ef4444,#f87171);border:0}
.input, select, textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--ring);background:#0b152f;color:#e8ecf8}
.kpi{display:grid;gap:6px;background:#0b152f;border:1px dashed #243252;border-radius:12px;padding:10px}
.kpi b{font-size:22px}
.status{font-size:13px;color:var(--muted);min-height:18px}
.hide{display:none}

/* Ticker */
.ticker-wrap{position:sticky;top:56px;z-index:9;background:#091025;border-bottom:1px solid var(--ring)}
.ticker{display:flex;gap:24px;white-space:nowrap;overflow:hidden;padding:10px 0}
.ticker .item{display:flex;gap:10px;align-items:center}
.ticker .run{display:inline-block;will-change:transform;animation:marq 25s linear infinite}
@keyframes marq{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}

/* Chat */
.chat{display:grid;grid-template-columns:300px 1fr;gap:12px}
.threadlist{background:#0b152f;border:1px solid var(--ring);border-radius:12px;overflow:auto;height:60vh}
.threadlist .row{padding:10px 12px;border-bottom:1px solid #132044;cursor:pointer}
.threadlist .row.active{background:#132044}
.msgview{display:grid;grid-template-rows:1fr auto;gap:10px;height:60vh}
.messages{overflow:auto;border:1px solid var(--ring);border-radius:12px;padding:10px 12px;background:#0b152f}
.bubble{max-width:70%;margin:6px 0;padding:8px 10px;border-radius:10px;background:#0e1a34;border:1px solid #223055}
.bubble.me{background:#1c2b52}
.msgft{display:flex;gap:8px}

@media (max-width:960px){
  .app{grid-template-columns:1fr}
  .aside{position:relative;height:auto}
  .grid.cols-2{grid-template-columns:1fr}
  .grid.cols-3{grid-template-columns:1fr}
  .chat{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div id="app" class="app">
  <aside class="aside">
    <div class="brand"><img src="/assets/img/seffaf.png" alt="logo"><span>Takas Ã‡emberi â€¢ Admin</span></div>
    <div class="nav" id="nav">
      <button data-pane="ilanlar" class="active">ğŸ“¦ Ä°lanlar</button>
      <button data-pane="bildirimler">ğŸ“£ Bildirim Panosu</button>
      <button data-pane="kullanicilar">ğŸ‘¥ KullanÄ±cÄ±lar</button>
      <button data-pane="uyari">âš ï¸ UyarÄ± Paneli</button>
      <button data-pane="sikayet">ğŸš© Åikayetler</button>
      <button data-pane="chat">ğŸ’¬ MesajlaÅŸma</button>
    </div>
  </aside>

  <section>
    <div class="top">
      <div style="display:flex;align-items:center;gap:10px">
        <span class="tag" id="who"></span>
        <span class="tag" id="env">Firebase</span>
      </div>
      <div class="right">
        <a href="index.html" class="btn">GiriÅŸ</a>
        <button id="btnSignOut" class="btn">Ã‡Ä±kÄ±ÅŸ</button>
      </div>
    </div>

    <!-- Ticker -->
    <div id="tickerWrap" class="ticker-wrap hide">
      <div class="ticker"><div class="run" id="tickerRun"></div></div>
    </div>

    <main class="main">
      <!-- Ä°LANLAR -->
      <div id="pane-ilanlar" class="grid">
        <div class="grid cols-2">
          <div class="card">
            <h3>Onay Bekleyen Ä°lanlar</h3>
            <table class="table" id="tblPending"><thead><tr>
              <th>Ä°lan</th><th>KullanÄ±cÄ±</th><th>Tarih</th><th style="width:210px">Ä°ÅŸlem</th>
            </tr></thead><tbody></tbody></table>
          </div>
          <div class="card">
            <h3>Aktif Ä°lanlar</h3>
            <table class="table" id="tblActive"><thead><tr>
              <th>Ä°lan</th><th>KullanÄ±cÄ±</th><th>YayÄ±n</th><th style="width:140px">Ä°ÅŸlem</th>
            </tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>

      <!-- BÄ°LDÄ°RÄ°MLER -->
      <div id="pane-bildirimler" class="grid hide">
        <div class="card">
          <h3>Toplu Bildirim GÃ¶nder</h3>
          <div class="grid cols-3">
            <label>BaÅŸlÄ±k<input id="nt_title" class="input" placeholder="Duyuru baÅŸlÄ±ÄŸÄ±"></label>
            <label>Emoji/Ä°kon<input id="nt_icon" class="input" placeholder="ğŸ””"></label>
            <label>Kapsam<select id="nt_scope" class="input"><option value="all">TÃ¼m kullanÄ±cÄ±lar</option><option value="active">Sadece aktif ilan sahipleri</option></select></label>
          </div>
          <label style="margin-top:8px">Mesaj<textarea id="nt_body" class="input" rows="3" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..."></textarea></label>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button id="btnSendNotif" class="btn pri">GÃ¶nder</button>
          </div>
          <div id="nt_status" class="status"></div>
        </div>
        <div class="card">
          <h3>Son Bildirimler</h3>
          <table class="table" id="tblNotifs"><thead><tr><th>Zaman</th><th>BaÅŸlÄ±k</th><th>Ä°Ã§erik</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <!-- KULLANICILAR -->
      <div id="pane-kullanicilar" class="grid hide">
        <div class="card">
          <h3>KullanÄ±cÄ± Ara</h3>
          <div class="grid cols-3">
            <label>KullanÄ±cÄ± AdÄ±<input id="srch_uname" class="input" placeholder="kullanici_adi"></label>
            <div style="align-self:end"><button id="btnSearchUser" class="btn">Ara</button></div>
          </div>
          <table class="table" id="tblUsers"><thead><tr><th>Ad</th><th>KullanÄ±cÄ± AdÄ±</th><th>E-posta</th><th>Durum</th><th style="width:160px">Ä°ÅŸlem</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="card hide" id="userPreview">
          <h3>Profil Ã–nizleme</h3>
          <div id="userCard"></div>
        </div>
      </div>

      <!-- UYARI PANELÄ° (TICKER) -->
      <div id="pane-uyari" class="grid hide">
        <div class="card">
          <h3>Ekran UyarÄ±sÄ± (Ticker)</h3>
          <div class="grid cols-3">
            <label>Ä°kon<input id="tk_icon" class="input" placeholder="âš ï¸"></label>
            <label>Renk<input id="tk_color" class="input" type="color" value="#f59e0b"></label>
            <label>HÄ±z (sn/tur)<input id="tk_speed" class="input" type="number" min="8" max="60" value="25"></label>
          </div>
          <label style="margin-top:8px">Mesaj<textarea id="tk_text" class="input" rows="2" placeholder="UyarÄ± metni..."></textarea></label>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button id="btnTickerOn" class="btn ok">YayÄ±nla</button>
            <button id="btnTickerOff" class="btn err">KaldÄ±r</button>
          </div>
          <div id="tk_status" class="status"></div>
        </div>
      </div>

      <!-- ÅÄ°KAYETLER -->
      <div id="pane-sikayet" class="grid hide">
        <div class="card">
          <h3>Åikayet Kutusu</h3>
          <table class="table" id="tblReports"><thead><tr><th>Zaman</th><th>Åikayet Eden</th><th>Hedef</th><th>Sebep</th><th>Detay</th><th>GÃ¶rsel</th><th style="width:110px">Ä°ÅŸlem</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <!-- MESAJLAÅMA -->
      <div id="pane-chat" class="grid hide">
        <div class="chat">
          <div class="threadlist" id="threadList"></div>
          <div class="msgview">
            <div class="messages" id="msgs"></div>
            <div class="msgft">
              <input id="msgInput" class="input" placeholder="YanÄ±t yaz..."/>
              <button id="btnSendMsg" class="btn pri">GÃ¶nder</button>
            </div>
          </div>
        </div>
        <div class="status" id="chat_status"></div>
      </div>

    </main>
  </section>
</div>

<!-- Sesler (opsiyonel; yoksa otomatik bip Ã¼retir) -->
<audio id="sndNotif"><source src="/assets/sounds/notify.mp3" type="audio/mpeg"></audio>
<audio id="sndMsg"><source src="/assets/sounds/message.mp3" type="audio/mpeg"></audio>

<script type="module">
  import { app, auth, db } from '../js/firebase-config.js';
  import { onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
  import { collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, serverTimestamp, query, where, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';

  // ===== Auth Guard =====
  const ALLOWED = new Set(['takascembericom@gmail.com']);
  (async()=>{ try{ await setPersistence(auth, browserLocalPersistence); }catch(_){ } })();
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.replace('index.html'); return; }
    if(!ALLOWED.has(user.email||'')){ await signOut(auth); location.replace('index.html'); return; }
    document.getElementById('who').textContent = user.email;
    boot();
  });
  document.getElementById('btnSignOut')?.addEventListener('click', async()=>{ try{ await signOut(auth);}catch(_){ } location.replace('index.html'); });

  // ===== Helpers =====
  const $ = (s,p=document)=>p.querySelector(s); const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
  const fmtTime = (ts)=> ts?.toDate ? ts.toDate().toLocaleString('tr-TR') : new Date(ts||Date.now()).toLocaleString('tr-TR');
  function tr(html){ const el=document.createElement('tr'); el.innerHTML=html; return el; }

  // Ses fallback
  const ctx = (window.AudioContext? new AudioContext(): null);
  function beep(freq=880, ms=140){ try{ if(!ctx) return; const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(ctx.destination); o.start(); g.gain.setValueAtTime(0.05, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + ms/1000); o.stop(ctx.currentTime + ms/1000);}catch(_){} }
  function play(id){ const a=document.getElementById(id); if(!a) return beep(); a.currentTime=0; a.play().catch(()=>beep()); }

  // ===== Nav switching =====
  document.getElementById('nav').addEventListener('click',(e)=>{
    const b=e.target.closest('button'); if(!b) return;
    $$('#nav button').forEach(x=>x.classList.remove('active')); b.classList.add('active');
    const pane = 'pane-'+b.dataset.pane; $$('.main > div').forEach(x=>x.classList.add('hide')); document.getElementById(pane).classList.remove('hide');
  });

  // ===== Boot listeners =====
  let unsubPending, unsubActive, unsubNotifs, unsubTicker, unsubReports, unsubThreads, msgsUnsub;
  async function boot(){
    // Ticker live
    unsubTicker = onSnapshot(doc(db,'settings','adminAlert'),(s)=>{
      const d=s.data(); const wrap=document.getElementById('tickerWrap'), run=document.getElementById('tickerRun');
      if(!d || d.enabled!==true){ wrap.classList.add('hide'); return; }
      wrap.classList.remove('hide');
      const icon=d.icon||'âš ï¸', text=d.text||'', color=d.color||'#f59e0b', speed=Math.max(8, Math.min(60, d.speed||25));
      run.style.animationDuration = speed+'s';
      run.innerHTML = `<span class="item" style="color:${color}">${icon} ${text}</span> â€¢ <span class="item" style="color:${color}">${icon} ${text}</span>`;
    });

    // Listings: pending
    unsubPending = onSnapshot(query(collection(db,'listings'), where('status','==','pending'), orderBy('createdAt','desc'), limit(50)),(snap)=>{
      const tb=document.querySelector('#tblPending tbody'); tb.innerHTML='';
      snap.forEach(docu=>{
        const d=docu.data();
        tb.appendChild(tr(`<td>${d.title||'(adsÄ±z)'}<div class="status">${(d.desc||'').slice(0,80)}</div></td>
          <td>${d.username||d.owner||''}</td>
          <td>${fmtTime(d.createdAt)}</td>
          <td>
            <button class="btn ok" data-approve="${docu.id}">Onayla</button>
            <button class="btn err" data-reject="${docu.id}">Reddet</button>
          </td>`));
      });
    });

    // Listings: active
    unsubActive = onSnapshot(query(collection(db,'listings'), where('status','==','active'), orderBy('publishedAt','desc'), limit(50)),(snap)=>{
      const tb=document.querySelector('#tblActive tbody'); tb.innerHTML='';
      snap.forEach(docu=>{
        const d=docu.data();
        tb.appendChild(tr(`<td>${d.title||'(adsÄ±z)'}</td>
          <td>${d.username||d.owner||''}</td>
          <td>${fmtTime(d.publishedAt)}</td>
          <td><button class="btn warn" data-unpub="${docu.id}">AskÄ±ya Al</button></td>`));
      });
    });

    // Approve/Reject/Unpublish handlers
    document.getElementById('pane-ilanlar').addEventListener('click', async(e)=>{
      const id=e.target?.dataset?.approve||e.target?.dataset?.reject||e.target?.dataset?.unpub; if(!id) return;
      const ref=doc(db,'listings',id);
      try{
        if(e.target?.dataset?.approve){ await updateDoc(ref,{status:'active', publishedAt:serverTimestamp(), reviewedAt:serverTimestamp()}); }
        else if(e.target?.dataset?.reject){ await updateDoc(ref,{status:'rejected', reviewedAt:serverTimestamp()}); }
        else if(e.target?.dataset?.unpub){ await updateDoc(ref,{status:'suspended', reviewedAt:serverTimestamp()}); }
      }catch(err){ alert('Hata: '+(err?.code||err?.message)); }
    });

    // Notifications
    unsubNotifs = onSnapshot(query(collection(db,'broadcasts'), orderBy('createdAt','desc'), limit(50)),(snap)=>{
      const tb=document.querySelector('#tblNotifs tbody'); tb.innerHTML='';
      snap.forEach(d=>{ const v=d.data(); tb.appendChild(tr(`<td>${fmtTime(v.createdAt)}</td><td>${v.icon||'ğŸ””'} ${v.title||''}</td><td>${(v.body||'').slice(0,140)}</td>`)); });
    });
    document.getElementById('btnSendNotif').addEventListener('click', async()=>{
      const title=document.getElementById('nt_title').value.trim(), body=document.getElementById('nt_body').value.trim(), icon=document.getElementById('nt_icon').value.trim()||'ğŸ””';
      const scope=document.getElementById('nt_scope').value;
      if(!title||!body){ return document.getElementById('nt_status').textContent='BaÅŸlÄ±k ve mesaj gerekli.' }
      try{
        await addDoc(collection(db,'broadcasts'), {title, body, icon, scope, createdAt:serverTimestamp()});
        document.getElementById('nt_status').textContent='GÃ¶nderildi.'; play('sndNotif');
        document.getElementById('nt_title').value=''; document.getElementById('nt_body').value='';
      }catch(err){ document.getElementById('nt_status').textContent='Hata: '+(err?.code||err?.message) }
    });

    // Users
    document.getElementById('btnSearchUser').addEventListener('click', async()=>{
      const uname=document.getElementById('srch_uname').value.trim(); const tb=document.querySelector('#tblUsers tbody'); tb.innerHTML='';
      if(!uname){ tb.appendChild(tr(`<td colspan="5">KullanÄ±cÄ± adÄ± giriniz.</td>`)); return; }
      const end = uname + '\\uf8ff';
      const qUsers = query(collection(db,'users'), where('username','>=',uname), where('username','<=',end), orderBy('username'), limit(50));
      const snap = await getDocs(qUsers);
      if(snap.empty){ tb.appendChild(tr(`<td colspan="5">SonuÃ§ yok.</td>`)); return; }
      snap.forEach(u=>{
        const d=u.data(); tb.appendChild(tr(`<td>${d.name||''}</td><td>${d.username||''}</td><td>${d.email||''}</td><td>${d.isActive===false?'Pasif':'Aktif'}</td><td>
          <button class="btn" data-preview="${u.id}">GÃ¶rÃ¼ntÃ¼le</button>
          <button class="btn warn" data-impersonate="${u.id}">Profil gibi gÃ¶r</button>
        </td>`));
      });
    });

    document.getElementById('pane-kullanicilar').addEventListener('click', async(e)=>{
      const uid=e.target?.dataset?.preview||e.target?.dataset?.impersonate; if(!uid) return;
      const s=await getDoc(doc(db,'users',uid)); const d=s.data()||{}; document.getElementById('userPreview').classList.remove('hide');
      document.getElementById('userCard').innerHTML = `<div class="grid cols-2"><div class="kpi"><span>Ad Soyad</span><b>${d.name||'-'}</b></div>
        <div class="kpi"><span>KullanÄ±cÄ± AdÄ±</span><b>@${d.username||'-'}</b></div>
        <div class="kpi"><span>Åehir</span><b>${d.city||'-'}</b></div>
        <div class="kpi"><span>Telefon</span><b>${d.phone||'-'}</b></div>
        <div class="kpi"><span>E-posta</span><b>${d.email||'-'}</b></div>
        <div class="kpi"><span>Durum</span><b>${d.isActive===false?'Pasif':'Aktif'}</b></div></div>`;
      if(e.target?.dataset?.impersonate){ alert('"Profil gibi gÃ¶r" dev modu: KullanÄ±cÄ± ekranÄ±nÄ± salt-okunur Ã¶nizleme.'); }
    });

    // Ticker controls
    document.getElementById('btnTickerOn').addEventListener('click', async()=>{
      const icon=document.getElementById('tk_icon').value.trim()||'âš ï¸'; const text=document.getElementById('tk_text').value.trim();
      const color=document.getElementById('tk_color').value||'#f59e0b'; const speed=Number(document.getElementById('tk_speed').value||25);
      if(!text){ document.getElementById('tk_status').textContent='Metin gerekli.'; return; }
      try{ await setDoc(doc(db,'settings','adminAlert'), { enabled:true, icon, text, color, speed, updatedAt:serverTimestamp() }); document.getElementById('tk_status').textContent='YayÄ±nlandÄ±.'; }
      catch(err){ document.getElementById('tk_status').textContent='Hata: '+(err?.code||err?.message); }
    });
    document.getElementById('btnTickerOff').addEventListener('click', async()=>{
      try{ await setDoc(doc(db,'settings','adminAlert'), { enabled:false, updatedAt:serverTimestamp() }, { merge:true }); document.getElementById('tk_status').textContent='KaldÄ±rÄ±ldÄ±.'; }
      catch(err){ document.getElementById('tk_status').textContent='Hata: '+(err?.code||err?.message); }
    });

    // Reports
    unsubReports = onSnapshot(query(collection(db,'reports'), orderBy('createdAt','desc'), limit(50)),(snap)=>{
      const tb=document.querySelector('#tblReports tbody'); tb.innerHTML='';
      snap.forEach(r=>{
        const d=r.data(); const img = d.imageUrl? `<img src="${d.imageUrl}" alt="ek" style="max-width:80px;max-height:60px;border-radius:6px">` : '-';
        tb.appendChild(tr(`<td>${fmtTime(d.createdAt)}</td><td>${d.fromUser||''}</td><td>${d.targetUser||d.targetListing||''}</td><td>${d.reason||''}</td><td>${(d.details||'').slice(0,120)}</td><td>${img}</td><td>
          <button class="btn err" data-action="ban" data-id="${r.id}">Ban</button>
        </td>`));
      });
    });
    document.getElementById('pane-sikayet').addEventListener('click', async(e)=>{
      const id=e.target?.dataset?.id; const act=e.target?.dataset?.action; if(!id||!act) return;
      if(act==='ban') alert('Ban akÄ±ÅŸÄ±: kullanÄ±cÄ±/ilan Ã¼zerinde iÅŸlem yapÄ±n (Ã¶rnek).');
    });

    // Support Chat (admin tarafÄ±)
    unsubThreads = onSnapshot(query(collection(db,'support_threads'), orderBy('updatedAt','desc'), limit(50)),(snap)=>{
      const list=document.getElementById('threadList'); list.innerHTML='';
      snap.forEach(t=>{
        const d=t.data(); const div=document.createElement('div'); div.className='row'; div.dataset.id=t.id; div.innerHTML=`<b>${d.username||d.userId}</b><div class="status">${(d.lastMsg||'').slice(0,40)}</div>`; list.appendChild(div);
      });
    });

    let activeThread=null; msgsUnsub=null;
    document.getElementById('threadList').addEventListener('click',(e)=>{
      const row=e.target.closest('.row'); if(!row) return; $$('#threadList .row').forEach(x=>x.classList.remove('active')); row.classList.add('active');
      activeThread=row.dataset.id; document.getElementById('msgs').innerHTML='';
      msgsUnsub?.();
      msgsUnsub = onSnapshot(query(collection(db,'support_threads',activeThread,'messages'), orderBy('createdAt','asc'), limit(200)),(snap)=>{
        const box=document.getElementById('msgs'); let isNew=false; snap.docChanges().forEach(ch=>{ if(ch.type==='added'){ isNew=true; const m=ch.doc.data(); const b=document.createElement('div'); b.className='bubble'+(m.from==='admin'?' me':''); b.textContent=m.text||''; box.appendChild(b); box.scrollTop=box.scrollHeight; } });
        if(isNew) play('sndMsg');
      });
    });
    document.getElementById('btnSendMsg').addEventListener('click', async()=>{
      if(!activeThread){ document.getElementById('chat_status').textContent='KonuÅŸma seÃ§in.'; return; }
      const text=document.getElementById('msgInput').value.trim(); if(!text) return;
      await addDoc(collection(db,'support_threads',activeThread,'messages'), {text, from:'admin', createdAt:serverTimestamp()});
      await updateDoc(doc(db,'support_threads',activeThread), { lastMsg:text, updatedAt:serverTimestamp() });
      document.getElementById('msgInput').value='';
    });

    // Unload cleanup
    window.addEventListener('beforeunload',()=>{ [unsubPending,unsubActive,unsubNotifs,unsubTicker,unsubReports,unsubThreads,msgsUnsub].forEach(f=>{try{f&&f()}catch(_){}}); });
  }
</script>
</body>
</html>
