<!-- /ilan/index.html -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>İlan Detayı</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --line:#eee; --ink:#0f172a; --muted:#64748b;
      --paper:#fff; --paper2:#f8fafc; --brand:#111827;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#ffd6e7,#fff);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
    a,button{font:inherit}

    .wrap{max-width:960px;margin:16px auto;padding:0 16px}
    .top{display:flex;align-items:center;gap:10px;margin:8px 0 16px}
    .back{border:1px solid var(--line);background:var(--paper2);padding:8px 12px;border-radius:10px;text-decoration:none;color:var(--ink)}
    .h1{margin:0 0 6px;font-size:24px;font-weight:900}
    .meta{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 12px;color:var(--muted);font-size:14px}

    /* Kare kapak görseli */
    .media{position:relative;width:100%;background:#f1f5f9;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .media::before{content:"";display:block;padding-top:100%} /* kare alan */
    .media img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover; object-position:center;
      display:block; image-orientation:from-image;
    }

    .card{background:var(--paper);border:1px solid var(--line);border-radius:12px;padding:14px;margin-top:12px}
    .desc{white-space:pre-wrap;line-height:1.5}

    .actions{display:flex;gap:10px;margin-top:12px}
    .btn{appearance:none;border:1px solid var(--line);background:var(--paper2);color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer;text-decoration:none;text-align:center}
    .btn.primary{background:var(--brand);color:#fff;border-color:#000}

    .err{color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;padding:12px;border-radius:10px}
    #loading{color:var(--muted)}
  </style>
</head>
<body>
  <main class="wrap">
    <div class="top">
      <a class="back" href="/">← Ana sayfa</a>
      <div id="loading">Yükleniyor…</div>
    </div>

    <article id="ad" hidden>
      <div class="media"><img id="photo" alt=""></div>

      <div class="card">
        <h1 class="h1" id="title">İlan</h1>
        <div class="meta">
          <span id="city"></span> • <span id="cond"></span>
        </div>
        <div class="actions">
          <a id="btnOwner" class="btn" href="#">Sahibi profili</a>
          <!-- Teklif ver butonunu sonraki adımda aktif edeceğiz -->
          <button id="btnOffer" class="btn primary" type="button" disabled title="Sonraki adımda açılacak">Teklif ver</button>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px;font-size:18px">Açıklama</h2>
        <p class="desc" id="desc">—</p>
      </div>
    </article>

    <div id="error" class="err" hidden>İlan yüklenemedi.</div>
  </main>

  <!-- Firebase -->
  <script type="module" src="../assets/js/firebase-init.js"></script>
  <script type="module">
    const { db, auth, requireAuth } = window.__fb;
    requireAuth();

    import { getDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const qs = new URLSearchParams(location.search);
    const id = qs.get("id");

    const elLoad = document.getElementById("loading");
    const elErr  = document.getElementById("error");
    const elAd   = document.getElementById("ad");

    function showError(msg){
      elLoad.hidden = true;
      elErr.hidden = false;
      elErr.textContent = msg || "İlan bulunamadı.";
    }

    if(!id){
      showError("Geçersiz bağlantı (id yok).");
    }else{
      try{
        await auth.currentUser?.getIdToken(true); // token tazele
        const snap = await getDoc(doc(db, "listings", id));
        if(!snap.exists()){
          showError("İlan bulunamadı.");
        }else{
          const d = snap.data() || {};
          // kapak
          const cover = (d.photos && d.photos[0]) || "/assets/img/seffaf.png";
          const img = document.getElementById("photo");
          img.src = cover; img.alt = d.title || "İlan";

          // başlık+meta+açıklama
          document.getElementById("title").textContent = d.title || "İlan";
          document.getElementById("city").textContent  = d.city  || "";
          document.getElementById("cond").textContent  = d.cond  || "";
          document.getElementById("desc").textContent  = d.description || "—";

          // sahibi profili linki (şimdilik bu sayfaya yönlendiriyoruz)
          const owner = d.ownerId || d.uid || "";
          const ownerBtn = document.getElementById("btnOwner");
          if(owner){
            ownerBtn.href = `/profile/profile.html?uid=${encodeURIComponent(owner)}`;
          }else{
            ownerBtn.style.display = "none";
          }

          elLoad.hidden = true;
          elAd.hidden = false;
        }
      }catch(e){
        console.error("İlan getirilemedi:", e);
        showError(e?.code === "permission-denied" ? "Bu ilanı görme izniniz yok." : "İlan yüklenemedi.");
      }
    }
  </script>
</body>
</html>
