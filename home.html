<!-- /home.html -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Takas Çemberi • Ana Sayfa</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#ffc0cb; --bg2:#ffd6e7;
      --paper:#ffffff; --paper2:#fff5f8; --ink:#1b1b1f; --muted:#5f5f68; --line:#ffd0dc;
      --brandA:#6a5cff; --brandB:#00d4ff; --focus:#0ea5e9;
      --btn:#111827; --btnInk:#fff;
      --c1:#ff80ab; --c2:#a78bfa; --c3:#60a5fa; --c4:#34d399; --c5:#f59e0b;
      --black:#0b0b0f; --black-ink:#e8e8f0; --black-line:#1e1e27;
      --bottomH:64px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,var(--bg),var(--bg2));
      color:var(--ink);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      padding-bottom:calc(var(--bottomH) + env(safe-area-inset-bottom,0px) + 12px);
    }
    a,button{font:inherit}

    /* Topbar */
    .topbar{
      position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:12px;height:64px;
      padding:0 12px 0 16px;
      background:linear-gradient(90deg,var(--brandA),var(--brandB)); background-size:200% 200%; animation:barShift 8s ease-in-out infinite;
      border-bottom:1px solid rgba(0,0,0,.06); box-shadow:0 2px 12px rgba(10,20,60,.25)
    }
    @keyframes barShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:#fff}
    .brand img{height:44px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
    .brand strong{letter-spacing:.2px}
    .grow{flex:1}
    .btn{border:1px solid rgba(255,255,255,.24);background:rgba(0,0,0,.18);color:#fff;border-radius:12px;padding:8px 14px;cursor:pointer}
    .btn.primary{background:var(--btn);border-color:#000;color:var(--btnInk)}
    .btn:focus{outline:2px solid var(--focus);outline-offset:2px}

    /* Hero */
    .hero{max-width:1200px;margin:20px auto;padding:0 16px}
    .panel{background:var(--paper);border:1px solid var(--line);border-radius:20px;padding:24px;box-shadow:0 8px 28px rgba(170, 26, 80, .22)}
    .hero-panel{
      display:grid;place-items:center;text-align:center;padding:40px;
      background:linear-gradient(135deg,var(--c1),var(--c2),var(--c3),var(--c4),var(--c5));
      background-size:400% 400%;animation:barShift 14s ease infinite;border-color:transparent
    }
    .title{margin:0 0 10px;font-size:46px;font-weight:900}
    .subtitle{margin:0;font-size:20px}
    .gx{color:#ffffff;text-shadow:0 2px 10px rgba(0,0,0,.25),0 0 24px rgba(0,0,0,.15)}
    .gx-sub{color:#fffefc;opacity:.96;text-shadow:0 1px 6px rgba(0,0,0,.18)}
    .slogan{
      margin:16px auto 12px;max-width:900px;text-align:center;background:var(--paper2);border:1px solid var(--line);
      border-radius:16px;padding:16px 18px;font-weight:800;letter-spacing:.5px
    }

    /* Kategoriler */
    .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));margin-top:16px}
    .card{
      border-radius:18px;padding:18px;min-height:130px;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;
      color:#fff;border:1px solid rgba(255,255,255,.22);text-align:center;
      background:linear-gradient(135deg,var(--c1),var(--c2));background-size:300% 300%;animation:cardShift 16s ease-in-out infinite; text-decoration:none
    }
    .card:hover{transform:translateY(-4px)}
    @keyframes cardShift{
      0%{background-position:0% 50%}
      25%{background-position:50% 0%;background-image:linear-gradient(135deg,var(--c2),var(--c3))}
      50%{background-position:100% 50%;background-image:linear-gradient(135deg,var(--c3),var(--c4))}
      75%{background-position:50% 100%;background-image:linear-gradient(135deg,var(--c4),var(--c5))}
      100%{background-position:0% 50%;background-image:linear-gradient(135deg,var(--c1),var(--c2))}
    }
    .emoji{font-size:28px}

    /* Özellikler */
    .features{display:grid;gap:12px;margin-top:18px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .feature{padding:14px;border-radius:14px;color:#111827;text-align:center;border:1px solid var(--line);
      background:linear-gradient(135deg,#fff,#ffeaf3)}

    /* Bottom nav */
    .bottom-nav{
      position:fixed;left:0;right:0;bottom:0;background:var(--paper);border-top:1px solid var(--line);
      display:grid;grid-template-columns:repeat(3,1fr);z-index:40;height:var(--bottomH)
    }
    .tab{appearance:none;border:0;background:transparent;color:#6b7280;padding:10px 8px;display:flex;gap:6px;flex-direction:column;align-items:center;justify-content:center}
    .tab svg{width:22px;height:22px}
    .tab.active{color:#111827}

    /* === Support (compact & professional) === */
.support-fab.compact{
  position:fixed; right:16px; bottom:calc(var(--bottomH) + 16px);
  width:48px; height:48px; border-radius:12px;
  border:1px solid rgba(0,0,0,.18); background:#111827; color:#fff;
  display:grid; place-items:center; box-shadow:0 10px 30px rgba(0,0,0,.28); z-index:46;
}
.support-fab.compact:focus{ outline:3px solid var(--focus); outline-offset:2px; }

.support-pop.pro{
  position:fixed; right:16px; bottom:calc(var(--bottomH) + 72px);
  width:min(340px,92vw);
  background:#fff; color:#0f172a;
  border:1px solid #e5e7eb; border-radius:14px;
  box-shadow:0 18px 48px rgba(0,0,0,.28);
  display:none; z-index:47; overflow:hidden;
  transform-origin:bottom right; animation: none;
}
.support-pop.pro.show{ display:block; }

.support-pop.pro::after{
  content:""; position:absolute; right:18px; bottom:-9px; width:18px; height:18px;
  background:#fff; border-left:1px solid #e5e7eb; border-top:1px solid #e5e7eb;
  transform:rotate(45deg);
}

.support-pop.pro .sup-head{
  display:flex; flex-direction:column; gap:2px;
  background:#111827; color:#fff; padding:10px 12px;
}
/* X butonu için ekler */
.support-pop.pro .sup-head{ position:relative; }
.sup-close{
  position:absolute; right:8px; top:8px;
  width:28px; height:28px; border-radius:8px;
  border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.12); color:#fff;
  font-size:18px; line-height:1; cursor:pointer;
}
.sup-close:focus{ outline:2px solid var(--focus); outline-offset:2px; }

/* Canlı destek: mesaj listesi + baloncuklar (sağ/sol & iki renk) */
.support-pop.pro .sup-body{
  padding:14px 10px;
  max-height:46vh;
  overflow:auto;
  display:flex;               /* hizalama için flex sütun */
  flex-direction:column;
  gap:8px;
}

.support-pop.pro .msg{
  margin:0;
  font-size:13px;
  line-height:1.45;
  color:#0f172a;
  background:#eef2ff;         /* ADMİN (karşı taraf) için açık renk */
  border:1px solid #e5e7eb;
  padding:10px 12px;
  border-radius:12px 12px 12px 4px;  /* sola kuyruk hissi */
  max-width:80%;
  align-self:flex-start;       /* sola yasla */
  word-wrap:break-word;
  white-space:pre-wrap;
}

.support-pop.pro .msg.me{
  color:#ffffff;
  background:#111827;          /* KULLANICI (ben) için koyu renk */
  border-color:#111827;
  border-radius:12px 12px 4px 12px;  /* sağa kuyruk hissi */
  align-self:flex-end;         /* sağa yasla */
}

.support-pop.pro .sup-input{
  display:flex; gap:8px; padding:10px 10px 12px 10px; background:#f8fafc; border-top:1px solid #e5e7eb;
}
.support-pop.pro .sup-in{
  flex:1; min-width:0; padding:10px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; font:inherit;
}
.support-pop.pro .sup-send{
  width:40px; height:40px; border-radius:10px; border:1px solid #111827; background:#111827; color:#fff; display:grid; place-items:center; cursor:pointer;
}

/* küçük ekran uyumu */
@media (max-width:480px){
  .support-fab.compact{ right:12px; }
  .support-pop.pro{ right:12px; width:min(320px,94vw); }
}

    /* Legal footer */
    .legal{background:var(--black);color:var(--black-ink);border-top:1px solid var(--black-line);margin-top:20px}
    .legal .wrap{max-width:1200px;margin:0 auto;padding:18px 16px}
    .accordion{border:1px solid var(--black-line);border-radius:12px;overflow:hidden}
    .acc-item + .acc-item{border-top:1px solid var(--black-line)}
    .acc-btn{width:100%;text-align:left;background:transparent;color:var(--black-ink);border:0;padding:14px 16px;cursor:pointer;font-weight:800}
    .acc-panel{display:none;padding:0 16px 16px 16px;color:#cfd3e3}
    .acc-item.open .acc-panel{display:block}

    @media (min-width:720px){
      .title{font-size:52px}
      .subtitle{font-size:22px}
    }

    /* === İLAN KARTLARI (Yeni İlanlar) === */
    .ads-grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    @media (min-width:900px){.ads-grid{grid-template-columns:repeat(4,1fr)}}
    .ad-card{
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
      color:#111827;
      text-decoration:none;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
      transition:transform .15s ease;
      cursor:pointer;
    }

    .ad-card:hover{transform:translateY(-2px)}
    .ad-media{position:relative;width:100%;background:#f1f5f9;border-bottom:1px solid var(--line)}
    .ad-media::before{content:"";display:block;padding-top:100%} /* kare alan */
    .ad-media img{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      object-position:center;
      display:block;
      image-orientation:from-image;
    }
    .ad-body{padding:10px}
    .ad-title{
      margin:0 0 4px;
      font-size:14px;
      font-weight:800;
      line-height:1.25;
      color:#0f172a;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height: calc(1.25em * 2);
    }

    .ad-meta{display:flex;gap:6px;justify-content:space-between;color:#64748b;font-size:12px}

    .ad-actions{display:flex;gap:8px;margin-top:8px}
    .ad-actions button{
      flex:1;padding:8px 10px;border:1px solid var(--line);background:#f8fafc;color:#0f172a;
      border-radius:10px;cursor:pointer
    }
    .ad-actions .btn-view{background:#111827;color:#fff;border-color:#000}
    .ad-actions .btn-offer{background:#fff}
    
    .badge{
      position:absolute; top:-6px; right:-10px;
      min-width:18px; height:18px; padding:0 6px;
      border-radius:999px; background:#ef4444; color:#fff;
      font-size:11px; display:none; place-items:center;
    }

    html,body{overflow-x:hidden}
    /* Mobil header düzeltmeleri — BUNU en sona ekle */
    @media (max-width: 480px){
      .brand strong{ display:none; }
      .brand img{ height:36px; }
      .topbar{ gap:8px; padding-right:8px; }
      .btn{ padding:6px 10px; font-size:12px; }
    }

    /* Çok küçük ekranlar için opsiyonel: 'Ara'yı gizle */
    @media (max-width: 380px){
      #btnSearch{ display:none; }
    }
  </style>
  <link rel="icon" href="/favicon.png" type="image/png" sizes="32x32"/>
</head>
<body>
  <!-- Üst Bar -->
  <header class="topbar">
    <a class="brand" href="/">
      <img src="assets/img/seffaf.png" alt="Takas Çemberi logo" />
      <strong>Takas Çemberi</strong>
    </a>
    <div class="grow"></div>
    <button id="btnSearch" class="btn" aria-label="Ara">Ara</button>
    <button id="btnProfile" class="btn" aria-label="Profil">Profil</button>
    <button id="btnPostAd" class="btn primary" aria-label="İlan Ver">İlan Ver</button>
    <button id="btnLogout" class="btn" aria-label="Çıkış">Çıkış</button>
  </header>

  <!-- İçerik -->
  <main class="hero">
    <section class="panel hero-panel" aria-labelledby="welcome">
      <h1 id="welcome" class="title gx">Takas Çemberi’ne Hoş Geldiniz</h1>
      <p class="subtitle gx-sub">Evinizdeki eşyaları değerinde takas edin, atığı azaltın, birlikte kazanın.</p>
    </section>

    <section class="slogan" aria-live="polite">Doğaya • Bütçene • Dost</section>
  </main>

  <!-- İLANLAR -->
  <section class="panel" id="ads" aria-labelledby="ads-title" style="margin:12px auto;max-width:1200px;padding:16px">
    <h2 id="ads-title" style="margin:0 0 12px">Yeni İlanlar</h2>
    <div class="ads-grid" id="adsGrid" role="list"></div>
  </section>

  <!-- Kategoriler + Özellikler -->
  <section class="panel" aria-labelledby="cats-title" style="margin:12px auto;max-width:1200px;padding:24px 16px">
    <h2 id="cats-title" style="margin-bottom:12px;text-align:center">Kategoriler</h2>
    <div class="grid" role="list">
      <a class="card" role="listitem" href="/kategori/ev-hobi"><div class="emoji">🏠</div><h3>Ev & Hobi</h3><p>Ev eşyaları, hobi ürünleri</p></a>
      <a class="card" role="listitem" href="/kategori/tasinmaz"><div class="emoji">🏡</div><h3>Taşınmaz</h3><p>Ev, arsa, tarla</p></a>
      <a class="card" role="listitem" href="/kategori/tasit"><div class="emoji">🚗</div><h3>Motorlu Taşıtlar</h3><p>Araba, motosiklet, yedek parça</p></a>
      <a class="card" role="listitem" href="/kategori/oyuncak"><div class="emoji">🧸</div><h3>Oyuncak</h3><p>Her yaşa uygun oyuncaklar</p></a>
      <a class="card" role="listitem" href="/kategori/giyim"><div class="emoji">👗</div><h3>Giyim</h3><p>Kadın, erkek, çocuk</p></a>
      <a class="card" role="listitem" href="/kategori/beyaz-esya"><div class="emoji">⚡</div><h3>Beyaz Eşya</h3><p>Ev aletleri, mutfak</p></a>
      <a class="card" role="listitem" href="/kategori/teknoloji"><div class="emoji">💻</div><h3>Teknoloji</h3><p>Bilgisayar, telefon</p></a>
      <a class="card" role="listitem" href="/kategori/mobilya"><div class="emoji">🛋️</div><h3>Mobilya</h3><p>Koltuk, masa, dolap</p></a>
    </div>

    <div class="features" style="margin-top:18px">
      <div class="feature">✅ Güvenli Takas<br/>SSL ve KVKK güvencesiyle güvenli işlemler.</div>
      <div class="feature">📱 Kolay Kullanım<br/>Mobil uyumlu arayüz ile her yerde ilan ver.</div>
      <div class="feature">💬 Canlı Destek<br/>7/24 destek ekibi seninle.</div>
    </div>
  </section>

  <!-- Alt Bar -->
  <nav class="bottom-nav" aria-label="Alt menü">
    <button class="tab active" id="tabHome" aria-current="page" aria-label="Ana Sayfa">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9.5L12 3l9 6.5"/>
        <path d="M5 10v10h5v-6h4v6h5V10"/>
      </svg>
      <span style="font-size:12px">Ana Sayfa</span>
    </button>

    <button class="tab" id="tabMessages" aria-label="Mesajlar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12a8.5 8.5 0 0 1-8.5 8.5H7l-4 3 1.5-5.5A8.5 8.5 0 1 1 21 12z"/>
      </svg>
      <span style="font-size:12px; position:relative">
        Mesajlar
        <b id="msgBadge" class="badge" aria-live="polite">0</b>
      </span>
    </button>

    <button class="tab" id="tabNotifs" aria-label="Bildirimler">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M6 8a6 6 0 1 1 12 0c0 7 3 5 3 9H3c0-4 3-2 3-9"/>
        <path d="M9 21h6"/>
      </svg>
      <span style="font-size:12px; position:relative">
        Bildirimler
        <b id="notifBadge" class="badge" aria-live="polite">0</b>
      </span>
    </button>
  </nav>

  <!-- Canlı Destek (compact, yukarı açılır) -->
<button class="support-fab compact" id="btnSupport" aria-label="Canlı Destek">
  <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="12" cy="12" r="9"></circle>
    <path d="M8 13a3 3 0 0 0 3 3h1l4 3-.5-3.5"></path>
  </svg>
</button>

<div class="support-pop pro" id="supportPop" role="dialog" aria-modal="true" aria-live="polite" aria-label="Canlı Destek">
  <div class="sup-head">
    <strong>Canlı Destek</strong>
    <button id="supClose" class="sup-close" type="button" aria-label="Pencereyi kapat">×</button>
  </div>
    <div class="sup-body"></div>
  <div class="sup-input">
    <input id="chatInput" class="sup-in" placeholder="Mesajınızı yazın…" />
    <button id="chatSend" class="sup-send" type="button" aria-label="Gönder">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 2L11 13"></path><path d="M22 2l-7 20-4-9-9-4 20-7Z"></path>
      </svg>
    </button>
  </div>
</div>

  <!-- Alt Siyah Hukuki Alan -->
  <footer class="legal">
    <div class="wrap">
      <h2 style="margin-top:4px;margin-bottom:10px">Bilgilendirme</h2>
      <div class="accordion" id="acc">
        <div class="acc-item">
          <button class="acc-btn" type="button">KVKK</button>
          <div class="acc-panel"><p>Veri sorumlusu: Takas Çemberi A.Ş.<br/>Toplanan veriler: Ad, iletişim, işlem kayıtları.<br/>Amaç: Üyelik, güvenli takas, müşteri desteği.<br/>Haklarınız: Bilgi alma, düzeltme, silme, itiraz.</p></div>
        </div>
        <div class="acc-item">
          <button class="acc-btn" type="button">Gizlilik</button>
          <div class="acc-panel"><p>Çerez kullanımı ve tercih yönetimi.<br/>Üçüncü taraflarla paylaşım ilkeleri.<br/>Veri saklama süreleri ve şifreleme.</p></div>
        </div>
        <div class="acc-item">
          <button class="acc-btn" type="button">Güvenlik</button>
          <div class="acc-panel"><p>SSL/TLS ile şifreli bağlantı.<br/>2FA ve anormal aktivite izleme.<br/>İçerik moderasyonu ve raporlama.</p></div>
        </div>
        <div class="acc-item">
          <button class="acc-btn" type="button">SSL Bilgisi</button>
          <div class="acc-panel"><p>Modern protokoller (TLS 1.3) desteği.<br/>Güncel sertifika ve HSTS uygulanması.<br/>Güvenli çerçeve ve CORS politikaları.</p></div>
        </div>
        <div class="acc-item">
          <button class="acc-btn" type="button">Kullanım Şartları</button>
          <div class="acc-panel"><p>İlan kuralları ve yasaklı içerikler.<br/>Üyelik sorumlulukları ve fesih.<br/>Uyuşmazlık ve yetkili yargı mercii.</p></div>
        </div>
      </div>
      <p style="margin:12px 0 0;color:#a8acc4">© 2025 Takas Çemberi — milli sermayeyi koru, atığı azalt ♻️</p>
    </div>
  </footer>

  <!-- Global bildirim sesi (her sayfada çalışır) -->
  <audio id="notifySoundGlobal" preload="auto">
    <source src="/assets/sounds/notify.wav" type="audio/wav">
    <source src="/sounds/notify.wav" type="audio/wav">
  </audio>

  <!-- JS -->
  <script type="module" src="assets/js/firebase-init.js"></script>
  <!-- Global watcher'ı başlat -->
  <script>
    window.__fb?.startGlobalMessagingWatcher?.();
  </script>

  <!-- Sayfa mantığı -->
  <script type="module">
    const { auth, db, requireAuth } = window.__fb;
    requireAuth();

    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { collection, query, where, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ===== Audio güvenli oynatım (autoplay hatasını önler) ===== */
    let audioReady = false;
    const enableAudio = ()=>{ audioReady = true; };
    ['pointerdown','keydown','touchstart'].forEach(ev=>window.addEventListener(ev, enableAudio, {passive:true}));
    function playSoundSafe(){
      const tag = document.getElementById('notifySoundGlobal');
      if(!tag) return;
      if(document.visibilityState === 'visible' && audioReady){
        try{ tag.currentTime = 0; const p = tag.play(); if(p && p.catch) p.catch(()=>{}); }catch{}
      }
    }

    /* ===== İlanları çek ===== */
    async function loadAds(){
      const grid = document.getElementById("adsGrid");
      if(!grid) return;
      try {
        const q = query(collection(db,"listings"), where("isApproved","==", true), limit(20));
        const snap = await getDocs(q);

        if(snap.empty){
          grid.innerHTML = '<div style="grid-column:1/-1;color:#64748b">Henüz ilan yok</div>';
          return;
        }

        grid.innerHTML = "";
        snap.forEach(doc=>{
          const d = doc.data() || {};
          const cover = d.photos?.[0] || "/assets/img/seffaf.png";
          const title = d.title || "İlan";
          const city  = d.city  || "";
          const cond  = d.cond  || "";

          grid.innerHTML += `
  <div class="ad-card" data-id="${doc.id}">
    <div class="ad-media">
      <img src="${cover}" alt="${title}" loading="lazy" decoding="async">
    </div>
    <div class="ad-body">
      <h3 class="ad-title">${title}</h3>
      <div class="ad-meta"><span>${city}</span><span>${cond}</span></div>
      <div class="ad-actions">
        <button type="button" class="btn-view"  data-id="${doc.id}">İncele</button>
        <button type="button" class="btn-offer" data-id="${doc.id}" data-owner="${d.ownerId || d.uid || ''}">Teklif ver</button>
      </div>
    </div>
  </div>`;
        });

      } catch(err){
        console.error("İlan yükleme hatası:", err);
        grid.innerHTML = `<div style="grid-column:1/-1;color:#ef4444">İlanlar yüklenemedi: ${err.code||"hata"}</div>`;
      }
    }
    window.loadAds = loadAds;

    onAuthStateChanged(auth, async (user) => {
  const grid = document.getElementById("adsGrid");
  if (!user) {
    if (grid) grid.innerHTML = '<div style="grid-column:1/-1;color:#64748b">İlanları görmek için giriş yapın</div>';
    return;
  }

  // Public profilini garantiye al
  try { await window.__fb?.upsertPublicProfile?.(user); } catch {}

  await user.getIdToken(true);
  await loadAds();
});

    /* ===== Kart tıklama + butonlar ===== */
    const adsGridEl = document.getElementById("adsGrid");
    adsGridEl?.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button');
      if (btn) {
        const id = btn.dataset.id;
        if (btn.classList.contains('btn-view')) {
          location.href = `/ilan/index.html?id=${encodeURIComponent(id)}`;
          return;
        }
        if (btn.classList.contains('btn-offer')) {
          const owner = btn.dataset.owner || "";
          if (!owner) { alert("İlan sahibi bilgisi eksik."); return; }
          openOfferFlow(id, owner);
          return;
        }
      }
      const card = ev.target.closest('.ad-card');
      if (card && !ev.target.closest('.ad-actions')) {
        const id = card.dataset.id;
        location.href = `/ilan/index.html?id=${encodeURIComponent(id)}`;
      }
    });

    /* ===== Teklif akışı ===== */
    async function findMyListings(uid){
      const { collection, query, where, limit, getDocs } =
        await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const mine = [];
      let q1 = query(collection(db,'listings'), where('ownerId','==', uid), limit(20));
      let s1 = await getDocs(q1); s1.forEach(d=>mine.push({id:d.id, ...d.data()}));
      if(mine.length===0){
        let q2 = query(collection(db,'listings'), where('uid','==', uid), limit(20));
        let s2 = await getDocs(q2); s2.forEach(d=>mine.push({id:d.id, ...d.data()}));
      }
      return mine;
    }

    async function openOfferFlow(targetListingId, targetOwnerUid){
      const user = auth.currentUser;
      if(!user){ alert("Teklif vermek için giriş yapın."); return; }

      const mine = await findMyListings(user.uid);
      if(mine.length===0){
        if(confirm("Teklif verebilmek için en az bir ilanınız olmalı. İlan ver sayfasına gidelim mi?")){
          location.href = "/ilan/ilan-verme.html";
        }
        return;
      }

      let pick = 0;
      if(mine.length>1){
        const list = mine.map((m,i)=>`${i+1}) ${m.title||m.id}`).join('\n');
        const ans = prompt("Hangi ilanla teklif vermek istiyorsunuz?\n" + list + "\nNumara girin:", "1");
        const idx = Math.max(1, Math.min(mine.length, parseInt(ans||"1",10))) - 1;
        pick = isNaN(idx) ? 0 : idx;
      }
      const myListingId = mine[pick].id;
      const msg = prompt("Mesaj (opsiyonel):", "") || "";

      const { collection, addDoc, serverTimestamp } =
        await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

      const offer = {
        fromUid: user.uid,
        toUid:   targetOwnerUid,
        fromListingId: myListingId,
        createdAt: serverTimestamp(),
        message: msg,
        status: 'pending'
      };

      try{
        // 1) Teklifi kaydet ve referansı al
        const offerRef = await addDoc(collection(db,'listings', targetListingId, 'offers'), offer);

        // 2) Karşı tarafın inbox’ına bildirim bırak
        const { collection: coll2, addDoc: add2, serverTimestamp: ts } =
          await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

        await add2(
          coll2(db, 'users', targetOwnerUid, 'inbox'),
          {
            toUid: targetOwnerUid,
            fromUid: user.uid,
            type: 'offer',
            title: 'Yeni teklif',
            body: (msg && msg.trim()) ? msg.trim() : 'Bir teklifiniz var.',
            listingId: targetListingId,
            offerId: offerRef.id,
            link: `/ilan/index.html?id=${encodeURIComponent(targetListingId)}`,
            createdAt: ts(),
            read: false
          }
        );

        alert("Teklif gönderildi ✅");
      }catch(e){
        console.error("Teklif gönderilemedi:", e);
        alert("Teklif gönderilemedi: " + (e.code||"hata"));
      }
    }

    /* ===== Bana gelen teklifleri dinle (ilk yüklemede ping atma) ===== */
    let _offerUnsubs = [];
    async function watchOffersForMe(uid){
      _offerUnsubs.forEach(u=>{ try{u()}catch{} });
      _offerUnsubs = [];

      const { collection, onSnapshot } =
        await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

      const myListings = await findMyListings(uid);
      const firstLoadMap = new Map(); // listingId => firstLoadDone

      myListings.forEach(m=>{
        const offRef = collection(db, 'listings', m.id, 'offers');
        const unsub = onSnapshot(offRef, (snap)=>{
          const firstSeen = firstLoadMap.get(m.id) === true ? false : true;
          if(firstSeen){
            firstLoadMap.set(m.id, true); // ilk açılışta ses/uyarı verme
            return;
          }
          snap.docChanges().forEach(ch=>{
            const d = ch.doc.data();
            if(ch.type==='added' && d?.toUid === uid){
              // Güvenli ses + kısa toast
              playSoundSafe();
              const note = document.createElement('div');
              note.style.cssText = "position:fixed;right:16px;bottom:90px;background:#111827;color:#fff;padding:10px 12px;border-radius:10px;z-index:1000";
              note.textContent = `Yeni teklif! Gönderen: ${(d.fromUid||'').slice(0,6)}`;
              document.body.appendChild(note);
              setTimeout(()=>note.remove(), 2500);
            }
          });
        }, (e)=>console.warn('offer watch err', e));
        _offerUnsubs.push(unsub);
      });
    }

    onAuthStateChanged(auth, (u)=>{ if(u) watchOffersForMe(u.uid); });

/* ===== Üst bar + Alt bar (TEK KERE) ===== */
const $ = (s,r=document)=>r.querySelector(s);

$('#btnLogout')?.addEventListener('click', async ()=>{ 
  try{ await signOut(auth);}catch{} 
  location.href="/"; 
});
$('#btnProfile')?.addEventListener('click', ()=>location.href="/profile/profile.html");
$('#btnPostAd')?.addEventListener('click', ()=>location.href="/ilan/ilan-verme.html");
$('#btnSearch')?.addEventListener('click', ()=>location.href="/ara");

const tabs=[$('#tabHome'),$('#tabMessages'),$('#tabNotifs')].filter(Boolean);
tabs.forEach(t=>t.addEventListener('click',()=>{
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  if(t.id==='tabHome') location.href="/";
  if(t.id==='tabMessages') location.href="/messages.html";
  if(t.id==='tabNotifs') location.href="/notifications.html";
}));

/* ===== Canlı Destek baloncuğu: aç/kapat + canlı dinleme + gönder ===== */
const btnSupport = document.getElementById('btnSupport');
const pop        = document.getElementById('supportPop');
const chatIn     = document.getElementById('chatInput');
const chatSend   = document.getElementById('chatSend');
const supClose   = document.getElementById('supClose');
const supBody    = pop?.querySelector('.sup-body');

let supUnsub = null;        // Firestore canlı dinleyici
let autoAckShown = false;   // “Sizi canlı destek…” yalnız 1 kez

function appendMsg(text, isMe = false){
  if(!supBody) return;
  const p = document.createElement('p');
  p.className = 'msg' + (isMe ? ' me' : '');
  p.textContent = text;
  supBody.appendChild(p);
  supBody.scrollTop = supBody.scrollHeight;
}

/* === Balon açılınca: en son temizlemeden SONRAKİ mesajları göster === */
async function startLive(uid){
  if (!uid || !supBody) return;
  if (supUnsub) { try{ supUnsub(); }catch{} supUnsub = null; }

  const { doc, getDoc, collection, query, where, orderBy, onSnapshot } =
    await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

  // Kullanıcının en son ne zaman baloncuğu temizlediği
  let clearedAt = null;
  try{
    const tSnap = await getDoc(doc(db, 'supportThreads', uid));
    if (tSnap.exists()) clearedAt = tSnap.data()?.userClearedAt || null;
  }catch(e){ console.warn('userClearedAt okunamadı:', e); }

  // clearedAt'ten sonra gelenleri dinle
  const ref = collection(db, 'supportThreads', uid, 'messages');
  let q;
  if (clearedAt) {
    q = query(ref, where('createdAt','>', clearedAt), orderBy('createdAt','asc'));
  } else {
    q = query(ref, orderBy('createdAt','asc'));
  }

  supUnsub = onSnapshot(q, snap=>{
    supBody.innerHTML = '';
    if (snap.empty){
      appendMsg('Merhaba 👋 Nasıl yardımcı olalım?');
    } else {
      snap.forEach(doc=>{
        const m = doc.data() || {};
        const me = m.senderUid === uid; // benim mesajım sağda (me)
        appendMsg(m.text || '', me);
      });
    }
  }, err=>{
    console.warn('destek mesajları okunamadı:', err);
  });
}

function openPop(){
  if(!pop) return;
  pop.style.display='block';
  autoAckShown = false; // her açılışta sıfırla
  const u = auth.currentUser;
  if (u) {
    if(supBody){ supBody.innerHTML = ''; appendMsg('Merhaba 👋 Nasıl yardımcı olalım?'); }
    startLive(u.uid);
  } else {
    if(supBody){ supBody.innerHTML=''; appendMsg('Merhaba 👋 Nasıl yardımcı olalım?'); }
  }
}

/* === X’e basınca: sadece UI tarafını temizle (DB’ye dokunma) === */
async function closePop(){
  if(!pop) return;

  // Pencereyi kapat
  pop.style.display='none';

  // Canlı dinlemeyi kapat
  if (supUnsub) { try{ supUnsub(); }catch{} supUnsub = null; }

  // UI: baloncuğu anında boşalt (admin + kullanıcı mesajları)
  if (supBody) supBody.innerHTML = '';

  // DB: sadece KULLANICININ gönderdiği mesajları sil; admin mesajları kalsın
  try{
    const user = auth.currentUser;
    if(user){
      const { collection, query, where, limit, getDocs, deleteDoc, doc, setDoc, serverTimestamp } =
        await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

      const batchLimit = 50;
      while(true){
        const q = query(
          collection(db,'supportThreads', user.uid, 'messages'),
          where('senderUid','==', user.uid),
          limit(batchLimit)
        );
        const snap = await getDocs(q);
        if(snap.empty) break;

        const deletions = [];
        snap.forEach(d => deletions.push(deleteDoc(d.ref)));
        await Promise.all(deletions);

        if(snap.size < batchLimit) break;
      }

      // Yeniden açıldığında eski admin mesajları da görünmesin
      await setDoc(
        doc(db, 'supportThreads', user.uid),
        { userClearedAt: serverTimestamp() },
        { merge: true }
      );
    }
  }catch(e){
    console.warn('Kapatırken silme/işaretleme uyarı:', e);
  }
}

btnSupport?.addEventListener('click', openPop);
supClose?.addEventListener('click', ()=> closePop());

chatSend?.addEventListener('click', async ()=>{
  const txt = (chatIn?.value||'').trim();
  if(!txt) return;
  const user = auth.currentUser;
  if(!user){ location.href="/auth.html?next=/"; return; }

  // Benim mesajımı anında göster
  appendMsg(txt, true);

  try{
    const { addDoc, collection, serverTimestamp, setDoc, doc } =
      await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

    // Thread üst belgesi: liste & yetki için gerekli
    await setDoc(doc(db, 'supportThreads', user.uid), {
      participants: [user.uid],
      lastAt: serverTimestamp(),
      lastMsg: txt,
      lastSenderUid: user.uid
    }, { merge: true });

    // Mesajı alt koleksiyona yaz
    await addDoc(collection(db, 'supportThreads', user.uid, 'messages'), {
      senderUid: user.uid,
      text: txt,
      createdAt: serverTimestamp(),
      page: location.pathname
    });

    // Oto-yanıt — yalnız 1 kez göster
    if (!autoAckShown){
      appendMsg('Sizi canlı destek hattına yönlendiriyorum.');
      autoAckShown = true;
    }

    chatIn.value = '';
  }catch(e){
    console.error('destek mesajı hatası:', e);
    alert('Mesaj gönderilemedi.');
  }
});
</script>
  
  <script>
  // Hukuki akordeon (KVKK / Gizlilik / Güvenlik / SSL Bilgisi / Kullanım Şartları)
  (function () {
    const acc = document.getElementById('acc');
    if (!acc) return;

    // Başlangıç ARIA durumları
    acc.querySelectorAll('.acc-btn').forEach(b => b.setAttribute('aria-expanded', 'false'));

    acc.addEventListener('click', (ev) => {
      const btn = ev.target.closest('.acc-btn');
      if (!btn || !acc.contains(btn)) return;

      const item = btn.closest('.acc-item');
      const willOpen = !item.classList.contains('open');

      // İstersen tek tek açılsın: önce açık olanları kapat
      acc.querySelectorAll('.acc-item.open').forEach(it => {
        if (it !== item) {
          it.classList.remove('open');
          it.querySelector('.acc-btn')?.setAttribute('aria-expanded', 'false');
        }
      });

      // Tıklananı aç/kapat
      item.classList.toggle('open', willOpen);
      btn.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
    });
  })();
</script>

</body>
</html>
