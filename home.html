<!-- /home.html -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Takas Çemberi • Ana Sayfa</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#ffc0cb; --bg2:#ffd6e7;
      --paper:#ffffff; --paper2:#fff5f8; --ink:#1b1b1f; --muted:#5f5f68; --line:#ffd0dc;
      --brandA:#6a5cff; --brandB:#00d4ff; --focus:#0ea5e9;
      --btn:#111827; --btnInk:#fff;
      --c1:#ff80ab; --c2:#a78bfa; --c3:#60a5fa; --c4:#34d399; --c5:#f59e0b;
      --black:#0b0b0f; --black-ink:#e8e8f0; --black-line:#1e1e27;
      --bottomH:64px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,var(--bg),var(--bg2));
      color:var(--ink);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      padding-bottom:calc(var(--bottomH) + env(safe-area-inset-bottom,0px) + 12px);
    }
    a,button{font:inherit}

    /* Topbar */
    .topbar{
      position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:12px;height:64px;
      padding:0 12px 0 16px;
      background:linear-gradient(90deg,var(--brandA),var(--brandB)); background-size:200% 200%; animation:barShift 8s ease-in-out infinite;
      border-bottom:1px solid rgba(0,0,0,.06); box-shadow:0 2px 12px rgba(10,20,60,.25)
    }
    @keyframes barShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:#fff}
    .brand img{height:44px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
    .brand strong{letter-spacing:.2px}
    .grow{flex:1}
    .btn{border:1px solid rgba(255,255,255,.24);background:rgba(0,0,0,.18);color:#fff;border-radius:12px;padding:8px 14px;cursor:pointer}
    .btn.primary{background:var(--btn);border-color:#000;color:var(--btnInk)}
    .btn:focus{outline:2px solid var(--focus);outline-offset:2px}

    /* Hero */
    .hero{max-width:1200px;margin:20px auto;padding:0 16px}
    .panel{background:var(--paper);border:1px solid var(--line);border-radius:20px;padding:24px;box-shadow:0 8px 28px rgba(170, 26, 80, .22)}
    .hero-panel{
      display:grid;place-items:center;text-align:center;padding:40px;
      background:linear-gradient(135deg,var(--c1),var(--c2),var(--c3),var(--c4),var(--c5));
      background-size:400% 400%;animation:barShift 14s ease infinite;border-color:transparent
    }
    .title{margin:0 0 10px;font-size:46px;font-weight:900}
    .subtitle{margin:0;font-size:20px}
    .gx{color:#ffffff;text-shadow:0 2px 10px rgba(0,0,0,.25),0 0 24px rgba(0,0,0,.15)}
    .gx-sub{color:#fffefc;opacity:.96;text-shadow:0 1px 6px rgba(0,0,0,.18)}
    .slogan{
      margin:16px auto 12px;max-width:900px;text-align:center;background:var(--paper2);border:1px solid var(--line);
      border-radius:16px;padding:16px 18px;font-weight:800;letter-spacing:.5px
    }

    /* Kategoriler */
    .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));margin-top:16px}
    .card{
      border-radius:18px;padding:18px;min-height:130px;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;
      color:#fff;border:1px solid rgba(255,255,255,.22);text-align:center;
      background:linear-gradient(135deg,var(--c1),var(--c2));background-size:300% 300%;animation:cardShift 16s ease-in-out infinite; text-decoration:none
    }
    .card:hover{transform:translateY(-4px)}
    @keyframes cardShift{
      0%{background-position:0% 50%}
      25%{background-position:50% 0%;background-image:linear-gradient(135deg,var(--c2),var(--c3))}
      50%{background-position:100% 50%;background-image:linear-gradient(135deg,var(--c3),var(--c4))}
      75%{background-position:50% 100%;background-image:linear-gradient(135deg,var(--c4),var(--c5))}
      100%{background-position:0% 50%;background-image:linear-gradient(135deg,var(--c1),var(--c2))}
    }
    .emoji{font-size:28px}

    /* Özellikler */
    .features{display:grid;gap:12px;margin-top:18px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .feature{padding:14px;border-radius:14px;color:#111827;text-align:center;border:1px solid var(--line);
      background:linear-gradient(135deg,#fff,#ffeaf3)}

    /* Bottom nav */
    .bottom-nav{
      position:fixed;left:0;right:0;bottom:0;background:var(--paper);border-top:1px solid var(--line);
      display:grid;grid-template-columns:repeat(3,1fr);z-index:40;height:var(--bottomH)
    }
    .tab{appearance:none;border:0;background:transparent;color:#6b7280;padding:10px 8px;display:flex;gap:6px;flex-direction:column;align-items:center;justify-content:center}
    .tab svg{width:22px;height:22px}
    .tab.active{color:#111827}

    /* Support FAB + popover */
    .support-fab{
      position:fixed;right:16px;bottom:calc(var(--bottomH) + 16px);width:56px;height:56px;border-radius:50%;border:0;cursor:pointer;
      background:#111827;color:#fff;display:grid;place-items:center;box-shadow:0 8px 28px rgba(0,0,0,.25);z-index:45
    }
    .support-fab:focus{outline:3px solid var(--focus);outline-offset:2px}
    .support-pop{
      position:fixed;right:16px;bottom:calc(var(--bottomH) + 82px);min-width:320px;max-width:90vw;border-radius:16px;text-align:center;
      background:linear-gradient(135deg,var(--c1),var(--c2),var(--c3),var(--c4),var(--c5));background-size:400% 400%;
      animation:barShift 14s ease infinite; padding:18px 14px;color:#fff;box-shadow:0 14px 40px rgba(0,0,0,.3);display:none;z-index:46
    }
    .support-pop .msg{margin:0;font-weight:800;font-size:16px;line-height:1.35}
    .support-pop .input-row{display:flex;gap:8px;margin-top:12px;justify-content:center}
    .support-pop .in{flex:1;min-width:180px;max-width:260px;padding:10px;border-radius:12px;border:0}
    .support-pop .send{padding:10px 14px;border-radius:12px;border:0;background:#111827;color:#fff;cursor:pointer}
    .support-pop .arrow{position:absolute;right:24px;bottom:-10px;width:18px;height:18px;transform:rotate(45deg);background:inherit;filter:drop-shadow(0 4px 6px rgba(0,0,0,.25))}

    /* Legal footer */
    .legal{background:var(--black);color:var(--black-ink);border-top:1px solid var(--black-line);margin-top:20px}
    .legal .wrap{max-width:1200px;margin:0 auto;padding:18px 16px}
    .accordion{border:1px solid var(--black-line);border-radius:12px;overflow:hidden}
    .acc-item + .acc-item{border-top:1px solid var(--black-line)}
    .acc-btn{width:100%;text-align:left;background:transparent;color:var(--black-ink);border:0;padding:14px 16px;cursor:pointer;font-weight:800}
    .acc-panel{display:none;padding:0 16px 16px 16px;color:#cfd3e3}
    .acc-item.open .acc-panel{display:block}

    @media (min-width:720px){
      .title{font-size:52px}
      .subtitle{font-size:22px}
    }

    /* === İLAN KARTLARI (Yeni İlanlar) === */
    .ads-grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    @media (min-width:900px){.ads-grid{grid-template-columns:repeat(4,1fr)}}
    .ad-card{
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
      color:#111827;
      text-decoration:none;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
      transition:transform .15s ease;
    }
    .ad-card:hover{transform:translateY(-2px)}
    .ad-media{position:relative;width:100%;background:#f1f5f9;border-bottom:1px solid var(--line)}
    .ad-media::before{content:"";display:block;padding-top:100%} /* kare alan */
    .ad-media img{
     position:absolute; inset:0;
     width:100%; height:100%;
     object-fit:cover;
     object-position:center;   /* ← buraya eklendi */
     display:block;
     image-orientation:from-image;
   }
   .ad-body{padding:10px}
    .ad-title{
    margin:0 0 4px;
    font-size:14px;
    font-weight:800;
    line-height:1.25;
    color:#0f172a;
    display:-webkit-box;
   -webkit-line-clamp:2;
   -webkit-box-orient:vertical;
   overflow:hidden;
   min-height: calc(1.25em * 2);
 }

.ad-meta{display:flex;gap:6px;justify-content:space-between;color:#64748b;font-size:12px}

.ad-actions{display:flex;gap:8px;margin-top:8px}
.ad-actions button{
  flex:1;padding:8px 10px;border:1px solid var(--line);background:#f8fafc;color:#0f172a;
  border-radius:10px;cursor:pointer
}
.ad-actions .btn-view{background:#111827;color:#fff;border-color:#000}
.ad-actions .btn-offer{background:#fff}

html,body{overflow-x:hidden}
    /* Mobil header düzeltmeleri — BUNU en sona ekle */
@media (max-width: 480px){
  .brand strong{ display:none; }        /* logonun yanındaki yazıyı gizle */
  .brand img{ height:36px; }            /* logo biraz küçülsün */
  .topbar{ gap:8px; padding-right:8px; }/* boşlukları daralt */
  .btn{ padding:6px 10px; font-size:12px; } /* butonlar daralsın */
}

/* Çok küçük ekranlar için opsiyonel: 'Ara'yı gizle */
@media (max-width: 380px){
  #btnSearch{ display:none; }
}
  </style>
  <link rel="icon" href="/favicon.png" type="image/png" sizes="32x32"/>
</head>
<body>
  <!-- Üst Bar -->
  <header class="topbar">
    <a class="brand" href="/">
      <img src="assets/img/seffaf.png" alt="Takas Çemberi logo" />
      <strong>Takas Çemberi</strong>
    </a>
    <div class="grow"></div>
    <button id="btnSearch" class="btn" aria-label="Ara">Ara</button>
    <button id="btnProfile" class="btn" aria-label="Profil">Profil</button>
    <button id="btnPostAd" class="btn primary" aria-label="İlan Ver">İlan Ver</button>
    <button id="btnLogout" class="btn" aria-label="Çıkış">Çıkış</button>
  </header>

  <!-- İçerik -->
  <main class="hero">
    <section class="panel hero-panel" aria-labelledby="welcome">
      <h1 id="welcome" class="title gx">Takas Çemberi’ne Hoş Geldiniz</h1>
      <p class="subtitle gx-sub">Evinizdeki eşyaları değerinde takas edin, atığı azaltın, birlikte kazanın.</p>
    </section>

    <section class="slogan" aria-live="polite">Doğaya • Bütçene • Dost</section>
  </main>

  <!-- İLANLAR -->
  <section class="panel" id="ads" aria-labelledby="ads-title" style="margin:12px auto;max-width:1200px;padding:16px">
    <h2 id="ads-title" style="margin:0 0 12px">Yeni İlanlar</h2>
    <div class="ads-grid" id="adsGrid" role="list"></div>
  </section>

  <!-- Kategoriler + Özellikler -->
  <section class="panel" aria-labelledby="cats-title" style="margin:12px auto;max-width:1200px;padding:24px 16px">
    <h2 id="cats-title" style="margin-bottom:12px;text-align:center">Kategoriler</h2>
    <div class="grid" role="list">
      <a class="card" role="listitem" href="/kategori/ev-hobi"><div class="emoji">🏠</div><h3>Ev & Hobi</h3><p>Ev eşyaları, hobi ürünleri</p></a>
      <a class="card" role="listitem" href="/kategori/tasinmaz"><div class="emoji">🏡</div><h3>Taşınmaz</h3><p>Ev, arsa, tarla</p></a>
      <a class="card" role="listitem" href="/kategori/tasit"><div class="emoji">🚗</div><h3>Motorlu Taşıtlar</h3><p>Araba, motosiklet, yedek parça</p></a>
      <a class="card" role="listitem" href="/kategori/oyuncak"><div class="emoji">🧸</div><h3>Oyuncak</h3><p>Her yaşa uygun oyuncaklar</p></a>
      <a class="card" role="listitem" href="/kategori/giyim"><div class="emoji">👗</div><h3>Giyim</h3><p>Kadın, erkek, çocuk</p></a>
      <a class="card" role="listitem" href="/kategori/beyaz-esya"><div class="emoji">⚡</div><h3>Beyaz Eşya</h3><p>Ev aletleri, mutfak</p></a>
      <a class="card" role="listitem" href="/kategori/teknoloji"><div class="emoji">💻</div><h3>Teknoloji</h3><p>Bilgisayar, telefon</p></a>
      <a class="card" role="listitem" href="/kategori/mobilya"><div class="emoji">🛋️</div><h3>Mobilya</h3><p>Koltuk, masa, dolap</p></a>
    </div>

    <div class="features" style="margin-top:18px">
      <div class="feature">✅ Güvenli Takas<br/>SSL ve KVKK güvencesiyle güvenli işlemler.</div>
      <div class="feature">📱 Kolay Kullanım<br/>Mobil uyumlu arayüz ile her yerde ilan ver.</div>
      <div class="feature">💬 Canlı Destek<br/>7/24 destek ekibi seninle.</div>
    </div>
  </section>

  <!-- Alt Bar -->
  <nav class="bottom-nav" aria-label="Alt menü">
    <button class="tab active" id="tabHome" aria-current="page" aria-label="Ana Sayfa">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9.5L12 3l9 6.5"/><path d="M5 10v10h5v-6h4v6h5V10"/></svg>
      <span style="font-size:12px">Ana Sayfa</span>
    </button>
    <button class="tab" id="tabMessages" aria-label="Mesajlar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a8.5 8.5 0 0 1-8.5 8.5H7l-4 3 1.5-5.5A8.5 8.5 0 1 1 21 12z"/></svg>
      <span style="font-size:12px">Mesajlar</span>
    </button>
    <button class="tab" id="tabNotifs" aria-label="Bildirimler">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 8a6 6 0 1 1 12 0c0 7 3 5 3 9H3c0-4 3-2 3-9"/><path d="M9 21h6"/></svg>
      <span style="font-size:12px">Bildirimler</span>
    </button>
  </nav>

  <!-- Canlı Destek FAB + Popover -->
  <button class="support-fab" id="btnSupport" aria-label="Canlı Destek">
    <svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/><path d="M8 13a3 3 0 0 0 3 3h1l4 3-.5-3.5"/></svg>
  </button>
  <div class="support-pop" id="supportPop" role="dialog" aria-modal="true" aria-live="polite" aria-label="Canlı Destek">
    <p class="msg">Merhaba! Yardım için mesaj bırakın. WhatsApp/telefon bağlantısını sonra ekleyeceğiz.</p>
    <div class="input-row">
      <input class="in" id="chatInput" placeholder="Mesajınız" />
      <button type="button" class="send" id="chatSend">Gönder</button>
    </div>
    <div class="arrow" aria-hidden="true"></div>
  </div>

  <!-- Alt Siyah Hukuki Alan -->
  <footer class="legal">
    <div class="wrap">
      <h2 style="margin-top:4px;margin-bottom:10px">Bilgilendirme</h2>
      <div class="accordion" id="acc">
        <div class="acc-item">
          <button class="acc-btn" type="button">KVKK</button>
          <div class="acc-panel"><p>Veri sorumlusu: Takas Çemberi A.Ş.<br/>Toplanan veriler: Ad, iletişim, işlem kayıtları.<br/>Amaç: Üyelik, güvenli takas, müşteri desteği.<br/>Haklarınız: Bilgi alma, düzeltme, silme, itiraz.</p></div>
        </div>
        <div class="acc-item">
          <button class="acc-btn" type="button">Gizlilik</button>
          <div class="acc-panel"><p>Çerez kullanımı ve tercih yönetimi.<br/>Üçüncü taraflarla paylaşım ilkeleri.<br/>Veri saklama süreleri ve şifreleme.</p></div>
        </div>
        <div class="acc-item">
          <button class="acc-btn" type="button">Güvenlik</button>
          <div class="acc-panel"><p>SSL/TLS ile şifreli bağlantı.<br/>2FA ve anormal aktivite izleme.<br/>İçerik moderasyonu ve raporlama.</p></div>
        </div>
        <div class="acc-item">
          <button class="acc-btn" type="button">SSL Bilgisi</button>
          <div class="acc-panel"><p>Modern protokoller (TLS 1.3) desteği.<br/>Güncel sertifika ve HSTS uygulanması.<br/>Güvenli çerçeve ve CORS politikaları.</p></div>
        </div>
        <div class="acc-item">
          <button class="acc-btn" type="button">Kullanım Şartları</button>
          <div class="acc-panel"><p>İlan kuralları ve yasaklı içerikler.<br/>Üyelik sorumlulukları ve fesih.<br/>Uyuşmazlık ve yetkili yargı mercii.</p></div>
        </div>
      </div>
      <p style="margin:12px 0 0;color:#a8acc4">© 2025 Takas Çemberi — milli sermayeyi koru, atığı azalt ♻️</p>
    </div>
  </footer>
     <!-- JS -->
  <script type="module" src="assets/js/firebase-init.js"></script>
<script type="module">
  const { auth, db, requireAuth } = window.__fb;
  requireAuth();

  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // İlanları çek
async function loadAds(){
  const grid = document.getElementById("adsGrid");
  if(!grid) return;
  try {
  const q = query(
  collection(db,"listings"),
  where("isApproved","==", true),
  limit(20)
 );

    const snap = await getDocs(q);

    if(snap.empty){
      grid.innerHTML = '<div style="grid-column:1/-1;color:#64748b">Henüz ilan yok</div>';
      return;
    }

    grid.innerHTML = "";
    snap.forEach(doc=>{
      const d = doc.data() || {};

      // client-side filtre
      const cover = d.photos?.[0] || "/assets/img/seffaf.png";
      const title = d.title || "İlan";
      const city  = d.city  || "";
      const cond  = d.cond  || "";

      grid.innerHTML += `
  <div class="ad-card" data-id="${doc.id}">
    <div class="ad-media">
      <img src="${cover}" alt="${title}" loading="lazy" decoding="async">
    </div>
    <div class="ad-body">
      <h3 class="ad-title">${title}</h3>
      <div class="ad-meta"><span>${city}</span><span>${cond}</span></div>
      <div class="ad-actions">
        <button type="button" class="btn-view"  data-id="${doc.id}">İncele</button>
        <button type="button" class="btn-offer" data-id="${doc.id}" data-owner="${d.ownerId || d.uid || ''}">Teklif ver</button>
      </div>
    </div>
  </div>`;
 });

  } catch(err){
    console.error("İlan yükleme hatası:", err);
    grid.innerHTML = `<div style="grid-column:1/-1;color:#ef4444">İlanlar yüklenemedi: ${err.code||"hata"}</div>`;
  }
}
  window.loadAds = loadAds;
onAuthStateChanged(auth, async (user) => {
  const grid = document.getElementById("adsGrid");
  if (!user) {
    if (grid) grid.innerHTML = '<div style="grid-column:1/-1;color:#64748b">İlanları görmek için giriş yapın</div>';
    return;
  }
  await user.getIdToken(true); // token güncellensin
  await loadAds();
});
  // === Teklif akışı + bildirim + bip ===

// Basit bip sesi
function beep(duration=160, freq=880){
  try{
    const actx = new (window.AudioContext||window.webkitAudioContext)();
    const o = actx.createOscillator();
    const g = actx.createGain();
    o.type = 'sine'; o.frequency.value = freq;
    o.connect(g); g.connect(actx.destination);
    g.gain.setValueAtTime(0.001, actx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, actx.currentTime + 0.01);
    o.start();
    setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime + 0.04); o.stop(); actx.close(); }, duration);
  }catch{}
}

// Kullanıcının en az 1 ilanı var mı?
async function findMyListings(uid){
  const { collection, query, where, limit, getDocs } =
    await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
  const mine = [];
  // 1) ownerId
  let q1 = query(collection(db,'listings'), where('ownerId','==', uid), limit(20));
  let s1 = await getDocs(q1); s1.forEach(d=>mine.push({id:d.id, ...d.data()}));
  // 2) eski alan: uid
  if(mine.length===0){
    let q2 = query(collection(db,'listings'), where('uid','==', uid), limit(20));
    let s2 = await getDocs(q2); s2.forEach(d=>mine.push({id:d.id, ...d.data()}));
  }
  return mine;
}

// Teklif akışı
async function openOfferFlow(targetListingId, targetOwnerUid){
  const user = auth.currentUser;
  if(!user){ alert("Teklif vermek için giriş yapın."); return; }

  const mine = await findMyListings(user.uid);
  if(mine.length===0){
    if(confirm("Teklif verebilmek için en az bir ilanınız olmalı. İlan ver sayfasına gidelim mi?")){
      location.href = "/ilan/ilan-verme.html";
    }
    return;
  }

  // Hangi ilanla teklif verilecek? (çokluysa basit seçim)
  let pick = 0;
  if(mine.length>1){
    const list = mine.map((m,i)=>`${i+1}) ${m.title||m.id}`).join('\n');
    const ans = prompt("Hangi ilanla teklif vermek istiyorsunuz?\n" + list + "\nNumara girin:", "1");
    const idx = Math.max(1, Math.min(mine.length, parseInt(ans||"1",10))) - 1;
    pick = isNaN(idx) ? 0 : idx;
  }
  const myListingId = mine[pick].id;
  const msg = prompt("Mesaj (opsiyonel):", "") || "";

  const { collection, addDoc, serverTimestamp } =
    await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

  const offer = {
    fromUid: user.uid,
    toUid:   targetOwnerUid,
    fromListingId: myListingId,
    createdAt: serverTimestamp(),
    message: msg
  };

  try{
    await addDoc(collection(db,'listings', targetListingId, 'offers'), offer);
    alert("Teklif gönderildi ✅");
  }catch(e){
    console.error("Teklif gönderilemedi:", e);
    alert("Teklif gönderilemedi: " + (e.code||"hata"));
  }
}

// Kart butonları (event delegation)
const adsGridEl = document.getElementById("adsGrid");
adsGridEl?.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button');
  if(!btn) return;
  const id = btn.dataset.id;
  if(btn.classList.contains('btn-view')){
    location.href = `/ilan/${id}`;
    return;
  }
  if(btn.classList.contains('btn-offer')){
    const owner = btn.dataset.owner || "";
    if(!owner){ alert("İlan sahibi bilgisi eksik."); return; }
    openOfferFlow(id, owner);
  }
});

// Bana gelen teklifleri dinle (ilan sahibi isem)
let _offerUnsubs = [];
async function watchOffersForMe(uid){
  // eski dinleyicileri kapat
  _offerUnsubs.forEach(u=>{ try{u()}catch{} });
  _offerUnsubs = [];

  const { collection, onSnapshot } =
    await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

  const myListings = await findMyListings(uid);
  myListings.forEach(m=>{
    const offRef = collection(db, 'listings', m.id, 'offers');
    const unsub = onSnapshot(offRef, (snap)=>{
      snap.docChanges().forEach(ch=>{
        const d = ch.doc.data();
        if(ch.type==='added' && d?.toUid === uid){
          if(document.visibilityState !== 'hidden') beep();
          const note = document.createElement('div');
          note.style.cssText = "position:fixed;right:16px;bottom:90px;background:#111827;color:#fff;padding:10px 12px;border-radius:10px;z-index:1000";
          note.textContent = `Yeni teklif! Gönderen: ${(d.fromUid||'').slice(0,6)}`;
          document.body.appendChild(note);
          setTimeout(()=>note.remove(), 2500);
        }
      });
    }, (e)=>console.warn('offer watch err', e));
    _offerUnsubs.push(unsub);
  });
}

// Login olunca teklif dinlemeyi başlat
onAuthStateChanged(auth, (u)=>{ if(u) watchOffersForMe(u.uid); });

  // Üst bar butonları
  const $ = (s,r=document)=>r.querySelector(s);
  $('#btnLogout')?.addEventListener('click', async ()=>{
    try{ await signOut(auth);}catch{}
    location.href="/";
  });
  $('#btnProfile')?.addEventListener('click', ()=>location.href="/profile/profile.html");
  $('#btnPostAd')?.addEventListener('click', ()=>location.href="/ilan/ilan-verme.html");
  $('#btnSearch')?.addEventListener('click', ()=>location.href="/ara");

  // Alt bar
  const tabs=[$('#tabHome'),$('#tabMessages'),$('#tabNotifs')].filter(Boolean);
  tabs.forEach(t=>t.addEventListener('click',()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    if(t.id==='tabHome') location.href="/";
    if(t.id==='tabMessages') location.href="/messages.html";
    if(t.id==='tabNotifs') location.href="/notifications.html";
  }));
</script>
  
</body>
</html>
