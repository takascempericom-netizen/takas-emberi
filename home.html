<!-- /home.html -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Takas Çemberi • Ana Sayfa</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="/favicon.png" type="image/png" sizes="32x32"/>

  <style>
    :root{
      --bg:#ffc0cb; --bg2:#ffd6e7;
      --paper:#ffffff; --paper2:#fff5f8; --ink:#1b1b1f; --muted:#5f5f68; --line:#ffd0dc;
      --brandA:#6a5cff; --brandB:#00d4ff; --focus:#0ea5e9;
      --btn:#111827; --btnInk:#fff;
      --c1:#ff80ab; --c2:#a78bfa; --c3:#60a5fa; --c4:#34d399; --c5:#f59e0b;
      --black:#0b0b0f; --black-ink:#e8e8f0; --black-line:#1e1e27;
      --bottomH:64px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,var(--bg),var(--bg2));
      color:var(--ink);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      padding-bottom:calc(var(--bottomH) + env(safe-area-inset-bottom,0px) + 12px);
    }
    a,button{font:inherit}

    /* Topbar */
    .topbar{
      position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:12px;height:64px;
      padding:0 12px 0 16px;
      background:linear-gradient(90deg,var(--brandA),var(--brandB));
      background-size:200% 200%; animation:barShift 8s ease-in-out infinite;
      border-bottom:1px solid rgba(0,0,0,.06); box-shadow:0 2px 12px rgba(10,20,60,.25)
    }
    @keyframes barShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:#fff}
    .brand img{height:44px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
    .brand strong{letter-spacing:.2px}
    .grow{flex:1}
    .btn{border:1px solid rgba(255,255,255,.24);background:rgba(0,0,0,.18);color:#fff;border-radius:12px;padding:8px 14px;cursor:pointer}
    .btn.primary{background:var(--btn);border-color:#000;color:var(--btnInk)}
    .btn:focus{outline:2px solid var(--focus);outline-offset:2px}

    /* Hero */
    .hero{max-width:1200px;margin:20px auto;padding:0 16px}
    .panel{background:var(--paper);border:1px solid var(--line);border-radius:20px;padding:24px;box-shadow:0 8px 28px rgba(170, 26, 80, .22)}
    .hero-panel{
      display:grid;place-items:center;text-align:center;padding:40px;
      background:linear-gradient(135deg,var(--c1),var(--c2),var(--c3),var(--c4),var(--c5));
      background-size:400% 400%;animation:barShift 14s ease infinite;border-color:transparent
    }
    .title{margin:0 0 10px;font-size:46px;font-weight:900}
    .subtitle{margin:0;font-size:20px}
    .gx{color:#ffffff;text-shadow:0 2px 10px rgba(0,0,0,.25),0 0 24px rgba(0,0,0,.15)}
    .gx-sub{color:#fffefc;opacity:.96;text-shadow:0 1px 6px rgba(0,0,0,.18)}
    .slogan{
      margin:16px auto 12px;max-width:900px;text-align:center;background:var(--paper2);border:1px solid var(--line);
      border-radius:16px;padding:16px 18px;font-weight:800;letter-spacing:.5px
    }

    /* Kategoriler */
    .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));margin-top:16px}
    .card{
      border-radius:18px;padding:18px;min-height:130px;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;
      color:#fff;border:1px solid rgba(255,255,255,.22);text-align:center;
      background:linear-gradient(135deg,var(--c1),var(--c2));background-size:300% 300%;
      animation:cardShift 16s ease-in-out infinite; text-decoration:none
    }
    .card:hover{transform:translateY(-4px)}
    @keyframes cardShift{
      0%{background-position:0% 50%}
      25%{background-position:50% 0%;background-image:linear-gradient(135deg,var(--c2),var(--c3))}
      50%{background-position:100% 50%;background-image:linear-gradient(135deg,var(--c3),var(--c4))}
      75%{background-position:50% 100%;background-image:linear-gradient(135deg,var(--c4),var(--c5))}
      100%{background-position:0% 50%;background-image:linear-gradient(135deg,var(--c1),var(--c2))}
    }
    .emoji{font-size:28px}

    /* Özellikler */
    .features{display:grid;gap:12px;margin-top:18px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .feature{padding:14px;border-radius:14px;color:#111827;text-align:center;border:1px solid var(--line);
      background:linear-gradient(135deg,#fff,#ffeaf3)}

    /* Bottom nav */
    .bottom-nav{
      position:fixed;left:0;right:0;bottom:0;background:var(--paper);border-top:1px solid var(--line);
      display:grid;grid-template-columns:repeat(3,1fr);z-index:40;height:var(--bottomH)
    }
    .tab{appearance:none;border:0;background:transparent;color:#6b7280;padding:10px 8px;display:flex;gap:6px;flex-direction:column;align-items:center;justify-content:center}
    .tab svg{width:22px;height:22px}
    .tab.active{color:#111827}

    /* Support: fab + popup */
    .support-fab.compact{
      position:fixed; right:16px; bottom:calc(var(--bottomH) + 16px);
      width:48px; height:48px; border-radius:12px;
      border:1px solid rgba(0,0,0,.18); background:#111827; color:#fff;
      display:grid; place-items:center; box-shadow:0 10px 30px rgba(0,0,0,.28); z-index:46;
    }
    .support-fab.compact:focus{ outline:3px solid var(--focus); outline-offset:2px; }
    .support-pop.pro{
      position:fixed; right:16px; bottom:calc(var(--bottomH) + 72px);
      width:min(340px,92vw);
      background:#fff; color:#0f172a;
      border:1px solid #e5e7eb; border-radius:14px;
      box-shadow:0 18px 48px rgba(0,0,0,.28);
      display:none; z-index:47; overflow:hidden;
      transform-origin:bottom right;
    }
    .support-pop.pro.show{ display:block; }
    .support-pop.pro::after{
      content:""; position:absolute; right:18px; bottom:-9px; width:18px; height:18px;
      background:#fff; border-left:1px solid #e5e7eb; border-top:1px solid #e5e7eb;
      transform:rotate(45deg);
    }
    .support-pop.pro .sup-head{
      display:flex; flex-direction:column; gap:2px;
      background:#111827; color:#fff; padding:10px 12px; position:relative;
    }
    .sup-close{
      position:absolute; right:8px; top:8px; width:28px; height:28px; border-radius:8px;
      border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.12); color:#fff;
      font-size:18px; line-height:1; cursor:pointer;
    }
    .sup-close:focus{ outline:2px solid var(--focus); outline-offset:2px; }
    .support-pop.pro .sup-body{
      padding:14px 10px; max-height:46vh; overflow:auto;
      display:flex; flex-direction:column; gap:8px;
    }
    .support-pop.pro .msg{
      margin:0; font-size:13px; line-height:1.45; color:#0f172a;
      background:#eef2ff; border:1px solid #e5e7eb; padding:10px 12px;
      border-radius:12px 12px 12px 4px; max-width:80%; align-self:flex-start;
      word-wrap:break-word; white-space:pre-wrap;
    }
    .support-pop.pro .msg.me{
      color:#ffffff; background:#111827; border-color:#111827;
      border-radius:12px 12px 4px 12px; align-self:flex-end;
    }
    .support-pop.pro .sup-input{
      display:flex; gap:8px; padding:10px 10px 12px 10px; background:#f8fafc; border-top:1px solid #e5e7eb;
    }
    .support-pop.pro .sup-in{
      flex:1; min-width:0; padding:10px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; font:inherit;
    }
    .support-pop.pro .sup-send{
      width:40px; height:40px; border-radius:10px; border:1px solid #111827; background:#111827; color:#fff; display:grid; place-items:center; cursor:pointer;
    }

    /* İlan kartları */
    .ads-grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    @media (min-width:900px){.ads-grid{grid-template-columns:repeat(4,1fr)}}
    .ad-card{
      border:1px solid var(--line); border-radius:16px; overflow:hidden; background:#fff; color:#111827;
      text-decoration:none; box-shadow:0 6px 18px rgba(0,0,0,.06); transition:transform .15s ease; cursor:pointer;
    }
    .ad-card:hover{transform:translateY(-2px)}
    .ad-media{position:relative;width:100%;background:#f1f5f9;border-bottom:1px solid var(--line)}
    .ad-media::before{content:"";display:block;padding-top:100%}
    .ad-media img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center; display:block; image-orientation:from-image;}
    .ad-body{padding:10px}
    .ad-title{
      margin:0 0 4px; font-size:14px; font-weight:800; line-height:1.25; color:#0f172a;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; min-height: calc(1.25em * 2);
    }
    .ad-meta{display:flex;gap:6px;justify-content:space-between;color:#64748b;font-size:12px}
    .ad-actions{display:flex;gap:8px;margin-top:8px}
    .ad-actions button{ flex:1;padding:8px 10px;border:1px solid var(--line);background:#f8fafc;color:#0f172a;border-radius:10px;cursor:pointer }
    .ad-actions .btn-view{background:#111827;color:#fff;border-color:#000}
    .ad-actions .btn-offer{background:#fff}

    .badge{
      position:absolute; top:-6px; right:-10px; min-width:18px; height:18px; padding:0 6px;
      border-radius:999px; background:#ef4444; color:#fff; font-size:11px; display:none; place-items:center;
    }

    html,body{overflow-x:hidden}

    /* Mobil header */
    @media (max-width:480px){
      .brand strong{ display:none; }
      .brand img{ height:36px; }
      .topbar{ gap:8px; padding-right:8px; }
      .btn{ padding:6px 10px; font-size:12px; }
      #btnSearch{ display:inline-block; }
    }
    @media (max-width:380px){
      #btnSearch{ display:none; }
    }
  </style>
</head>
<body>
  <!-- Üst Bar -->
  <header class="topbar">
    <a class="brand" href="/">
      <img src="assets/img/seffaf.png" alt="Takas Çemberi logo" />
      <strong>Takas Çemberi</strong>
    </a>
    <div class="grow"></div>

    <!-- DİL SEÇİCİ (ekleme) -->
    <select id="langSelect" style="border-radius:8px;padding:6px;font-weight:600" aria-label="Language">
      <option value="tr">TR</option>
      <option value="en">EN</option>
      <option value="ar">AR</option>
    </select>

    <button id="btnSearch" class="btn" data-i18n="cta.browse"></button>
<button id="btnProfile" class="btn" data-i18n="nav.profile"></button>
<button id="btnPostAd" class="btn primary" data-i18n="cta.post"></button>
<button id="btnLogout" class="btn" data-i18n="nav.logout"></button>
  </header>

  <!-- İçerik -->
  <main class="hero">
    <section class="panel hero-panel" aria-labelledby="welcome">
      <h1 id="welcome" class="title gx" data-i18n="brand.slogan">Takas Çemberi’ne Hoş Geldiniz</h1>
      <p class="subtitle gx-sub" data-i18n="brand.sub">Evinizdeki eşyaları değerinde takas edin, atığı azaltın, birlikte kazanın.</p>
    </section>

    <section class="slogan" aria-live="polite" data-i18n="slogan.inline">Doğaya • Bütçene • Dost</section>
  </main>

  <!-- İLANLAR -->
  <section class="panel" id="ads" aria-labelledby="ads-title" style="margin:12px auto;max-width:1200px;padding:16px">
    <h2 id="ads-title" style="margin:0 0 12px" data-i18n="sec.newlistings">Yeni İlanlar</h2>
    <div class="ads-grid" id="adsGrid" role="list"></div>
  </section>

  <!-- Kategoriler + Özellikler -->
  <section class="panel" aria-labelledby="cats-title" style="margin:12px auto;max-width:1200px;padding:24px 16px">
    <h2 id="cats-title" style="margin-bottom:12px;text-align:center" data-i18n="sec.categories">Kategoriler</h2>
    <div class="grid" role="list">
      <a class="card" role="listitem" href="/search.html?cat=ev-hobi"><div class="emoji">🏠</div><h3 data-i18n="cat.home">Ev & Hobi</h3><p data-i18n="cat.home.desc">Ev eşyaları, hobi ürünleri</p></a>
      <a class="card" role="listitem" href="/search.html?cat=tasinmaz"><div class="emoji">🏡</div><h3 data-i18n="cat.real">Taşınmaz</h3><p data-i18n="cat.real.desc">Ev, arsa, tarla</p></a>
      <a class="card" role="listitem" href="/search.html?cat=tasit"><div class="emoji">🚗</div><h3 data-i18n="cat.auto">Motorlu Taşıtlar</h3><p data-i18n="cat.auto.desc">Araba, motosiklet, yedek parça</p></a>
      <a class="card" role="listitem" href="/search.html?cat=oyuncak"><div class="emoji">🧸</div><h3 data-i18n="cat.toy">Oyuncak</h3><p data-i18n="cat.toy.desc">Her yaşa uygun oyuncaklar</p></a>
      <a class="card" role="listitem" href="/search.html?cat=giyim"><div class="emoji">👗</div><h3 data-i18n="cat.fashion">Giyim</h3><p data-i18n="cat.fashion.desc">Kadın, erkek, çocuk</p></a>
      <a class="card" role="listitem" href="/search.html?cat=beyaz-esya"><div class="emoji">⚡</div><h3 data-i18n="cat.appliance">Beyaz Eşya</h3><p data-i18n="cat.appliance.desc">Ev aletleri, mutfak</p></a>
      <a class="card" role="listitem" href="/search.html?cat=teknoloji"><div class="emoji">💻</div><h3 data-i18n="cat.tech">Teknoloji</h3><p data-i18n="cat.tech.desc">Bilgisayar, telefon</p></a>
      <a class="card" role="listitem" href="/search.html?cat=mobilya"><div class="emoji">🛋️</div><h3 data-i18n="cat.furniture">Mobilya</h3><p data-i18n="cat.furniture.desc">Koltuk, masa, dolap</p></a>
    </div>

    <div class="features" style="margin-top:18px">
      <div class="feature" data-i18n="feat.safe">✅ Güvenli Takas<br/>SSL ve KVKK güvencesiyle güvenli işlemler.</div>
      <div class="feature" data-i18n="feat.easy">📱 Kolay Kullanım<br/>Mobil uyumlu arayüz ile her yerde ilan ver.</div>
      <div class="feature" data-i18n="feat.support">💬 Canlı Destek<br/>7/24 destek ekibi seninle.</div>
    </div>
  </section>

  <!-- Alt Bar -->
  <nav class="bottom-nav" aria-label="Alt menü">
    <button class="tab active" id="tabHome" aria-current="page" data-i18n-aria-label="nav.home" aria-label="Ana Sayfa">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9.5L12 3l9 6.5"/><path d="M5 10v10h5v-6h4v6h5V10"/>
      </svg>
      <span style="font-size:12px" data-i18n="nav.home.txt">Ana Sayfa</span>
    </button>
    <button class="tab" id="tabMessages" data-i18n-aria-label="nav.messages" aria-label="Mesajlar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12a8.5 8.5 0 0 1-8.5 8.5H7l-4 3 1.5-5.5A8.5 8.5 0 1 1 21 12z"/>
      </svg>
      <span style="font-size:12px; position:relative" data-i18n="nav.messages.txt">
        Mesajlar
        <b id="msgBadge" class="badge" aria-live="polite">0</b>
      </span>
    </button>
    <button class="tab" id="tabNotifs" data-i18n-aria-label="nav.notifications" aria-label="Bildirimler">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M6 8a6 6 0 1 1 12 0c0 7 3 5 3 9H3c0-4 3-2 3-9"/><path d="M9 21h6"/>
      </svg>
      <span style="font-size:12px; position:relative" data-i18n="nav.notifications.txt">
        Bildirimler
        <b id="notifBadge" class="badge" aria-live="polite">0</b>
      </span>
    </button>
  </nav>

  <!-- Canlı Destek (compact, yukarı açılır) -->
  <button class="support-fab compact" id="btnSupport" aria-label="Canlı Destek" data-i18n-aria-label="support.open">
    <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M8 13a3 3 0 0 0 3 3h1l4 3-.5-3.5"></path>
    </svg>
  </button>

  <div class="support-pop pro" id="supportPop" role="dialog" aria-modal="true" aria-live="polite" aria-label="Canlı Destek">
    <div class="sup-head">
      <strong data-i18n="support.title">Canlı Destek</strong>
      <button id="supClose" class="sup-close" type="button" aria-label="Pencereyi kapat" data-i18n-aria-label="support.close">×</button>
    </div>
    <div class="sup-body"></div>
    <div class="sup-input">
      <input id="chatInput" class="sup-in" placeholder="Mesajınızı yazın…" data-i18n-placeholder="support.placeholder" />
      <button id="chatSend" class="sup-send" type="button" aria-label="Gönder" data-i18n-aria-label="support.send">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 2L11 13"></path><path d="M22 2l-7 20-4-9-9-4 20-7Z"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Alt Siyah Hukuki Alan -->
  <footer class="legal">
  <div class="wrap" style="display:flex;flex-wrap:wrap;gap:14px;justify-content:center">
    <a href="/legal/hakkimizda.html" data-i18n="legal.about">Hakkımızda</a>
    <a href="/legal/iletisim.html" data-i18n="legal.contact">İletişim</a>
    <a href="/legal/gizlilik.html" data-i18n="legal.privacy">Gizlilik</a>
    <a href="/legal/kullanim-sartlari.html" data-i18n="legal.tos">Kullanım Şartları</a>
    <a href="/legal/kvkk.html" data-i18n="legal.kvkk">KVKK Aydınlatma</a>
    <a href="/legal/mesafeli-satis-sozlesmesi.html" data-i18n="legal.distance">Mesafeli Satış Sözleşmesi</a>
    <a href="/legal/teslimat-iade.html" data-i18n="legal.shipping">Teslimat & İade</a>
  </div>
  <div class="wrap" style="text-align:center;color:#a8acc4;margin-top:8px">
    © 2025 Takas Çemberi — <span data-i18n="footer.slogan">milli sermayeyi koru, atığı azalt</span> ♻️
  </div>
</footer>

  <!-- Global bildirim sesi -->
  <audio id="notifySoundGlobal" preload="auto">
    <source src="/assets/sounds/notify.wav" type="audio/wav">
    <source src="/sounds/notify.wav" type="audio/wav">
  </audio>

  <!-- Firebase init -->
  <script type="module" src="assets/js/firebase-init.js"></script>
  <script>
    window.__fb?.startGlobalMessagingWatcher?.();
  </script>

  <!-- Sayfa mantığı -->
  <script type="module">
    const { auth, db, requireAuth } = window.__fb;
    requireAuth();

    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { collection, query, where, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ===== Audio güvenli oynatım ===== */
    let audioReady = false;
    const enableAudio = ()=>{ audioReady = true; };
    ['pointerdown','keydown','touchstart'].forEach(ev=>window.addEventListener(ev, enableAudio, {passive:true}));
    function playSoundSafe(){
      const tag = document.getElementById('notifySoundGlobal');
      if(!tag) return;
      if(document.visibilityState === 'visible' && audioReady){
        try{ tag.currentTime = 0; const p = tag.play(); if(p && p.catch) p.catch(()=>{}); }catch{}
      }
    }

    /* ===== İlanları çek ===== */
    async function loadAds(){
      const grid = document.getElementById("adsGrid");
      if(!grid) return;
      try {
        const q = query(collection(db,"listings"), where("isApproved","==", true), limit(20));
        const snap = await getDocs(q);

        if(snap.empty){
          grid.innerHTML = '<div style="grid-column:1/-1;color:#64748b" data-i18n="ads.none">Henüz ilan yok</div>';
          return;
        }

        grid.innerHTML = "";
        snap.forEach(doc=>{
          const d = doc.data() || {};
          const cover = d.photos?.[0] || "/assets/img/seffaf.png";
          const title = d.title || "İlan";
          const city  = d.city  || "";
          const cond  = d.cond  || "";

          grid.innerHTML += `
  <div class="ad-card" data-id="${doc.id}">
    <div class="ad-media">
      <img src="${cover}" alt="${title}" loading="lazy" decoding="async">
    </div>
    <div class="ad-body">
      <h3 class="ad-title">${title}</h3>
      <div class="ad-meta"><span>${city}</span><span>${cond}</span></div>
      <div class="ad-actions">
        <button type="button" class="btn-view"  data-id="${doc.id}" data-i18n="ads.view">İncele</button>
        <button type="button" class="btn-offer" data-id="${doc.id}" data-owner="${d.ownerId || d.uid || ''}" data-i18n="ads.offer">Teklif ver</button>
      </div>
    </div>
  </div>`;
        });

      } catch(err){
        console.error("İlan yükleme hatası:", err);
        grid.innerHTML = `<div style="grid-column:1/-1;color:#ef4444" data-i18n="ads.error">İlanlar yüklenemedi</div>`;
      }
    }
    window.loadAds = loadAds;

    onAuthStateChanged(auth, async (user) => {
      const grid = document.getElementById("adsGrid");
      if (!user) {
        if (grid) grid.innerHTML = '<div style="grid-column:1/-1;color:#64748b" data-i18n="ads.login">İlanları görmek için giriş yapın</div>';
        return;
      }
      try { await window.__fb?.upsertPublicProfile?.(user); } catch {}
      await user.getIdToken(true);
      await loadAds();
    });

    /* ===== Kart tıklama + butonlar ===== */
    const adsGridEl = document.getElementById("adsGrid");
    adsGridEl?.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button');
      if (btn) {
        const id = btn.dataset.id;
        if (btn.classList.contains('btn-view')) {
          location.href = `/ilan/index.html?id=${encodeURIComponent(id)}`;
          return;
        }
        if (btn.classList.contains('btn-offer')) {
          const owner = btn.dataset.owner || "";
          if (!owner) { alert("İlan sahibi bilgisi eksik."); return; }
          openOfferFlow(id, owner);
          return;
        }
      }
      const card = ev.target.closest('.ad-card');
      if (card && !ev.target.closest('.ad-actions')) {
        const id = card.dataset.id;
        location.href = `/ilan/index.html?id=${encodeURIComponent(id)}`;
      }
    });

    /* ===== Teklif akışı ===== */
    async function findMyListings(uid){
      const { collection, query, where, limit, getDocs } =
        await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const mine = [];
      let q1 = query(collection(db,'listings'), where('ownerId','==', uid), limit(20));
      let s1 = await getDocs(q1); s1.forEach(d=>mine.push({id:d.id, ...d.data()}));
      if(mine.length===0){
        let q2 = query(collection(db,'listings'), where('uid','==', uid), limit(20));
        let s2 = await getDocs(q2); s2.forEach(d=>mine.push({id:d.id, ...d.data()}));
      }
      return mine;
    }

    async function openOfferFlow(targetListingId, targetOwnerUid){
      const user = auth.currentUser;
      if(!user){ alert("Teklif vermek için giriş yapın."); return; }

      const mine = await findMyListings(user.uid);
      if(mine.length===0){
        if(confirm("Teklif verebilmek için en az bir ilanınız olmalı. İlan ver sayfasına gidelim mi?")){
          location.href = "/ilan/ilan-verme.html";
        }
        return;
      }

      let pick = 0;
      if(mine.length>1){
        const list = mine.map((m,i)=>`${i+1}) ${m.title||m.id}`).join('\n');
        const ans = prompt("Hangi ilanla teklif vermek istiyorsunuz?\n" + list + "\nNumara girin:", "1");
        const idx = Math.max(1, Math.min(mine.length, parseInt(ans||"1",10))) - 1;
        pick = isNaN(idx) ? 0 : idx;
      }
      const myListingId = mine[pick].id;
      const msg = prompt("Mesaj (opsiyonel):", "") || "";

      const { collection, addDoc, serverTimestamp } =
        await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

      const offer = {
        fromUid: user.uid,
        toUid:   targetOwnerUid,
        fromListingId: myListingId,
        createdAt: serverTimestamp(),
        message: msg,
        status: 'pending'
      };

      try{
        const offerRef = await addDoc(collection(db,'listings', targetListingId, 'offers'), offer);

        const { collection: coll2, addDoc: add2, serverTimestamp: ts } =
          await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

        await add2(
          coll2(db, 'users', targetOwnerUid, 'inbox'),
          {
            toUid: targetOwnerUid,
            fromUid: user.uid,
            type: 'offer',
            title: 'Yeni teklif',
            body: (msg && msg.trim()) ? msg.trim() : 'Bir teklifiniz var.',
            listingId: targetListingId,
            offerId: offerRef.id,
            link: `/ilan/index.html?id=${encodeURIComponent(targetListingId)}`,
            createdAt: ts(),
            read: false
          }
        );

        alert("Teklif gönderildi ✅");
      }catch(e){
        console.error("Teklif gönderilemedi:", e);
        alert("Teklif gönderilemedi: " + (e.code||"hata"));
      }
    }

    /* ===== Bana gelen teklifleri dinle ===== */
    let _offerUnsubs = [];
    async function watchOffersForMe(uid){
      _offerUnsubs.forEach(u=>{ try{u()}catch{} });
      _offerUnsubs = [];

      const { collection, onSnapshot } =
        await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");

      const myListings = await findMyListings(uid);
      const firstLoadMap = new Map(); // listingId => firstLoadDone

      myListings.forEach(m=>{
        const offRef = collection(db, 'listings', m.id, 'offers');
        const unsub = onSnapshot(offRef, (snap)=>{
          const firstSeen = firstLoadMap.get(m.id) === true ? false : true;
          if(firstSeen){
            firstLoadMap.set(m.id, true); // ilk açılışta ping yok
            return;
          }
          snap.docChanges().forEach(ch=>{
            const d = ch.doc.data();
            if(ch.type==='added' && d?.toUid === uid){
              playSoundSafe();
              const note = document.createElement('div');
              note.style.cssText = "position:fixed;right:16px;bottom:90px;background:#111827;color:#fff;padding:10px 12px;border-radius:10px;z-index:1000";
              note.textContent = `Yeni teklif! Gönderen: ${(d.fromUid||'').slice(0,6)}`;
              document.body.appendChild(note);
              setTimeout(()=>note.remove(), 2500);
            }
          });
        }, (e)=>console.warn('offer watch err', e));
        _offerUnsubs.push(unsub);
      });
    }
    onAuthStateChanged(auth, (u)=>{ if(u) watchOffersForMe(u.uid); });

    /* ===== Üst bar + Alt bar ===== */
    const $ = (s,r=document)=>r.querySelector(s);
    $('#btnLogout')?.addEventListener('click', async ()=>{
      try{ await signOut(auth);}catch{}
      location.href="/";
    });
    $('#btnProfile')?.addEventListener('click', ()=>location.href="/profile/profile.html");
    $('#btnPostAd')?.addEventListener('click', ()=>location.href="/ilan/ilan-verme.html");
    $('#btnSearch')?.addEventListener('click', ()=>location.href="/search.html");

    const tabs=[$('#tabHome'),$('#tabMessages'),$('#tabNotifs')].filter(Boolean);
    tabs.forEach(t=>t.addEventListener('click',()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      if(t.id==='tabHome') location.href="/home.html";
      if(t.id==='tabMessages') location.href="/messages.html";
      if(t.id==='tabNotifs') location.href="/notifications.html";
    }));
  </script>

  <!-- DUYURULAR (Broadcasts) -->
  <script type="module">
    import { getFirestore, collection, query, orderBy, limit, onSnapshot }
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const db = (window.__fb && window.__fb.db) || getFirestore();

    let panel = document.getElementById("broadcastsPanel");
    if (!panel) {
      panel = document.createElement("section");
      panel.className = "panel";
      panel.id = "broadcastsPanel";
      panel.style.cssText = "margin:12px auto;max-width:1200px;padding:16px;display:none";
      panel.innerHTML = `
        <h2 style="margin:0 0 12px" data-i18n="sec.announcements">Duyurular</h2>
        <div id="bcList" style="display:grid;gap:8px"></div>
      `;
      const adsPanel = document.getElementById("ads");
      if (adsPanel?.parentNode) {
        adsPanel.parentNode.insertBefore(panel, adsPanel);
      } else {
        document.body.appendChild(panel);
      }
    }

    const listEl = panel.querySelector("#bcList");
    const esc = s => String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));

    onSnapshot(
      query(collection(db, "broadcasts"), orderBy("createdAt", "desc"), limit(5)),
      snap => {
        if (snap.empty) { panel.style.display = "none"; return; }
        panel.style.display = "";
        listEl.innerHTML = "";
        snap.forEach(d => {
          const v = d.data() || {};
          const when = v.createdAt?.toDate ? v.createdAt.toDate().toLocaleString("tr-TR") : "";
          const item = document.createElement("div");
          item.style.cssText = "border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;background:#fff";
          item.innerHTML = `
            <div style="font-weight:700">${esc(v.title || "Duyuru")}</div>
            <div style="white-space:pre-wrap;margin-top:4px">${esc(v.body || "")}</div>
            <div style="color:#64748b;font-size:12px;margin-top:6px">
              <span data-i18n="ann.from">Gönderici</span>: ${esc(v.sender || "admin")} • ${esc(when)}
            </div>
          `;
          listEl.appendChild(item);
        });
      },
      err => { console.warn("broadcasts dinleme hatası:", err); panel.style.display = "none"; }
    );
  </script>

  <!-- Canlı destek: sadece aç/kapat (Firebase’e bağlı değil) -->
  <script>
    (function () {
      const btn   = document.getElementById('btnSupport');
      const pop   = document.getElementById('supportPop');
      const close = document.getElementById('supClose');

      if (!btn || !pop) return;

      function openPop(){ pop.classList.add('show'); }
      function closePop(){ pop.classList.remove('show'); }

      btn.addEventListener('click', openPop);
      close?.addEventListener('click', closePop);
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closePop(); });
    })();
  </script>
  <script type="module">
  const { auth, db } = window.__fb || {};
  import {
    doc, setDoc, addDoc, collection, serverTimestamp,
    onSnapshot, orderBy, query, limit
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const pop      = document.getElementById('supportPop');
  const bodyEl   = pop?.querySelector('.sup-body');
  const inputEl  = document.getElementById('chatInput');
  const sendBtn  = document.getElementById('chatSend');

  function append(text, me=false){
    if(!bodyEl) return;
    const p = document.createElement('p');
    p.className = 'msg' + (me ? ' me' : '');
    p.textContent = text;
    bodyEl.appendChild(p);
    bodyEl.scrollTop = bodyEl.scrollHeight;
  }

  async function sendSupport(){
    const txt = (inputEl?.value || '').trim();
    if(!txt) return;
    const user = auth?.currentUser;
    if(!user){ location.href = "/auth.html?next=/"; return; }

    // Önce UI'da göster
    append(txt, true);
    inputEl.value = '';

    // Thread üst belgesi (liste/izinler için)
    await setDoc(doc(db, 'supportThreads', user.uid), {
      participants: [user.uid],
      lastAt: serverTimestamp(),
      lastMsg: txt,
      lastSenderUid: user.uid
    }, { merge: true });

    // Mesajı alt koleksiyona yaz
    await addDoc(collection(db, 'supportThreads', user.uid, 'messages'), {
      senderUid: user.uid,
      text: txt,
      createdAt: serverTimestamp(),
      page: location.pathname
    });
  }

  // Gönder butonu + Enter
  sendBtn?.addEventListener('click', sendSupport);
  inputEl?.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      sendSupport();
    }
  });

  // Admin yanıtlarını canlı göster (kullanıcı login ise)
  onAuthStateChanged(auth, (u)=>{
    if(!u || !bodyEl) return;
    const q = query(
      collection(db, 'supportThreads', u.uid, 'messages'),
      orderBy('createdAt','asc'),
      limit(200)
    );
    onSnapshot(q, (snap)=>{
      bodyEl.innerHTML = '';
      if(snap.empty){ append('Merhaba! Nasıl yardımcı olalım?'); return; }
      snap.forEach(ms=>{
        const m = ms.data() || {};
        append(m.text || '', m.senderUid === u.uid);
      });
    });
  });
</script>

  <!-- i18n (EKLENDİ) -->
  <script type="module" src="/assets/js/i18n.js"></script>
</body>
</html>
