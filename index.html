<!doctype html>
<html lang="tr">
<head>
<link rel="icon" type="image/png" href="favicon.png">
<link rel="icon" href="favicon.ico">

<style>.hd img.logo{height:57px}</style>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GiriÅŸ / KayÄ±t â€¢ Takas Ã‡emberi</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{ --txt:#0a0a0a; --muted:#5b6b8f; --stroke:#e5e9f5; --ok:#22c55e; --err:#ef4444; }
*{box-sizing:border-box}html,body{margin:0;padding:0}
body{
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif; color:var(--txt);
  background:linear-gradient(135deg,#e0f7fa,#f0f9ff,#ecfdf5,#fff0f6);
  background-size:400% 400%; animation:gradmove 20s ease infinite;
  min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:20px;
}
@keyframes gradmove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.card{width:min(640px,100%);background:#ffffffee;border:1px solid var(--stroke);border-radius:22px;box-shadow:0 30px 80px #0003;overflow:hidden;position:relative}
.close{position:absolute;top:10px;right:10px;border:none;background:#ffffffc9;border:1px solid #eaeef6;padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:800}
.close:hover{transform:translateY(-1px);box-shadow:0 6px 14px #0002}
.hd{display:flex;gap:12px;align-items:center;justify-content:center;padding:18px;border-bottom:1px solid var(--stroke);background:linear-gradient(135deg,#06b6d4,#8b5cf6);color:#fff}
.hd img{height:34px}
.tabs{display:flex;gap:8px;justify-content:center;padding:12px;border-bottom:1px solid var(--stroke);background:#f8fafc}
.tab{padding:10px 14px;border-radius:999px;border:1px solid #e5e9f5;background:#fff;cursor:pointer;font-weight:800}
.tab.active{background:linear-gradient(135deg,#06b6d4,#22c55e);color:#001019;border-color:transparent}
.pane{display:none;padding:22px}
.pane.active{display:block}
.h1{font-size:20px;font-weight:800;margin:0 0 6px 0}
.sub{margin:0 0 14px 0;color:#475569}
label{display:grid;gap:6px;font-weight:600;margin-top:10px}
input{padding:12px 14px;border:1px solid #c7d2fe;border-radius:12px;outline:none;background:#fff}
input:focus{border-color:#60a5fa}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.actions{display:flex;gap:10px;margin-top:14px}
.btn{padding:12px 16px;border-radius:12px;border:0;font-weight:800;cursor:pointer}
.btn.primary{background:linear-gradient(135deg,#06b6d4,#22c55e);color:#00101a}
.btn.ghost{background:#eef2ff;color:#111827;border:1px solid #dbeafe}
.btn.google{background:#fff;border:1px solid #e5e7eb}
.note{font-size:13px;color:#64748b;margin-top:6px}
.status{min-height:22px;margin-top:10px;font-size:14px;color:#64748b}
.err{color:var(--err)} .ok{color:var(--ok)}
.footer-mini{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-top:1px solid var(--stroke);background:#fafbff;color:#64748b;font-size:13px}
.footer-mini a{color:#64748b;text-decoration:none;font-weight:700}
@media (max-width:520px){.row{grid-template-columns:1fr}}

/* TERMS MODAL */
.terms-back{position:fixed;inset:0;background:#0b102080;display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
.terms{width:min(720px,100%);background:#fff;border-radius:18px;box-shadow:0 30px 80px #0004;overflow:hidden;border:1px solid var(--stroke)}
.terms .hd{padding:16px 20px;background:linear-gradient(135deg,#06b6d4,#22c55e);color:#fff;font-weight:800}
.terms .bd{padding:16px 20px;color:#334155;max-height:60dvh;overflow:auto}
.terms .ft{padding:14px 20px;display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--stroke);background:#f9fafb}
.terms .chk{display:flex;gap:10px;align-items:flex-start;margin-top:10px}
</style>
</head>
<body>
<div class="card">
  <button class="close" id="btnClose">âœ•</button>
  <div class="hd"><img class="logo" src="assets/img/seffaf.png" alt="Takas Ã‡emberi Logo"><b>Takas Ã‡emberi</b> â€¢ YÃœKLE, TAKASLA, KAZAN!</div>

  <div class="tabs">
    <button class="tab active" id="tabLogin">GiriÅŸ Yap</button>
    <button class="tab" id="tabSignup">Kaydol</button>
  </div>

  <!-- GiriÅŸ -->
  <section class="pane active" id="paneLogin">
    <h2 class="h1">GiriÅŸ Yap</h2>
    <label>E-posta
      <input type="email" id="li_email" placeholder="ornek@eposta.com" required>
    </label>
    <label>Åifre
      <input type="password" id="li_pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
    </label>
    <div class="actions">
      <button class="btn primary" id="btnSignIn">GiriÅŸ yap</button>
      <button class="btn ghost" id="btnForgot">Åifremi unuttum</button>
    </div>
    <div class="actions" style="margin-top:8px">
      <button class="btn google" id="btnGoogle">Google ile devam et</button>
    </div>
    <div id="li_status" class="status"></div>
  </section>

  <!-- KayÄ±t -->
  <section class="pane" id="paneSignup">
    <h2 class="h1">Hesap OluÅŸtur</h2>
    <p class="sub">E-posta doÄŸrulamasÄ± ÅŸarttÄ±r; doÄŸrulama yapÄ±lmadan giriÅŸ mÃ¼mkÃ¼n deÄŸildir. 
    KayÄ±t sonrasÄ± doÄŸrulama e-postasÄ± spam klasÃ¶rÃ¼nÃ¼ze dÃ¼ÅŸebilir, lÃ¼tfen kontrol edin.</p>

    <div class="row">
      <label>Ä°sim Soyisim
        <input type="text" id="su_name" placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z" required>
      </label>
      <label>KullanÄ±cÄ± AdÄ±
        <input type="text" id="su_uname" placeholder="kullanici_adi" required>
      </label>
    </div>
    <div class="row">
      <label>Åehir
        <input type="text" id="su_city" placeholder="Åehir" required>
      </label>
      <label>Telefon
        <input type="tel" id="su_phone" placeholder="05xx xxx xx xx" required>
      </label>
    </div>
    <label>E-posta
      <input type="email" id="su_email" placeholder="ornek@eposta.com" required>
    </label>
    <div class="row">
      <label>Åifre
        <input type="password" id="su_pass" placeholder="En az 6 karakter" required>
      </label>
      <label>Åifre (Tekrar)
        <input type="password" id="su_pass2" placeholder="Tekrar" required>
      </label>
    </div>
    <div class="actions">
      <button class="btn primary" id="btnSignUp">Kaydol</button>
    </div>
    <div id="su_status" class="status"></div>
  </section>

  <div class="footer-mini">
    <span>Â© <span id="y"></span> Takas Ã‡emberi</span>
    <a href="index.html">Ana sayfaya dÃ¶n â†’</a>
  </div>
</div>

<!-- KVKK & GÃ¼venlik ModalÄ± -->
<div class="terms-back" id="termsModal">
  <div class="terms">
    <div class="hd">KayÄ±t Ã–ncesi Onay</div>
    <div class="bd">
      <p><b>KayÄ±t ile birlikte KVKK ve KullanÄ±m ÅartlarÄ±'nÄ± kabul etmiÅŸ olursunuz.</b><br>
      E-posta doÄŸrulamasÄ± ÅŸarttÄ±r; doÄŸrulama yapÄ±lmadan giriÅŸ mÃ¼mkÃ¼n deÄŸildir. 
      KayÄ±t sonrasÄ± doÄŸrulama e-postasÄ± <b>spam klasÃ¶rÃ¼nÃ¼ze</b> dÃ¼ÅŸebilir, lÃ¼tfen kontrol edin.</p>
      <ul>
        <li>âš ï¸ Kapora, peÅŸinat, havale vb. Ã¶demeler talep etmeyiniz / etmeyin.</li>
        <li>ğŸ’³ Kapora, peÅŸinat vb. Ã¶demelerden <b>takascemberi.com</b> sorumlu deÄŸildir.</li>
        <li>ğŸ”’ KiÅŸisel bilgilerinizi (TC kimlik, IBAN, ÅŸifre vb.) paylaÅŸmayÄ±nÄ±z.</li>
        <li>ğŸ›¡ï¸ ÅÃ¼pheli veya sahte iÅŸlemleri destek ekibimize bildiriniz.</li>
        <li>ğŸ¤ <b>takascemberi.com ailesi</b> olarak gÃ¼venli, keyifli ve mutlu takaslar dileriz.</li>
      </ul>
      <label class="chk"><input type="checkbox" id="termsChk"> YukarÄ±daki bilgilendirmeyi okudum ve kabul ediyorum.</label>
    </div>
    <div class="ft">
      <button class="btn ghost" id="termsCancel">VazgeÃ§</button>
      <button class="btn primary" id="termsAccept" disabled>KaydÄ± Onayla ve Devam Et</button>
    </div>
  </div>
</div>

<script type="module">
  import { app, auth, db } from './js/firebase-config.js';
  import {
    signInWithEmailAndPassword, createUserWithEmailAndPassword,
    sendEmailVerification, sendPasswordResetEmail,
    GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged,
    setPersistence, browserLocalPersistence
  } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
  import { doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';

  const $ = (s)=>document.querySelector(s);
  const liStatus = $('#li_status');
  const suStatus = $('#su_status');
  const tabLogin = $('#tabLogin');
  const tabSignup = $('#tabSignup');
  const paneLogin = $('#paneLogin');
  const paneSignup = $('#paneSignup');

  function setMsg(el,msg,type){ el.textContent=msg||''; el.className='status '+(type||''); }
  function errText(err){
    const c=err?.code||'';
    if(c.includes('unauthorized-domain')) return 'Yetkisiz alan adÄ±: Firebase â†’ Authentication â†’ Settings â†’ Authorized domains bÃ¶lÃ¼mÃ¼ne site alan adÄ±nÄ± ekleyin.';
    if(c.includes('email-already-in-use')) return 'Bu e-posta ile hesap zaten var.';
    if(c.includes('invalid-credential')) return 'E-posta veya ÅŸifre hatalÄ±.';
    if(c.includes('weak-password')) return 'Åifre en az 6 karakter olmalÄ±.';
    if(c.includes('too-many-requests')) return 'Ã‡ok fazla deneme. Biraz sonra tekrar deneyin.';
    return 'Hata: '+(err?.message||c);
  }

  function activate(tab){
    const toSignup = tab==='signup';
    tabLogin.classList.toggle('active',!toSignup);
    tabSignup.classList.toggle('active',toSignup);
    paneLogin.classList.toggle('active',!toSignup);
    paneSignup.classList.toggle('active',toSignup);
  }

  // Sekmeler
  tabLogin.addEventListener('click',()=>activate('login'));
  tabSignup.addEventListener('click',()=>activate('signup'));
  if(location.hash==='#signup') activate('signup');

  // X kapatma â†’ ana sayfa
  document.getElementById('btnClose').addEventListener('click',()=>{location.href='index.html';});

  // yÃ¶nlendirme yardÄ±mcÄ±larÄ±
  const params = new URLSearchParams(location.search);
  const next = params.get('next');
  const go = () => {
    const target = (next && /^\/?[\w\-]+\.html$/.test(next)) ? next : 'home.html';
    location.href = target;
  };

  // KalÄ±cÄ± oturum (local)
  (async () => {
    try { await setPersistence(auth, browserLocalPersistence); }
    catch(e) { console.warn('Persistence set error:', e); }
  })();

  // #signup ile gelindiyse otomatik yÃ¶nlendirme yapma; banner gÃ¶ster
  const signupNotice = (() => {
    const el = document.createElement('div');
    el.style.cssText = 'margin:12px 0;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;';
    el.innerHTML = `
      Zaten giriÅŸ yaptÄ±nÄ±z. Yeni bir hesap oluÅŸturmak istiyorsanÄ±z
      <button id="btnSwitch" class="btn ghost" style="margin-left:8px">Ã‡Ä±kÄ±ÅŸ yap ve yeni hesap oluÅŸtur</button>
    `;
    el.querySelector('#btnSwitch')?.addEventListener('click', async () => {
      try { await signOut(auth); } catch(_) {}
      if (location.hash !== '#signup') location.hash = '#signup';
      el.remove();
      activate('signup');
      setMsg(suStatus,'Yeni hesap oluÅŸturmak iÃ§in bilgileri doldurun.','ok');
    });
    return el;
  })();

  onAuthStateChanged(auth, (user) => {
    const onSignup = (location.hash === '#signup');
    if (user && user.emailVerified) {
      if (onSignup) {
        // KayÄ±t ekranÄ±na bilerek gelen kullanÄ±cÄ±yÄ± otomatik taÅŸÄ±mÄ±yoruz
        const target = document.querySelector('#paneSignup');
        if (target && !target.contains(signupNotice)) {
          target.appendChild(signupNotice);
        }
      } else {
        // Normalde giriÅŸliyse login sayfasÄ±nda bekletme
        go();
      }
    }
  });

  // GiriÅŸ (email/ÅŸifre)
  $('#btnSignIn').addEventListener('click',async()=>{
    const email=$('#li_email').value.trim(), pass=$('#li_pass').value;
    if(!email||!pass) return setMsg(liStatus,'E-posta ve ÅŸifre gerekli.','err');
    try{
      const {user}=await signInWithEmailAndPassword(auth,email,pass);
      if(!user.emailVerified){await signOut(auth);return setMsg(liStatus,'E-posta doÄŸrulanmadÄ±. Mail kutunu kontrol et.','err');}
      setMsg(liStatus,'GiriÅŸ baÅŸarÄ±lÄ±. Ana sayfaya gidiliyorâ€¦','ok'); 
      go();
    }catch(e){setMsg(liStatus,errText(e),'err');}
  });

  // Åifre sÄ±fÄ±rlama
  $('#btnForgot').addEventListener('click',async()=>{
    const email=$('#li_email').value.trim();
    if(!email) return setMsg(liStatus,'SÄ±fÄ±rlama iÃ§in e-posta gir.','err');
    try{await sendPasswordResetEmail(auth,email);setMsg(liStatus,'SÄ±fÄ±rlama e-postasÄ± gÃ¶nderildi.','ok');}
    catch(e){setMsg(liStatus,errText(e),'err');}
  });

  // Google ile giriÅŸ (hesap seÃ§tir)
  $('#btnGoogle').addEventListener('click',async()=>{
    try{
      const prov=new GoogleAuthProvider();
      prov.setCustomParameters({ prompt: 'select_account' });
      const res=await signInWithPopup(auth,prov);
      if(res?.user && res.user.emailVerified !== false){
        go();
      } else {
        go();
      }
    }catch(e){setMsg(liStatus,errText(e),'err');}
  });

  // KayÄ±t akÄ±ÅŸÄ±
  function collectSignup(){
    const d={name:$('#su_name').value.trim(), uname:$('#su_uname').value.trim(),
             city:$('#su_city').value.trim(), phone:$('#su_phone').value.trim(),
             email:$('#su_email').value.trim(), p1:$('#su_pass').value, p2:$('#su_pass2').value};
    if(!d.name||!d.uname||!d.city||!d.phone||!d.email||!d.p1||!d.p2){setMsg(suStatus,'TÃ¼m alanlar zorunlu.','err');return null;}
    if(d.p1!==d.p2){setMsg(suStatus,'Åifreler aynÄ± deÄŸil.','err');return null;}
    if(d.p1.length<6){setMsg(suStatus,'Åifre en az 6 karakter olmalÄ±.','err');return null;}
    return d;
  }
  async function performSignup(d){
    try{
      const {user}=await createUserWithEmailAndPassword(auth,d.email,d.p1);
      await setDoc(doc(db,'users',user.uid),{
        name:d.name,username:d.uname,city:d.city,phone:d.phone,email:d.email,
        createdAt:serverTimestamp(),role:'customer',isActive:true
      });
      await sendEmailVerification(user);
      setMsg(suStatus,'Hesap oluÅŸturuldu. DoÄŸrulama e-postasÄ± gÃ¶nderildi. (Spam klasÃ¶rÃ¼nÃ¼ kontrol et.)','ok');
      activate('login');
    }catch(e){setMsg(suStatus,errText(e),'err');}
  }

  // KayÄ±t butonu
  $('#btnSignUp').addEventListener('click', async ()=>{
    // EÄŸer giriÅŸliyse yeni kayÄ±t Ã¶ncesi uyar
    if (auth.currentUser) {
      activate('signup');
      const msg = 'Åu an zaten giriÅŸ yaptÄ±nÄ±z. Yeni bir hesap aÃ§mak iÃ§in Ã¶nce Ã§Ä±kÄ±ÅŸ yapÄ±n.';
      setMsg(suStatus, msg, 'err');
      const target = document.querySelector('#paneSignup');
      if (target && !target.contains(signupNotice)) target.appendChild(signupNotice);
      return;
    }
    const d=collectSignup(); if(!d) return;
    openTerms();
    const handler=async()=>{termsAccept.removeEventListener('click',handler);closeTerms();await performSignup(d);};
    termsAccept.addEventListener('click',handler);
  });

  // KVKK modal
  const termsModal=document.getElementById('termsModal');
  const termsChk=document.getElementById('termsChk');
  const termsAccept=document.getElementById('termsAccept');
  const termsCancel=document.getElementById('termsCancel');
  function openTerms(){termsModal.style.display='flex';termsChk.checked=false;termsAccept.disabled=true;}
  function closeTerms(){termsModal.style.display='none';}
  termsChk.addEventListener('change',()=>{termsAccept.disabled=!termsChk.checked;});
  termsCancel.addEventListener('click',closeTerms);
  termsModal.addEventListener('click',(e)=>{if(e.target===termsModal) closeTerms();});

  document.getElementById('y').textContent=new Date().getFullYear();
</script>
</body>
</html>
