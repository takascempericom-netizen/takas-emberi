<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bildirimler ‚Ä¢ Takas √áemberi</title>
  <style>
    :root{--c1:#7c3aed;--c2:#06b6d4;--c3:#10b981;--c4:#f59e0b;--fg:#0f172a;--glass:rgba(255,255,255,.78);--brd:rgba(255,255,255,.5)}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--fg);
      background:linear-gradient(120deg,var(--c1),var(--c2),var(--c3),var(--c4));background-size:300% 300%;animation:grad 18s ease infinite;min-height:100vh}
    @keyframes grad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .hdr{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.2);backdrop-filter:blur(10px);border-bottom:1px solid var(--brd)}
    .hdr .in{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    .ttl{margin:0;font-size:20px;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.25)}
    .row{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid var(--brd);background:var(--glass);color:#111827;font-weight:600;padding:8px 12px;border-radius:12px;cursor:pointer}
    .btn:hover{background:#fff}
    .btn.sm{padding:6px 10px;border-radius:10px;font-size:12px}
    .btn.danger{border-color:#fca5a5;color:#991b1b}

    .wrap{max-width:1100px;margin:16px auto 120px;padding:0 16px}
    .card{background:var(--glass);border:1px solid var(--brd);border-radius:20px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .list{padding:12px;display:grid;gap:8px}
    .item{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px;display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    .item.unread{border-color:#94a3b8;box-shadow:0 4px 16px rgba(15,23,42,.08)}
    .meta strong{display:block}
    .muted{font-size:12px;color:#64748b}
    .type{font-size:12px;padding:4px 8px;border-radius:10px;border:1px solid #e5e7eb;background:#f8fafc;display:inline-block}
    .type.offer{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
    .type.message{background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe}
    .type.broadcast{background:#dcfce7;color:#065f46;border-color:#bbf7d0}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .empty{padding:20px;text-align:center;color:#475569}

    /* Alt sabit bar + rozetler */
    .fixedbar{position:fixed;left:0;right:0;bottom:0;z-index:30}
    .fixedbar .in{max-width:1100px;margin:0 auto;padding:8px 12px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .fixedbar a{position:relative;display:flex;flex-direction:column;gap:2px;align-items:center;justify-content:center;padding:8px 6px;border-radius:14px;text-decoration:none;color:#111827;font-weight:600;border:1px solid var(--brd);background:var(--glass)}
    .fixedbar a.active{background:#111827;color:#fff;border-color:#111827}
    .fixedbar:before{content:"";position:absolute;inset:-20px 0 -20px 0;z-index:-1;background:linear-gradient(90deg,var(--c1),var(--c2),var(--c3),var(--c4));filter:blur(30px);opacity:.6}

    .badge{
      position:absolute; top:4px; right:10px;
      min-width:18px; height:18px; padding:0 6px;
      border-radius:999px; background:#ef4444; color:#fff;
      font-size:11px; display:none; place-items:center; line-height:18px;
    }
  </style>
</head>
<body>
  <header class="hdr">
    <div class="in">
      <h1 class="ttl">Bildirimler</h1>
      <div class="row">
        <button class="btn sm" id="btnMarkAll">T√ºm√ºn√º okundu i≈üaretle</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div id="status" class="empty">Y√ºkleniyor‚Ä¶</div>
      <div id="list" class="list" style="display:none"></div>
    </section>
  </main>

  <nav class="fixedbar">
    <div class="in">
      <a href="/" id="navHome">üè†<span>Ana Sayfa</span></a>

      <a href="/messages.html" id="navMsgs">
        üí¨<span>Mesajlar</span>
        <b id="msgBadge" class="badge" aria-live="polite">0</b>
      </a>

      <a href="/notifications.html" class="active" id="navNotifs">
        üîî<span>Bildirimler</span>
        <b id="notifBadge" class="badge" aria-live="polite">0</b>
      </a>

      <a href="/profile/profile.html" id="navProfile">üë§<span>Profil</span></a>
    </div>
  </nav>

  <!-- Global ses (ortak uyarƒ±) -->
  <audio id="notifySoundGlobal" preload="auto">
    <source src="/assets/sounds/notify.wav" type="audio/wav">
    <source src="/sounds/notify.wav" type="audio/wav">
  </audio>

  <!-- Sayfa i√ßi (liste) ses -->
  <audio id="ding" preload="auto">
    <source src="/assets/sounds/notify.wav" type="audio/wav">
  </audio>

  <!-- Firebase init (ortak) -->
  <script type="module" src="assets/js/firebase-init.js"></script>

  <!-- Sayfa scripti -->
  <script type="module">
    const { auth, db, requireAuth, startGlobalMessagingWatcher } = window.__fb || {};
    requireAuth && requireAuth(); // giri≈ü yoksa /auth.html

    // Bu sayfada global izleyiciyi de ba≈ülat (rozete ve sese yansƒ±sƒ±n)
    try { typeof startGlobalMessagingWatcher === 'function' && startGlobalMessagingWatcher(); } catch {}

    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      collection, query, orderBy, onSnapshot, doc, updateDoc, getDocs, where,
      setDoc, serverTimestamp, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const elList   = document.getElementById('list');
    const elStatus = document.getElementById('status');
    const btnAll   = document.getElementById('btnMarkAll');
    const ding     = document.getElementById('ding');

    // --- Beep fallback (WebAudio) ---
    function beep(duration=160, freq=880){
      try{
        const Actx = window.AudioContext || window.webkitAudioContext;
        const ac = new Actx();
        const o = ac.createOscillator();
        const g = ac.createGain();
        o.type='sine'; o.frequency.value=freq;
        o.connect(g); g.connect(ac.destination);
        g.gain.setValueAtTime(0.001, ac.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ac.currentTime + 0.01);
        o.start();
        setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + 0.04); o.stop(); ac.close(); }, duration);
      }catch{}
    }
    async function playDing(){
      try{ ding.currentTime = 0; await ding.play(); }catch{ beep(); }
    }

    // Alt bar linklerini .html ile sabitle
    document.getElementById('navHome')?.addEventListener('click', (e)=>{ e.preventDefault(); location.href = "/"; });
    document.getElementById('navMsgs')?.addEventListener('click', (e)=>{ e.preventDefault(); location.href = "/messages.html"; });
    document.getElementById('navNotifs')?.addEventListener('click', (e)=>{ e.preventDefault(); location.href = "/notifications.html"; });
    document.getElementById('navProfile')?.addEventListener('click', (e)=>{ e.preventDefault(); location.href = "/profile/profile.html"; });

    const fmt = (ts)=>{
      try{
        const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : new Date(ts));
        return isNaN(d) ? "‚Äî" : d.toLocaleString("tr-TR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
      }catch{ return "‚Äî"; }
    };

    let firstLoad = true;
    const known = new Set();

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ elStatus.textContent="L√ºtfen giri≈ü yapƒ±n."; elList.style.display="none"; return; }

      const inboxRef = collection(db, "users", user.uid, "inbox");
      const qInbox   = query(inboxRef, orderBy("createdAt","desc"));

      onSnapshot(qInbox, (snap)=>{
        if(snap.empty){
          elList.style.display="none";
          elStatus.style.display="block";
          elStatus.textContent="Bildirim yok.";
          firstLoad = false;
          return;
        }

        elList.innerHTML = "";
        snap.forEach(d=>{
          const data = d.data()||{};
          const div = document.createElement("div");
          div.className = "item" + (data.read ? "" : " unread");

          div.innerHTML = `
            <div class="meta">
              <div class="row" style="display:flex;gap:8px;align-items:center">
                <span class="type ${data.type||'message'}">${(data.type||'message').toUpperCase()}</span>
                <strong>${data.title||"Bildirim"}</strong>
              </div>
              <div class="muted">${data.body||""}</div>
              <div class="muted">${fmt(data.createdAt)}</div>
            </div>
            <div class="actions">
              ${data.read ? "" : `<button class="btn sm" data-act="read">Okundu</button>`}
              ${data.link ? `<a class="btn sm" href="${data.link}">Git</a>` : ""}

              ${data.fromUid && data.fromUid !== user.uid
                ? `<a class="btn sm" href="/profile/profile.html?uid=${encodeURIComponent(data.fromUid)}">Profil</a>
                   <button class="btn sm" data-act="chat" data-peer="${data.fromUid}">Mesaj yaz</button>`
                : ""}

              <button class="btn sm danger" data-act="del">Sil</button>
            </div>
          `;

          div.addEventListener("click", async (ev)=>{
            const readBtn = ev.target.closest("button[data-act='read']");
            const chatBtn = ev.target.closest("button[data-act='chat']");
            const delBtn  = ev.target.closest("button[data-act='del']");

            if (readBtn) {
              await updateDoc(doc(db,"users",user.uid,"inbox",d.id),{read:true});
              div.classList.remove("unread");
              return;
            }
            if (chatBtn) {
              const peerUid = chatBtn.dataset.peer;
              if (!peerUid || peerUid === user.uid) return;
              await openDirectChat(user.uid, peerUid);
              return;
            }
            if (delBtn) {
              if (!confirm("Bu bildirimi silmek istiyor musun?")) return;
              await deleteDoc(doc(db,"users",user.uid,"inbox",d.id));
              div.remove();
              return;
            }
          });

          elList.appendChild(div);

          // Yeni d√º≈üen ve okunmamƒ±≈üsa ses (ilk y√ºklemede √ßalma)
          if(!firstLoad && !data.read && !known.has(d.id)){
            playDing();
          }
          known.add(d.id);
        });

        elStatus.style.display="none";
        elList.style.display="grid";
        firstLoad = false;
      });

      // Toplu okundu
      btnAll?.addEventListener("click", async ()=>{
        const unreadQ = query(inboxRef, where("read","==",false));
        const ss = await getDocs(unreadQ);
        await Promise.all(ss.docs.map(x=> updateDoc(doc(db,"users",user.uid,"inbox",x.id),{read:true}) ));
        document.querySelectorAll('.item.unread').forEach(el=>el.classList.remove('unread'));
      });
    });

    // DM sohbet a√ß / olu≈ütur ‚Äî doƒürudan set (mevcutsa merge)
    async function openDirectChat(myUid, peerUid){
      try{
        const pair = [myUid, peerUid].sort();
        const chatId = `dm_${pair[0]}_${pair[1]}`;
        await setDoc(
          doc(db, "chats", chatId),
          {
            participants: pair,
            type: "dm",
            createdAt: serverTimestamp(),
            lastMsgAt: serverTimestamp()
          },
          { merge: true }
        );
        location.href = `/messages.html?chatId=${encodeURIComponent(chatId)}&peer=${encodeURIComponent(peerUid)}`;
      }catch(e){
        console.error("Sohbet a√ßƒ±lamadƒ±:", e);
        alert("Sohbet a√ßƒ±lamadƒ±.");
      }
    }
  </script>
</body>
</html>
