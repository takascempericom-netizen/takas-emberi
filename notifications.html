<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bildirimler ‚Ä¢ Takas √áemberi</title>
  <style>
    :root{--c1:#7c3aed;--c2:#06b6d4;--c3:#10b981;--c4:#f59e0b;--fg:#0f172a;--glass:rgba(255,255,255,.78);--brd:rgba(255,255,255,.5)}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--fg);
      background:linear-gradient(120deg,var(--c1),var(--c2),var(--c3),var(--c4));background-size:300% 300%;animation:grad 18s ease infinite;min-height:100vh}
    @keyframes grad{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .hdr{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.2);backdrop-filter:blur(10px);border-bottom:1px solid var(--brd)}
    .hdr .in{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    .ttl{margin:0;font-size:20px;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.25)}
    .row{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid var(--brd);background:var(--glass);color:#111827;font-weight:600;padding:8px 12px;border-radius:12px;cursor:pointer}
    .btn:hover{background:#fff}
    .btn.sm{padding:6px 10px;border-radius:10px;font-size:12px}
    .wrap{max-width:1100px;margin:16px auto 120px;padding:0 16px}
    .card{background:var(--glass);border:1px solid var(--brd);border-radius:20px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    .list{padding:12px;display:grid;gap:8px}
    .item{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px;display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    .item.unread{border-color:#94a3b8;box-shadow:0 4px 16px rgba(15,23,42,.08)}
    .meta strong{display:block}
    .muted{font-size:12px;color:#64748b}
    .type{font-size:12px;padding:4px 8px;border-radius:10px;border:1px solid #e5e7eb;background:#f8fafc;display:inline-block}
    .type.offer{background:#fff7ed;color:#9a3412;border-color:#fed7aa}
    .type.message{background:#eff6ff;color:#1d4ed8;border-color:#bfdbfe}
    .type.broadcast{background:#dcfce7;color:#065f46;border-color:#bbf7d0}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .empty{padding:20px;text-align:center;color:#475569}
    .fixedbar{position:fixed;left:0;right:0;bottom:0;z-index:30}
    .fixedbar .in{max-width:1100px;margin:0 auto;padding:8px 12px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .fixedbar a{display:flex;flex-direction:column;gap:2px;align-items:center;justify-content:center;padding:8px 6px;border-radius:14px;text-decoration:none;color:#111827;font-weight:600;border:1px solid var(--brd);background:var(--glass)}
    .fixedbar a.active{background:#111827;color:#fff;border-color:#111827}
    .fixedbar:before{content:"";position:absolute;inset:-20px 0 -20px 0;z-index:-1;background:linear-gradient(90deg,var(--c1),var(--c2),var(--c3),var(--c4));filter:blur(30px);opacity:.6}
  </style>
</head>
<body>
  <header class="hdr">
    <div class="in">
      <h1 class="ttl">Bildirimler</h1>
      <div class="row">
        <button class="btn sm" id="btnMarkAll">T√ºm√ºn√º okundu i≈üaretle</button>
        <button class="btn sm" id="btnSound">üîî Ses testi</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div id="status" class="empty">Y√ºkleniyor‚Ä¶</div>
      <div id="list" class="list" style="display:none"></div>
    </section>
  </main>

  <nav class="fixedbar">
    <div class="in">
      <a href="/" id="navHome">üè†<span>Ana Sayfa</span></a>
      <a href="/messages.html" id="navMsgs">üí¨<span>Mesajlar</span></a>
      <a href="/notifications.html" class="active" id="navNotifs">üîî<span>Bildirimler</span></a>
      <a href="/profile/profile.html" id="navProfile">üë§<span>Profil</span></a>
    </div>
  </nav>

  <audio id="ding" preload="auto">
    <source src="/assets/sounds/notify.wav" type="audio/wav">
  </audio>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUUNSYxoWNUsK0C-C04qTUm6KM5756fvg",
      authDomain: "ureten-eller-v2.firebaseapp.com",
      projectId: "ureten-eller-v2",
      storageBucket: "ureten-eller-v2.firebasestorage.app",
      messagingSenderId: "621494781131",
      appId: "1:621494781131:web:13cc3b061a5e94b7cf874e"
    };
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const elList = document.getElementById('list');
    const elStatus = document.getElementById('status');
    const btnAll = document.getElementById('btnMarkAll');
    const btnSound = document.getElementById('btnSound');
    const ding = document.getElementById('ding');

    const fmt = (ts)=>{
      try{ const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : new Date(ts));
        return isNaN(d) ? "‚Äî" : d.toLocaleString("tr-TR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
      }catch{ return "‚Äî"; }
    };

    let firstLoad = true;
    let known = new Set();

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ elStatus.textContent="L√ºtfen giri≈ü yapƒ±n."; elList.style.display="none"; return; }

      const inboxRef = collection(db, "users", user.uid, "inbox");
      const qInbox = query(inboxRef, orderBy("createdAt","desc"));

      onSnapshot(qInbox, (snap)=>{
        if(snap.empty){ elList.style.display="none"; elStatus.style.display="block"; elStatus.textContent="Bildirim yok."; return; }
        elList.innerHTML = "";
        snap.forEach(d=>{
          const data = d.data()||{};
          const div = document.createElement("div");
          div.className = "item" + (data.read ? "" : " unread");
          div.innerHTML = `
            <div class="meta">
              <div class="row" style="display:flex;gap:8px;align-items:center">
                <span class="type ${data.type||'message'}">${(data.type||'message').toUpperCase()}</span>
                <strong>${data.title||"Bildirim"}</strong>
              </div>
              <div class="muted">${data.body||""}</div>
              <div class="muted">${fmt(data.createdAt)}</div>
            </div>
            <div class="actions">
              ${data.read ? "" : `<button class="btn sm" data-act="read">Okundu</button>`}
              ${data.link ? `<a class="btn sm" href="${data.link}">Git</a>` : ""}
            </div>
          `;
          div.addEventListener("click", async (ev)=>{
            const b = ev.target.closest("button[data-act='read']"); if(!b) return;
            await updateDoc(doc(db,"users",user.uid,"inbox",d.id),{read:true});
          });
          elList.appendChild(div);

          if(!firstLoad && !data.read && !known.has(d.id)){ try{ ding.play(); }catch{} }
          known.add(d.id);
        });
        elStatus.style.display="none"; elList.style.display="grid"; firstLoad=false;
      });

      btnAll?.addEventListener("click", async ()=>{
        const unreadQ = query(inboxRef, where("read","==",false));
        const ss = await getDocs(unreadQ);
        await Promise.all(ss.docs.map(x=> updateDoc(doc(db,"users",user.uid,"inbox",x.id),{read:true}) ));
      });
    });

    btnSound?.addEventListener("click", ()=>{ try{ ding.play(); }catch{} });
  </script>
</body>
</html>
