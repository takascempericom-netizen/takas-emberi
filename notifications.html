<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bildirimler • Takas Çemberi</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b0d12; --card:#10131b; --muted:#8b97b2; --line:#1f2431; --fg:#e7ebf6; --ok:#12d179; --yellow:#ffd33d; --red:#ff4d4d; }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 1200px at 80% -10%,rgba(0,196,255,.08),transparent 40%),
        radial-gradient(800px 800px at 10% 110%,rgba(124,77,255,.10),transparent 45%),
        var(--bg);
      color:var(--fg);
    }
    .wrap{max-width:960px;margin:0 auto;padding:16px 16px 96px}
    .hd{display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:5;
        background:linear-gradient(180deg,rgba(11,13,18,.92),rgba(11,13,18,.65) 70%,transparent);
        backdrop-filter:blur(6px);padding:12px 0 10px}
    .title{font-weight:800;letter-spacing:.2px}
    .sp{flex:1}
    a.btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);color:var(--fg);text-decoration:none;
          background:#0c1019;padding:8px 12px;border-radius:12px;font-weight:700}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent 40%),var(--card);
          border:1px solid var(--line);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);padding:14px;margin-top:14px}
    h2{margin:0 0 6px 0;font-size:18px}
    .muted{color:var(--muted);font-size:13px}
    ul.list{list-style:none;margin:10px 0 0 0;padding:0;display:flex;flex-direction:column;gap:8px}
    .item{display:flex;gap:10px;align-items:flex-start;border:1px solid var(--line);background:#0c1016;border-radius:12px;padding:10px}
    .item .ico{font-size:18px}
    .item .tx strong{display:block;font-weight:800}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800}
    .ok{background:rgba(18,209,121,.12);border:1px solid rgba(18,209,121,.35);color:#12d179}
    .rej{background:rgba(255,77,77,.12);border:1px solid rgba(255,77,77,.35);color:#ff4d4d}
    .off{background:rgba(124,77,255,.12);border:1px solid rgba(124,77,255,.35);color:#a371f7}
    .ts{color:var(--muted);font-size:12px}
    @media (max-width:560px){ .wrap{padding:12px 12px 92px} }
    .nav{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(11,13,18,.2),rgba(11,13,18,.85)),#0b0d12;border-top:1px solid var(--line);
         display:grid;grid-template-columns:repeat(3,1fr);}
    .nav a{padding:12px 6px;text-align:center;text-decoration:none;color:var(--fg);font-weight:700}
    .nav a span{display:block;font-size:11px;color:var(--muted)}
    .nav a.active{color:#fff;background:linear-gradient(180deg,rgba(124,77,255,.14),transparent)}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hd">
      <div class="title">🔔 Bildirimler</div>
      <div class="sp"></div>
      <a class="btn" href="home.html">← Ana Sayfa</a>
    </header>

    <section class="card">
      <h2>Size Gelen Teklifler</h2>
      <div class="muted">Aktif ilanlarınıza yeni teklifler burada listelenir.</div>
      <ul id="offersList" class="list"></ul>
      <div id="offersEmpty" class="muted" style="margin-top:8px">Henüz teklif yok.</div>
    </section>

    <section class="card">
      <h2>İlan Durumu Değişiklikleri</h2>
      <div class="muted">Onaylanan / Reddedilen ilanlarınız.</div>
      <ul id="statusList" class="list"></ul>
      <div id="statusEmpty" class="muted" style="margin-top:8px">Henüz durum değişikliği yok.</div>
    </section>
  </div>

  <nav class="nav">
    <a href="home.html"><div>🏠</div><span>Ana Sayfa</span></a>
    <a href="messages.html"><div>💬</div><span>Mesajlar</span></a>
    <a class="active" href="notifications.html"><div>🔔</div><span>Bildirimler</span></a>
  </nav>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collectionGroup, query, where, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const cfg = {
      apiKey: "AIzaSyBUUNSYxoWNUsK0C-C04qTUm6fvg",
      authDomain: "ureten-eller-v2.firebaseapp.com",
      projectId: "ureten-eller-v2",
      storageBucket: "ureten-eller-v2.appspot.com",
      messagingSenderId: "621494781131",
      appId: "1:621494781131:web:13cc3b061a5e94b7cf874e"
    };
    const app = getApps().length ? getApps()[0] : initializeApp(cfg);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const $ = (id)=>document.getElementById(id);
    const offersList = $("offersList");
    const offersEmpty = $("offersEmpty");
    const statusList = $("statusList");
    const statusEmpty = $("statusEmpty");

    const fmt = (ts)=>{
      try{
        const d = ts?.toDate ? ts.toDate() : new Date();
        return d.toLocaleString('tr-TR');
      }catch(_){ return ""; }
    };

    function li(html){ const li=document.createElement('li'); li.className='item'; li.innerHTML=html; return li; }

    onAuthStateChanged(auth, (u)=>{
      if(!u){ location.href = "auth.html?next=notifications.html"; return; }

      // --- Size Gelen Teklifler (sellerId == uid)
      try{
        const qOffers = query(collectionGroup(db,"offers"), where("sellerId","==",u.uid));
        onSnapshot(qOffers, (ss)=>{
          let any = false;
          offersList.innerHTML = "";
          ss.forEach(doc=>{
            const d = doc.data();
            const title = d.listingTitle || "Teklif";
            const time  = fmt(d.createdAt);
            offersList.appendChild(li(`
              <div class="ico">📨</div>
              <div class="tx">
                <strong>${title}</strong>
                <div class="badge off">Yeni teklif</div>
                <div class="ts">${time}</div>
              </div>
            `));
            any = true;
          });
          offersEmpty.style.display = any ? "none" : "block";
        }, (e)=>console.warn("[offers]", e));
      }catch(e){ console.warn("[offers cg]", e); }

      // --- İlan Durumu Değişiklikleri (ownerId == uid) canlı dinleme
      const last = new Map();
      try{
        const qMine = query(collection(db,"listings"), where("ownerId","==",u.uid));
        onSnapshot(qMine, (ss)=>{
          ss.docChanges().forEach((ch)=>{
            const d = ch.doc.data(), id = ch.doc.id;
            const prev = last.get(id);
            const curr = d.status;
            if(ch.type === "added"){
              last.set(id, curr);
            } else if(ch.type === "modified"){
              if(prev !== curr){
                if(prev === "pending" && curr === "active"){
                  statusList.prepend(li(`
                    <div class="ico">✅</div>
                    <div class="tx"><strong>${d.title||"İlan"}</strong>
                      <div class="badge ok">Onaylandı</div>
                      <div class="ts">${fmt(d.updatedAt)}</div>
                    </div>`));
                }
                if(prev === "pending" && curr === "rejected"){
                  statusList.prepend(li(`
                    <div class="ico">⛔</div>
                    <div class="tx"><strong>${d.title||"İlan"}</strong>
                      <div class="badge rej">Reddedildi</div>
                      <div class="ts">${fmt(d.updatedAt)}</div>
                    </div>`));
                }
                last.set(id, curr);
              }
            } else if(ch.type === "removed"){
              last.delete(id);
            }
            // boş durum kontrolü
            statusEmpty.style.display = statusList.childElementCount > 0 ? "none" : "block";
          });
        }, (e)=>console.warn("[status]", e));
      }catch(e){ console.warn("[status q]", e); }
    });
  </script>
</body>
</html>
