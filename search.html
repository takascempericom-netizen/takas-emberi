<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Takas Çemberi • Arama</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="favicon.png" type="image/png" sizes="32x32"/>
  <style>
    :root{
      --paper:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brandA:#6a5cff; --brandB:#00d4ff; --focus:#0ea5e9; --btn:#111827; --btnInk:#fff;
      --bottomH:64px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f9fafb;color:var(--ink);
      padding-bottom:calc(var(--bottomH) + env(safe-area-inset-bottom,0px) + 12px);}
    a,button{font:inherit}

    .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:12px;height:64px;
      padding:0 12px 0 16px;background:linear-gradient(90deg,var(--brandA),var(--brandB));color:#fff;box-shadow:0 2px 12px rgba(10,20,60,.25)}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:#fff}
    .brand img{height:44px}
    .grow{flex:1}
    .btn{border:1px solid rgba(255,255,255,.24);background:rgba(0,0,0,.18);color:#fff;border-radius:12px;padding:8px 14px;cursor:pointer}
    .btn.primary{background:var(--btn);border-color:#000;color:var(--btnInk)}
    .search-form{flex:1;max-width:420px;display:flex;gap:6px}
    .search-input{flex:1;padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.5);background:rgba(255,255,255,.15);color:#fff}
    .search-input::placeholder{color:rgba(255,255,255,.9)}
    .search-btn{padding:8px 12px;border-radius:12px;border:1px solid #000;background:#111827;color:#fff}

    .wrap{max-width:1200px;margin:16px auto;padding:0 16px}
    .panel{background:var(--paper);border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .filters{display:flex;gap:8px;flex-wrap:wrap;padding:12px}
    .chip{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
    .chip.active{background:#111827;color:#fff;border-color:#111827}

    .ads-grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr);padding:16px}
    @media (min-width:900px){.ads-grid{grid-template-columns:repeat(4,1fr)}}
    .ad-card{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff;color:#111827;text-decoration:none;
      box-shadow:0 6px 18px rgba(0,0,0,.06);transition:transform .15s ease;cursor:pointer}
    .ad-card:hover{transform:translateY(-2px)}
    .ad-media{position:relative;width:100%;background:#f1f5f9;border-bottom:1px solid var(--line)}
    .ad-media::before{content:"";display:block;padding-top:100%}
    .ad-media img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .ad-body{padding:10px}
    .ad-title{margin:0 0 4px;font-size:14px;font-weight:800;line-height:1.25;color:#0f172a;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .ad-meta{display:flex;gap:6px;justify-content:space-between;color:var(--muted);font-size:12px}
    .ad-actions{display:flex;gap:8px;margin-top:8px}
    .ad-actions button{flex:1;padding:8px 10px;border:1px solid var(--line);background:#f8fafc;color:#0f172a;border-radius:10px;cursor:pointer}
    .ad-actions .btn-view{background:#111827;color:#fff;border-color:#000}
    .bottom-nav{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(3,1fr);z-index:40;height:var(--bottomH)}
  </style>
</head>
<body>
  <header class="topbar">
    <a class="brand" href="index.html"><img src="assets/img/seffaf.png" alt="Takas Çemberi logo"/><strong>Takas Çemberi</strong></a>
    <div class="grow"></div>
    <form class="search-form" action="search.html" method="get" role="search">
      <input class="search-input" type="search" name="q" placeholder="Ne arıyorsun?" aria-label="Arama" />
      <button class="search-btn" type="submit">Ara</button>
    </form>
    <button id="btnProfile" class="btn">Profil</button>
    <button id="btnPostAd" class="btn primary">İlan Ver</button>
    <button id="btnLogout" class="btn">Çıkış</button>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="filters" id="filters">
        <button class="chip" data-cat="">Tümü</button>
        <button class="chip" data-cat="ev-hobi">Ev & Hobi</button>
        <button class="chip" data-cat="tasinmaz">Taşınmaz</button>
        <button class="chip" data-cat="tasit">Motorlu Taşıtlar</button>
        <button class="chip" data-cat="oyuncak">Oyuncak</button>
        <button class="chip" data-cat="giyim">Giyim</button>
        <button class="chip" data-cat="beyaz-esya">Beyaz Eşya</button>
        <button class="chip" data-cat="teknoloji">Teknoloji</button>
        <button class="chip" data-cat="mobilya">Mobilya</button>
      </div>
      <div class="ads-grid" id="results"></div>
      <div id="empty" style="display:none;padding:16px;color:#64748b">Sonuç bulunamadı.</div>
    </section>
  </main>

  <nav class="bottom-nav" aria-label="Alt menü">
    <button class="tab" onclick="location.href='index.html'">Ana Sayfa</button>
    <button class="tab" onclick="location.href='messages.html'">Mesajlar</button>
    <button class="tab" onclick="location.href='notifications.html'">Bildirimler</button>
  </nav>

  <script type="module" src="assets/js/firebase-init.js"></script>
  <script type="module">
    const { auth, db } = window.__fb || {};
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // === helpers ===
    const $ = (s,r=document)=>r.querySelector(s);
    const params = new URLSearchParams(location.search);
    let qText = (params.get('q')||'').trim();
    let cat = (params.get('cat')||'').trim();
    const normalize = s => s.toLocaleLowerCase('tr')
      .replaceAll('ç','c').replaceAll('ğ','g').replaceAll('ı','i').replaceAll('ö','o').replaceAll('ş','s').replaceAll('ü','u');

    // UI filter chips
    const chips = [...document.querySelectorAll('.chip')];
    chips.forEach(ch=>{
      if ((ch.dataset.cat||'') === cat) ch.classList.add('active');
      ch.addEventListener('click', ()=>{
        const url = new URL(location.href);
        if (ch.dataset.cat) url.searchParams.set('cat', ch.dataset.cat); else url.searchParams.delete('cat');
        history.replaceState(null,'',url.toString());
        cat = ch.dataset.cat||'';
        load();
      });
    });

    // topbar buttons
    $('#btnLogout')?.addEventListener('click', async ()=>{ try{ await signOut(auth);}catch{} location.href="index.html"; });
    $('#btnProfile')?.addEventListener('click', ()=>location.href="profile/profile.html");
    $('#btnPostAd')?.addEventListener('click', ()=>location.href="ilan/ilan-verme.html");

    // === query ===
    async function load(){
      const listEl = $('#results'); const emptyEl = $('#empty');
      listEl.innerHTML = ''; emptyEl.style.display='none';

      // temel sorgu: isApproved true
      let qRef = query(collection(db,'listings'), where('isApproved','==', true), orderBy('createdAt','desc'), limit(50));
      // kategori varsa ek where
      if (cat) {
        qRef = query(collection(db,'listings'), where('isApproved','==', true), where('cat','==', cat), orderBy('createdAt','desc'), limit(50));
      }
      const snap = await getDocs(qRef);

      if (snap.empty){ emptyEl.style.display='block'; return; }

      // metin filtresini istemci tarafında uygula (mevcut veriye uyum için)
      const nq = normalize(qText);
      const rows = [];
      snap.forEach(d=>{
        const v = d.data()||{};
        const title = v.title||'İlan';
        const needle = [v.title, v.desc, v.city, v.cond].map(x=>normalize(String(x||''))).join(' ');
        if (!nq || needle.includes(nq)){
          rows.push({ id:d.id, ...v });
        }
      });

      if (rows.length===0){ emptyEl.style.display='block'; return; }

      for (const d of rows){
        const cover = d.photos?.[0] || "assets/img/seffaf.png";
        const title = d.title || "İlan";
        const city  = d.city  || "";
        const cond  = d.cond  || "";
        listEl.insertAdjacentHTML('beforeend', `
  <div class="ad-card" data-id="${d.id}">
    <div class="ad-media"><img src="${cover}" alt="${title}" loading="lazy" decoding="async"></div>
    <div class="ad-body">
      <h3 class="ad-title">${title}</h3>
      <div class="ad-meta"><span>${city}</span><span>${cond}</span></div>
      <div class="ad-actions">
        <button type="button" class="btn-view"  data-id="${d.id}">İncele</button>
        <button type="button" class="btn-offer" data-id="${d.id}" data-owner="${d.ownerId || d.uid || ''}">Teklif ver</button>
      </div>
    </div>
  </div>`);
      }

      // kart tıklamaları
      listEl.addEventListener('click', (ev)=>{
        const btn = ev.target.closest('button');
        if (btn){
          const id = btn.dataset.id;
          if (btn.classList.contains('btn-view')){ location.href = `ilan/index.html?id=${encodeURIComponent(id)}`; return; }
          if (btn.classList.contains('btn-offer')){
            const owner = btn.dataset.owner||'';
            if (!owner){ alert('İlan sahibi bilgisi eksik.'); return; }
            // home’daki openOfferFlow yok; bu sayfada teklif akışını basitçe yönlendiriyoruz:
            location.href = `ilan/index.html?id=${encodeURIComponent(id)}#offer`;
            return;
          }
        }
        const card = ev.target.closest('.ad-card');
        if (card && !ev.target.closest('.ad-actions')){
          const id = card.dataset.id; location.href = `ilan/index.html?id=${encodeURIComponent(id)}`;
        }
      });
    }

    // auth sonra yükle
    onAuthStateChanged(auth, async (user)=>{
      if (!user){
        $('#results').innerHTML = '<div style="grid-column:1/-1;color:#64748b;padding:16px">İlanları görmek için giriş yapın</div>';
        return;
      }
      await user.getIdToken(true);
      load();
    });
  </script>
</body>
</html>
