<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profil ‚Ä¢ Takas √áemberi</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0b10; --card:#12131a; --muted:#6b7a99; --txt:#f6f7fb; --accent:#ff1f3d; --accent-2:#ff3d5b;
      --stroke:#222434; --ok:#28c76f; --warn:#ff9f43;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#0b0b10;color:var(--txt);font:15px/1.6 Inter,system-ui,Segoe UI,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:16px 16px 108px}
    header.hd{display:flex;align-items:center;gap:16px;padding:16px;border:1px solid var(--stroke);border-radius:20px;background:#111420}
    @media (max-width:720px){ header.hd{align-items:flex-start} }
    .avatar{position:relative;width:96px;height:96px;border-radius:50%;background:#0e0f16;border:2px solid #22263a;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .avatar input{position:absolute;inset:0;opacity:0;cursor:pointer}
    .badge{position:absolute;bottom:-4px;right:-4px;background:linear-gradient(180deg,var(--accent),var(--accent-2));border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    .info{flex:1;min-width:0}
    .info h1{font-size:22px;margin:0 0 4px}
    .handle{color:#c9cfff;font-weight:700;opacity:.9}
    .stars3d{display:flex;gap:8px;align-items:center;margin-top:8px}
    .star{width:34px;height:34px;display:grid;place-items:center;border-radius:10px;background:#0f1320;border:1px solid #24293d;cursor:pointer;transition:.15s}
    .star:hover{transform:translateY(-1px)}
    .star.active{background:radial-gradient(120% 80% at 50% -20%, #ff8aa0 0%, #ff1f3d 60%);border-color:#ff6a84}
    .row{display:flex;gap:16px;flex-wrap:wrap;margin-top:16px}
    .card{flex:1 1 300px;border:1px solid var(--stroke);border-radius:20px;background:#141827;padding:16px}
    .card h2{margin:0 0 12px;font-size:17px}
    label{display:block;font-size:13px;color:var(--muted);margin:8px 0 4px}
    input, textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #24273a;background:#0f1220;color:var(--txt)}
    textarea{min-height:96px;resize:vertical}
    .btn{padding:12px 14px;border-radius:12px;border:1px solid #2a2e46;background:#171b2b;color:#fff;font-weight:700;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#ff3956,#ff1f3d);border-color:#ff3d5b;box-shadow:0 8px 28px rgba(255,61,91,.35)}
    .btn.ghost{background:transparent}
    .inline{display:flex;gap:8px;flex-wrap:wrap}

    /* Alt men√º */
    .btmnav{position:fixed;left:0;right:0;bottom:0;background:#0b0b10;border-top:1px solid #1f2234}
    .btmnav .bar{max-width:980px;margin:0 auto;display:grid;grid-template-columns:repeat(3,1fr)}
    .btmnav a{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px 6px;color:#cfd4ff;font-weight:700}
    .btmnav a.active{color:#fff}

    /* ƒ∞lan sekmeleri */
    .tabs{display:flex;gap:8px;margin:4px 0 12px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid #2a2e46;border-radius:999px;background:#12162a;color:#e6e8ff;font-weight:700;cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#ff3956,#ff1f3d);border-color:#ff6a84}
    .list{display:grid;gap:10px}
    .item{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;border:1px solid #22263a;background:#0f1322;border-radius:14px;padding:10px}
    .thumb{width:64px;height:64px;border-radius:10px;background:#0e0f16;overflow:hidden;border:1px solid #272b42}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .status{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2a2e46;background:#141a2d;color:#c9d0ff}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hd">
      <div class="avatar" title="Resim Ekle / Deƒüi≈ütir">
        <img id="avatarImg" alt="Profil Fotoƒürafƒ±" src="" onerror="this.src='https://i.pravatar.cc/200?img=8'">
        <input id="avatarFile" type="file" accept="image/*" />
        <div class="badge">üì∑</div>
      </div>
      <div class="info">
        <h1 id="fullName">‚Äî</h1>
        <div class="handle" id="handle">@kullanici</div>
        <div class="stars3d" id="starsBlock"></div>
      </div>
      <button class="btn ghost" id="btnLogout">üö™ √áƒ±kƒ±≈ü</button>
    </header>

    <div class="row">
      <section class="card">
        <h2>Profil Bilgileri</h2>
        <label>ƒ∞sim</label>
        <input id="inpFirst" placeholder="ƒ∞sim">
        <label>Soyisim</label>
        <input id="inpLast" placeholder="Soyisim">
        <label>Kullanƒ±cƒ± Adƒ±</label>
        <input id="inpHandle" placeholder="kullanici">
        <label>Telefon</label>
        <input id="inpPhone" placeholder="5xx xxx xx xx">
        <label>E‚Äëposta</label>
        <input id="inpEmail" placeholder="mail@ornek.com" disabled>
        <div class="inline" style="margin-top:10px">
          <button class="btn primary" id="btnSave">Kaydet</button>
          <button class="btn" id="btnRefresh">Yenile</button>
          <button class="btn" id="btnChangePass">≈ûifre Deƒüi≈ütir</button>
        </div>
      </section>

      <section class="card" style="flex:1 1 480px">
        <h2>ƒ∞lanlarƒ±m</h2>
        <div class="tabs">
          <button class="tab active" data-tab="pending">Onay Bekleyen</button>
          <button class="tab" data-tab="active">Yayƒ±nda</button>
          <button class="tab" data-tab="expired">S√ºresi Dolan</button>
        </div>
        <div id="list-pending" class="list"></div>
        <div id="list-active" class="list hide"></div>
        <div id="list-expired" class="list hide"></div>
      </section>

      <section class="card">
        <h2>≈ûikayet Et</h2>
        <label>Mesaj</label>
        <textarea id="inpReport" placeholder="≈ûikayetini yaz..."></textarea>
        <div class="inline" style="margin-top:10px">
          <button class="btn primary" id="btnReport">G√∂nder</button>
        </div>
      </section>
    </div>
  </div>

  <nav class="btmnav">
    <div class="bar">
      <a href="home.html" id="navHome">üè† Ana Sayfa</a>
      <a href="notifications.html" id="navNotif">üîî Bildirimler</a>
      <a href="messages.html" id="navMsg">üí¨ Mesajlar</a>
    </div>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, collection, addDoc, query, where, getDocs, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

    // KULLANICININ VERDƒ∞ƒûƒ∞ AYARLAR (bucket ismi d√ºzeltildi)
    const firebaseConfig = {
      apiKey: "AIzaSyBUUNSYxoWNUsK0C-C04qTUm6KM5756fvg",
      authDomain: "ureten-eller-v2.firebaseapp.com",
      projectId: "ureten-eller-v2",
      storageBucket: "ureten-eller-v2.appspot.com",
      messagingSenderId: "621494781131",
      appId: "1:621494781131:web:13cc3b061a5e94b7cf874e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const $ = (id)=>document.getElementById(id);
    const avatarImg = $('avatarImg');
    const avatarFile= $('avatarFile');
    const fullName  = $('fullName');
    const handleEl  = $('handle');
    const starsBlock= $('starsBlock');

    const inpFirst=$('inpFirst'), inpLast=$('inpLast'), inpHandle=$('inpHandle'), inpPhone=$('inpPhone'), inpEmail=$('inpEmail');
    const btnSave=$('btnSave'), btnRefresh=$('btnRefresh'), btnChangePass=$('btnChangePass');

    const listPending=$('list-pending'), listActive=$('list-active'), listExpired=$('list-expired');
    const btnReport=$('btnReport'), inpReport=$('inpReport');

    // Tabs
    document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const k=t.dataset.tab;
      listPending.classList.toggle('hide',k!=='pending');
      listActive.classList.toggle('hide',k!=='active');
      listExpired.classList.toggle('hide',k!=='expired');
    }));

    let currentUser=null, targetUserId=null, currentUserData=null;

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href='auth.html?next=profile.html'; return; }
      currentUser=user; inpEmail.value=user.email||'';
      const params=new URLSearchParams(location.search);
      targetUserId=params.get('uid')||user.uid; // kendi profilin

      currentUserData=(await getDoc(doc(db,'users',user.uid))).data()||{};

      await loadProfile(targetUserId);
      renderStars(starsBlock,0,targetUserId===currentUser.uid); // kendi profilinde oylama kapalƒ±
      await refreshListings();
    });

    async function loadProfile(uid){
      const uref=doc(db,'users',uid);
      const snap=await getDoc(uref);
      if(!snap.exists()) await setDoc(uref,{createdAt:serverTimestamp()},{merge:true});
      const d=(await getDoc(uref)).data()||{};
      const first=d.firstName||''; const last=d.lastName||''; const uname=d.username||d.handle||'kullanici';
      avatarImg.src=d.photoURL||`https://api.dicebear.com/7.x/thumbs/svg?seed=${encodeURIComponent(uname)}`;
      fullName.textContent=(first||last)?`${first} ${last}`.trim():(d.displayName||'‚Äî');
      handleEl.textContent='@'+uname;

      inpFirst.value=first; inpLast.value=last; inpHandle.value=uname; inpPhone.value=d.phone||'';
    }

    // Kaydet UX: kƒ±sa s√ºre disable ‚Üí tekrar aktif
    btnSave.addEventListener('click', async()=>{
      if(!currentUser) return;
      btnSave.disabled=true; btnSave.textContent='Kaydediliyor‚Ä¶';
      await setDoc(doc(db,'users',currentUser.uid),{
        firstName: inpFirst.value.trim(),
        lastName : inpLast.value.trim(),
        username : inpHandle.value.trim().replace(/\s+/g,'').toLowerCase(),
        phone    : inpPhone.value.trim(),
        updatedAt: serverTimestamp()
      },{merge:true});
      await loadProfile(targetUserId);
      btnSave.textContent='Kaydedildi';
      setTimeout(()=>{ btnSave.disabled=false; btnSave.textContent='Kaydet'; }, 900);
    });

    btnRefresh.addEventListener('click',()=>loadProfile(targetUserId));
    btnChangePass.addEventListener('click',async()=>{
      if(!currentUser?.email) return alert('E‚Äëposta baƒülƒ± deƒüil.');
      await sendPasswordResetEmail(auth,currentUser.email); alert('E‚Äëpostana ≈üifre sƒ±fƒ±rlama baƒülantƒ±sƒ± g√∂nderildi.');
    });
    $('btnLogout').addEventListener('click',()=>signOut(auth));

    // Avatar y√ºkleme (kalƒ±cƒ±, herkese g√∂r√ºn√ºr)
    avatarFile.addEventListener('change',async(e)=>{
      if(!currentUser) return; const file=e.target.files?.[0]; if(!file) return;
      const r=ref(storage,`profile_photos/${currentUser.uid}.jpg`);
      await uploadBytes(r,file); const url=await getDownloadURL(r);
      await updateDoc(doc(db,'users',currentUser.uid),{photoURL:url,updatedAt:serverTimestamp()});
      avatarImg.src=url;
    });

    // ‚Äî‚Äî‚Äî YILDIZ OYLAMA: Firestore'a yaz (avg g√∂stermiyoruz) ‚Äî‚Äî‚Äî
    function renderStars(container,current=0,disabled=false){
      container.innerHTML='';
      for(let i=1;i<=5;i++){
        const s=document.createElement('div'); s.className='star'+(i<=current?' active':''); s.title=i+' yƒ±ldƒ±z';
        const ico=document.createElement('i'); ico.style.fontStyle='normal'; ico.textContent='‚òÖ'; s.appendChild(ico);
        if(!disabled){ s.addEventListener('click',()=>saveRating(i)); }
        else { s.style.cursor='not-allowed'; }
        container.appendChild(s);
      }
    }
    async function saveRating(stars){
      if(!currentUser) return alert('Giri≈ü yapmalƒ±sƒ±n.');
      if(currentUser.uid===targetUserId) return alert('Kendi profilini oylayamazsƒ±n.');
      const key=`${targetUserId}_${currentUser.uid}`;
      await setDoc(doc(db,'ratings',key),{targetId:targetUserId,raterId:currentUser.uid,stars,updatedAt:serverTimestamp(),createdAt:serverTimestamp()},{merge:true});
      renderStars(starsBlock,stars,false);
      alert('Oyun kaydedildi.');
    }

    // ‚Äî‚Äî‚Äî ƒ∞LANLAR: pending ‚Üí admin onayƒ±yla active ‚Üí 30 g√ºnde expired ‚Äî‚Äî‚Äî
    async function refreshListings(){
      await ensureExpireTransitions();
      await loadByStatus('pending',listPending);
      await loadByStatus('active',listActive);
      await loadByStatus('expired',listExpired);
    }
    async function loadByStatus(status,container){
      container.innerHTML='';
      const qref=query(collection(db,'listings'), where('ownerId','==',targetUserId), where('status','==',status), orderBy('createdAt','desc'));
      const qs=await getDocs(qref);
      if(qs.empty){ container.innerHTML='<div style="color:var(--muted)">Bu b√∂l√ºmde ilan yok.</div>'; return; }
      qs.forEach(docu=>{
        const d=docu.data(); const id=docu.id;
        const it=document.createElement('div'); it.className='item';
        const th=document.createElement('div'); th.className='thumb'; th.innerHTML=`<img src="${d.photoURL||'https://picsum.photos/seed/takas/120/120'}" alt="thumb">`;
        const body=document.createElement('div'); body.innerHTML=`<div style="font-weight:800">${escapeHtml(d.title||'ƒ∞lan')}</div>
          <div style="font-size:13px;color:var(--muted);margin-top:2px">${escapeHtml((d.desc||'').slice(0,120))}</div>
          <div style="margin-top:6px" class="status">Durum: ${statusLabel(status)}</div>`;
        const acts=document.createElement('div'); acts.className='actions';

        // ≈ûikayet et
        const rep=document.createElement('button'); rep.className='btn'; rep.textContent='‚ö†Ô∏è ≈ûikayet et'; rep.addEventListener('click',()=>reportListing(id)); acts.appendChild(rep);
        // Admin aksiyonlarƒ±
        if(currentUserData?.isAdmin){
          if(status==='pending'){ const b=document.createElement('button'); b.className='btn primary'; b.textContent='Onayla ‚Üí Yayƒ±na Al'; b.addEventListener('click',()=>approveListing(id)); acts.appendChild(b); }
          if(status==='active'){ const b2=document.createElement('button'); b2.className='btn'; b2.textContent='Yayƒ±ndan Kaldƒ±r'; b2.addEventListener('click',()=>expireListingNow(id)); acts.appendChild(b2); }
        }

        it.appendChild(th); it.appendChild(body); it.appendChild(acts); container.appendChild(it);
      });
    }
    function statusLabel(s){ return s==='pending'?'Onay Bekliyor': s==='active'?'Yayƒ±nda':'S√ºresi Doldu'; }
    async function approveListing(id){ const now=Timestamp.now(); const expires=Timestamp.fromMillis(now.toMillis()+30*24*60*60*1000); await updateDoc(doc(db,'listings',id),{status:'active',approvedAt:now,expiresAt:expires}); await refreshListings(); }
    async function expireListingNow(id){ await updateDoc(doc(db,'listings',id),{status:'expired'}); await refreshListings(); }
    async function ensureExpireTransitions(){ const now=Timestamp.now(); const qs=await getDocs(query(collection(db,'listings'), where('ownerId','==',targetUserId), where('status','==','active'))); for(const d of qs.docs){ const x=d.data(); if(x.expiresAt && x.expiresAt.toMillis()<now.toMillis()){ await updateDoc(doc(db,'listings',d.id),{status:'expired'}); } } }

    async function reportListing(listingId){
      if(!currentUser) return alert('Giri≈ü yapmalƒ±sƒ±n.');
      const reason=prompt('≈ûikayet nedeni:'); if(!reason) return;
      await addDoc(collection(db,'reports'),{listingId,reason,reporterId:currentUser.uid,createdAt:serverTimestamp(),handled:false});
      alert('≈ûikayet alƒ±ndƒ±.');
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    // Alt men√º aktif durumu
    const path = location.pathname.split('/').pop() || '';
    if(path.includes('home')) $('navHome').classList.add('active');
    if(path.includes('notifications')) $('navNotif').classList.add('active');
    if(path.includes('messages')) $('navMsg').classList.add('active');
  </script>

  <!-- FIRESTORE RULES (√∂zet)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      function isSignedIn(){ return request.auth != null; }
      function isOwner(uid){ return request.auth != null && request.auth.uid == uid; }

      match /users/{uid} {
        allow read: if true;
        allow create, update: if isOwner(uid);
      }
      match /ratings/{rid} {
        allow read: if true;
        allow create, update: if isSignedIn() && request.resource.data.raterId == request.auth.uid;
      }
      match /listings/{id} {
        allow read: if true;
        allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid && request.resource.data.status == 'pending';
        allow update: if isSignedIn() && (
          (isOwner(resource.data.ownerId) && request.resource.data.status == resource.data.status)
          || (request.auth.token.admin == true)
        );
      }
      match /reports/{id} {
        allow read: if request.auth.token.admin == true; // sadece admin
        allow create: if isSignedIn() && request.resource.data.reporterId == request.auth.uid;
      }
    }
  }
  -->
</body>
</html>
