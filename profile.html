<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Profil ‚Ä¢ Takas √áemberi</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --card:#ffffff; --muted:#5b6b8f; --txt:#111827; --accent:#ff163e; --accent2:#ff5a00;
      --stroke:#d1d5db; --good:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{background:#f8fafc;color:var(--txt);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;display:flex;flex-direction:column}
    a{color:inherit;text-decoration:none}

    .wrap{flex:1;display:flex;flex-direction:column;max-width:1100px;margin:0 auto;padding:16px 16px 88px;width:100%}

    .topbar{position:sticky;top:0;z-index:30;background:#fff;backdrop-filter:blur(8px);border-bottom:1px solid var(--stroke)}
    .topbar .in{display:flex;align-items:center;gap:12px;min-height:64px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px;color:var(--accent)}
    .brand img{height:32px;width:auto}
    .grow{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--stroke);padding:10px 14px;border-radius:14px;background:#fff;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,#ff163e,#ff5a00);border-color:#000;color:#fff;font-weight:700}

    /* 4 renk arka plan */
    .profile{flex:1;display:flex;flex-direction:column;overflow:auto;border:1px solid var(--stroke);
      background:linear-gradient(-45deg,#ff3d71,#ff9f43,#10b981,#3b82f6);
      background-size:400% 400%;animation:gradientShift 16s ease infinite}
    @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    .p-in{display:flex;gap:28px;padding:28px}
    .avatar{width:140px;height:140px;border-radius:34px;border:3px solid #fff;background:#fff;overflow:hidden;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:14px;position:relative}
    .avatar img{width:100%;height:100%;object-fit:cover;display:none}

    .p-meta{display:flex;flex-direction:column;gap:10px}
    .p-name{font-size:32px;font-weight:800;color:#fff;text-shadow:0 2px 14px rgba(0,0,0,.2)}
    .p-username{opacity:.9;color:#fff;text-shadow:0 1px 8px rgba(0,0,0,.2)}

    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--stroke);padding:0 12px;background:#f3f4f6}
    .tab{flex:1;text-align:center;padding:14px;border:1px solid var(--stroke);border-bottom:none;border-top-left-radius:12px;border-top-right-radius:12px;background:#fff;cursor:pointer;font-size:16px}
    .tab.active{background:linear-gradient(180deg,#fff,#f9fafb);font-weight:700;color:var(--accent)}
    .tab .badge{margin-left:6px;background:#fee2e2;border:1px solid #fecaca;padding:2px 8px;border-radius:10px;font-size:12px;color:#b91c1c}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:16px;flex:1}
    .card{background:#fff;border:1px solid var(--stroke);border-radius:16px;overflow:hidden;box-shadow:0 2px 6px #0001}
    .card .hd{padding:10px 12px;border-bottom:1px solid var(--stroke);font-weight:700;display:flex;justify-content:space-between;color:var(--accent)}
    .card .bd{padding:12px}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,4,10,.4);z-index:50}
    .modal.show{display:flex}
    .sheet{width:min(520px,92vw);background:#fff;border:1px solid var(--stroke);border-radius:16px;overflow:hidden}
    .sheet .hd{padding:12px 14px;border-bottom:1px solid var(--stroke);font-weight:800;color:var(--accent);display:flex;justify-content:space-between;align-items:center}
    .sheet .bd{padding:14px}
    .x{border:none;background:transparent;font-size:20px;cursor:pointer}

    /* ALT NAV: Masa√ºst√º + Mobil (ikisi de) */
    .mbar{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-around;align-items:center;padding:10px;background:#fff;border-top:1px solid var(--stroke);z-index:40}
    .mbar a{display:flex;flex-direction:column;align-items:center;font-size:14px;color:var(--txt);text-decoration:none}
    /* NOT: √ñnceden masa√ºst√ºnde gizleyen @media bloƒüu kaldƒ±rƒ±ldƒ± */
  </style>
</head>
<body>
  <header class="topbar">
    <div class="wrap in">
      <a class="brand" href="home.html"><img src="assets/img/seffaf.png" alt="logo">Takas √áemberi</a>
      <div class="grow"></div>
      <!-- √ústteki √áƒ±kƒ±≈ü butonu kaldƒ±rƒ±ldƒ±; ba≈üka ≈üeye dokunulmadƒ± -->
    </div>
  </header>

  <main class="wrap">
    <section class="profile">
      <div class="p-in">
        <div class="avatar" id="avatarBox">
          <img id="avatarImg" alt="avatar"/>
          <input id="fileAvatar" type="file" accept="image/*"/>
        </div>
        <div class="p-meta">
          <div class="p-name" id="pName">‚Äî</div>
          <div class="p-username" id="pUser">@‚Äî</div>
          <div class="row"><button class="btn" id="btnPwd">üîë ≈ûifre Deƒüi≈ütir</button></div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="active">Yayƒ±nda Olan <span class="badge" id="cntActive">0</span></button>
        <button class="tab" data-tab="pending">Onay Bekleyen <span class="badge" id="cntPending">0</span></button>
        <button class="tab" data-tab="expired">S√ºresi Dolan <span class="badge" id="cntExpired">0</span></button>
      </div>

      <div class="grid" id="listings"></div>
    </section>
  </main>

  <!-- ALT NAV: masa√ºst√º + mobil -->
  <div class="mbar">
    <a href="notifications.html">üîî<span>Bildirimler</span></a>
    <a href="home.html">üè†<span>Ana Sayfa</span></a>
    <a href="messages.html">üí¨<span>Mesajlar</span></a>
    <a href="#" id="btnLogout">üö™<span>√áƒ±kƒ±≈ü</span></a>
  </div>

  <!-- ≈ûifre modal -->
  <div class="modal" id="mPwd">
    <div class="sheet">
      <div class="hd">≈ûifre Deƒüi≈ütir <button class="x" data-close="mPwd">‚úñ</button></div>
      <div class="bd">
        <input type="password" id="oldPwd" placeholder="Mevcut ≈ûifre"/>
        <input type="password" id="newPwd1" placeholder="Yeni ≈ûifre"/>
        <input type="password" id="newPwd2" placeholder="Yeni ≈ûifre (Tekrar)"/>
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" data-close="mPwd">ƒ∞ptal</button>
          <button class="btn primary" id="btnDoPwd">Kaydet</button>
        </div>
        <div id="pwdMsg" class="muted" style="margin-top:6px"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, reauthenticateWithCredential, EmailAuthProvider, updatePassword } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

    const firebaseConfig={ apiKey:"AIzaSyBUUNSYxoWNUsK0C-C04qTUm6KM5756fvg",authDomain:"ureten-eller-v2.firebaseapp.com",projectId:"ureten-eller-v2",storageBucket:"ureten-eller-v2.firebasestorage.app",messagingSenderId:"621494781131",appId:"1:621494781131:web:13cc3b061a5e94b7cf874e" };
    const app=getApps().length?getApp():initializeApp(firebaseConfig);
    const auth=getAuth(app);
    const db=getFirestore(app);
    const storage=getStorage(app);

    const qs=s=>document.querySelector(s);
    const qsa=s=>Array.from(document.querySelectorAll(s));

    // modal kapatma
    qsa('[data-close]').forEach(b=> b.addEventListener('click',()=> qs('#'+b.dataset.close).classList.remove('show')));

    // alt bardaki √ßƒ±kƒ±≈ü
    qs('#btnLogout')?.addEventListener('click', async(e)=>{ e.preventDefault(); await signOut(auth); location.href='auth.html'; });

    // ≈üifre modal a√ß
    qs('#btnPwd')?.addEventListener('click',()=> qs('#mPwd').classList.add('show'));

    // ≈üifre deƒüi≈ütir
    qs('#btnDoPwd')?.addEventListener('click',async()=>{
      const msg=qs('#pwdMsg'); msg.textContent='';
      const u=auth.currentUser; if(!u){ msg.textContent='Oturum yok'; return; }
      const o=qs('#oldPwd').value, n1=qs('#newPwd1').value, n2=qs('#newPwd2').value;
      if(!o||!n1||!n2){ msg.textContent='T√ºm alanlarƒ± doldur'; return; }
      if(n1!==n2){ msg.textContent='Yeni ≈üifreler aynƒ± olmalƒ±'; return; }
      try{
        const cred=EmailAuthProvider.credential(u.email,o);
        await reauthenticateWithCredential(u,cred);
        await updatePassword(u,n1);
        msg.textContent='≈ûifre deƒüi≈üti ‚úÖ';
        setTimeout(()=>qs('#mPwd').classList.remove('show'),600);
      }catch(e){ msg.textContent='Hata: '+e.message; }
    });

    // avatar y√ºkle
    const fileAvatar=qs('#fileAvatar'); const avatarImg=qs('#avatarImg');
    fileAvatar.addEventListener('change',async ev=>{
      const f=ev.target.files?.[0]; if(!f) return;
      const u=auth.currentUser; if(!u) return;
      const ref=sRef(storage,`avatars/${u.uid}.jpg`);
      await uploadBytes(ref,f);
      const url=await getDownloadURL(ref);
      await setDoc(doc(db,'users',u.uid),{photoURL:url},{merge:true});
      avatarImg.src=url; avatarImg.style.display='block';
    });

    // sekmeler
    const cntA=qs('#cntActive'),cntP=qs('#cntPending'),cntE=qs('#cntExpired');
    const listingsEl=qs('#listings');
    function render(tab,docs){
      listingsEl.innerHTML=docs.length?docs.map(d=>`<div class='card'><div class='hd'>${d.title||'ƒ∞lan'}<span>${d.status}</span></div><div class='bd'>${d.category||''}</div></div>`).join(''):`<div class='card'><div class='bd'>Bu b√∂l√ºm bo≈ü</div></div>`;
    }
    async function load(uid){
      const [a,p,e]=await Promise.all([
        getDocs(query(collection(db,'listings'),where('owner','==',uid),where('status','==','active'))),
        getDocs(query(collection(db,'listings'),where('owner','==',uid),where('status','==','pending'))),
        getDocs(query(collection(db,'listings'),where('owner','==',uid),where('status','==','expired')))
      ]);
      cntA.textContent=a.size; cntP.textContent=p.size; cntE.textContent=e.size;
      render('active',a.docs.map(d=>d.data()));
      qsa('.tab').forEach(t=> t.onclick=()=>{
        if(t.dataset.tab==='active') render('active',a.docs.map(d=>d.data()));
        if(t.dataset.tab==='pending') render('pending',p.docs.map(d=>d.data()));
        if(t.dataset.tab==='expired') render('expired',e.docs.map(d=>d.data()));
        qsa('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
      });
    }

    import { setDoc as _tmp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js"; // (no-op; import d√ºzeni)

    onAuthStateChanged(auth,async u=>{ if(u){ load(u.uid); } });
  </script>
</body>
</html>
