<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Profil • Takas Çemberi</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --txt:#0b1020; --muted:#2b3b62; --pri:#5b8aff;
      --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --stroke:rgba(0,0,0,.12);
      --g1:#ff7a7a; --g2:#ffd166; --g3:#6ee7ff; --g4:#9b8cff; --g5:#4ade80;
      --card:rgba(255,255,255,.86); --card2:rgba(255,255,255,.94);
      --mbnav-h:72px;
      --star-fill:#ffffff; --star-stroke:#b91c1c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html,body{overflow-x:hidden}
    body{
      margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--txt);
      background:linear-gradient(120deg,var(--g1),var(--g2),var(--g3),var(--g4),var(--g5));
      background-size:300% 300%;animation:gradientShift 18s ease infinite;min-height:100vh
    }
    @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;
      padding-bottom:calc(var(--mbnav-h) + 72px + env(safe-area-inset-bottom,0px));
    }
    header.hd{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 14px;margin-bottom:14px;position:sticky;top:0;background:rgba(255,255,255,.7);backdrop-filter:blur(8px);border:1px solid var(--stroke);border-radius:16px;z-index:50}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:38px;width:38px;border-radius:12px;border:1px solid var(--stroke);object-fit:contain;background:#fff}
    nav.desktop{display:none;gap:8px;align-items:center}
    nav.mobileTop{display:flex;gap:8px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid var(--stroke);padding:10px 14px;border-radius:12px;background:var(--card);color:#0b1020;cursor:pointer}
    .btn.warn{background:transparent;border-color:var(--warn);color:#8a5400}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    #secProfile{order:1}
    #secPassword{order:2}
    #secRating{order:3}
    #secListings{order:4}
    @media(min-width:880px){
      nav.desktop{display:flex} nav.mobileTop{display:none}
      .grid{grid-template-columns:1fr 1fr;grid-template-areas:"left right" "full1 full1" "full2 full2"}
      #secProfile{grid-area:left} #secPassword{grid-area:right} #secRating{grid-area:full1} #secListings{grid-area:full2}
    }
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--stroke);font-weight:800;color:#0b1020;background:var(--card2)}
    .card .bd{padding:16px}
    .profileRow{display:grid;grid-template-columns:96px 1fr;gap:16px;align-items:center}
    .avatar{width:96px;height:96px;border-radius:18px;overflow:hidden;border:1px solid var(--stroke);background:#fff;display:grid;place-items:center}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .fields{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field input{width:100%;height:44px;background:#fff;border:1px solid var(--stroke);border-radius:12px;padding:0 12px}
    .field input[disabled]{opacity:.95}
    @media(max-width:879px){ .fields{grid-template-columns:1fr} }
    .pwgrid{display:grid;grid-template-columns:1fr;gap:10px}
    .pwgrid input{height:44px;background:#fff;border:1px solid var(--stroke);border-radius:12px;padding:0 12px}
    .pwgrid button{height:44px;border:1px solid var(--stroke);border-radius:12px}
    /* Flag-Flip yıldızlar */
    .ownerStars{display:flex;gap:12px;margin-bottom:8px}
    .ownerStars svg{width:34px;height:34px;animation:wave 2s ease-in-out infinite}
    .ownerStars svg:nth-child(2){animation-delay:.2s}
    .ownerStars svg:nth-child(3){animation-delay:.4s}
    .ownerStars svg:nth-child(4){animation-delay:.6s}
    .ownerStars svg:nth-child(5){animation-delay:.8s}
    @keyframes wave{0%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}
    @keyframes starColorFlip{0%,100%{fill:#fff;stroke:#fff}50%{fill:#b91c1c;stroke:#b91c1c}}
    .ownerStars path{animation:starColorFlip 3.5s ease-in-out infinite}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{background:#fff;border-radius:16px;padding:20px;max-width:400px;width:90%}
    .modal input{width:100%;height:44px;border:1px solid var(--stroke);border-radius:8px;padding:0 12px;margin-top:8px}
    .modal .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
    .mbnav{position:fixed;bottom:0;left:0;right:0;height:var(--mbnav-h);display:grid;grid-template-columns:repeat(3,1fr);gap:6px;padding:8px;background:#fff;backdrop-filter:blur(8px);border-top:1px solid var(--stroke);z-index:60}
    .mbnav a{display:flex;flex-direction:column;align-items:center;justify-content:center}
    .mbnav a.active{border:1px solid var(--stroke);border-radius:8px}
    @media(min-width:880px){ .mbnav{display:none} }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hd">
      <div class="brand">
        <img src="./assets/img/seffaf.png" alt="Logo">
        <div>
          <b>Takas Çemberi</b>
          <div class="muted" id="hdrSub">Profil</div>
        </div>
      </div>

      <!-- Masaüstü menü -->
      <nav class="desktop">
        <a class="btn" href="home.html">🏠 Ana Sayfa</a>
        <a class="btn" href="messages.html">💬 Mesajlar</a>
        <a class="btn" href="notifications.html">🔔 Bildirimler</a>
        <button class="btn warn" id="btnLogout">🚪 Çıkış</button>
      </nav>

      <!-- Mobil üst -->
      <nav class="mobileTop">
        <button class="btn warn" id="btnLogoutTop">🚪 Çıkış</button>
      </nav>
    </header>

    <div class="grid">
      <!-- Profil -->
      <section id="secProfile" class="card">
        <div class="hd">Profil</div>
        <div class="bd">
          <div class="profileRow">
            <div class="avatar"><img id="avatar" alt="Profil"></div>
            <div>
              <h2 id="displayName" style="margin:0;font-size:1.4rem">—</h2>
              <span class="badge" id="usernameBadge">@—</span>

              <div class="row" style="margin-top:8px">
                <label class="btn" style="padding:8px 12px">
                  📷 Resim Ekle / Değiştir
                  <input type="file" id="fileAvatar" accept="image/*" style="display:none">
                </label>
              </div>

              <div class="muted" id="publicInfo">Kullanıcı bilgileri aşağıda görünür.</div>
            </div>
          </div>
          <div class="fields" style="margin-top:16px">
            <div class="field"><label>İsim</label><input id="inpFirst" disabled></div>
            <div class="field"><label>Soyisim</label><input id="inpLast" disabled></div>
            <div class="field"><label>Kullanıcı Adı</label><input id="inpUsername" disabled></div>
            <div class="field"><label>Telefon</label><input id="inpPhone" disabled></div>
            <div class="field"><label>E-posta</label><input id="inpEmail" disabled></div>
          </div>
        </div>
      </section>

      <!-- Şifre -->
      <section id="secPassword" class="card">
        <div class="hd">Şifre Değiştir</div>
        <div class="bd">
          <div class="pwgrid">
            <input type="password" id="pwOld" placeholder="Mevcut şifre">
            <input type="password" id="pwNew" placeholder="Yeni şifre">
            <input type="password" id="pwNew2" placeholder="Yeni şifre (tekrar)">
            <button class="btn pri" id="btnPw">Değişikliği Onayla</button>
            <div class="muted">• Eski şifre sorulur. • Yeni şifre iki kez girilir.</div>
          </div>
        </div>
      </section>

      <!-- Puanlama -->
      <section id="secRating" class="card">
        <div class="hd">Puanlama</div>
        <div class="bd">
          <div class="ownerStars" id="ownerStars">
            <svg viewBox="0 0 24 24"><path d="M12 2.5l2.6 5.3 5.9.86-4.25 4.14 1 5.86L12 16.9 6.75 18.7l1-5.86L3.5 8.66l5.9-.86L12 2.5z"/></svg>
            <svg viewBox="0 0 24 24"><path d="M12 2.5l2.6 5.3 5.9.86-4.25 4.14 1 5.86L12 16.9 6.75 18.7l1-5.86L3.5 8.66l5.9-.86L12 2.5z"/></svg>
            <svg viewBox="0 0 24 24"><path d="M12 2.5l2.6 5.3 5.9.86-4.25 4.14 1 5.86L12 16.9 6.75 18.7l1-5.86L3.5 8.66l5.9-.86L12 2.5z"/></svg>
            <svg viewBox="0 0 24 24"><path d="M12 2.5l2.6 5.3 5.9.86-4.25 4.14 1 5.86L12 16.9 6.75 18.7l1-5.86L3.5 8.66l5.9-.86L12 2.5z"/></svg>
            <svg viewBox="0 0 24 24"><path d="M12 2.5l2.6 5.3 5.9.86-4.25 4.14 1 5.86L12 16.9 6.75 18.7l1-5.86L3.5 8.66l5.9-.86L12 2.5z"/></svg>
          </div>
          <div class="muted" id="avgText">0/5 • 0 oy</div>
        </div>
      </section>

      <!-- İlanlar -->
      <section id="secListings" class="card">
        <div class="hd">İlanlar</div>
        <div class="bd">
          <div class="mobile-tabs">
            <button class="pill active" data-target="colActive">Yayındakiler</button>
            <button class="pill" data-target="colPending">Onay Bekleyenler</button>
            <button class="pill" data-target="colExpired">Süresi Dolanlar</button>
          </div>

          <div class="lists-triple">
            <div class="col show" id="colActive">
              <h3>Yayındakiler</h3>
              <div class="listings" id="listActive"></div>
            </div>
            <div class="col" id="colPending">
              <h3>Onay Bekleyenler</h3>
              <div class="listings" id="listPending"></div>
            </div>
            <div class="col" id="colExpired">
              <h3>Süresi Dolanlar</h3>
              <div class="listings" id="listExpired"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Mobil alt bar -->
  <nav class="mbnav">
    <a href="home.html" class="active">🏠<small>Ana Sayfa</small></a>
    <a href="messages.html">💬<small>Mesajlar</small></a>
    <a href="notifications.html">🔔<small>Bildirimler</small></a>
  </nav>

  <!-- Kullanıcı adı seçme modalı -->
  <div class="modal-backdrop" id="usernameModal">
    <div class="modal">
      <h3>Kullanıcı Adı Seç</h3>
      <input type="text" id="newUsername" placeholder="kullanıcı adın">
      <div class="actions">
        <button class="btn" id="cancelUsername">İptal</button>
        <button class="btn pri" id="saveUsername">Kaydet</button>
      </div>
      <div class="muted" style="margin-top:6px">Bir defaya mahsus belirleyebilirsin.</div>
    </div>
  </div>
  <!-- Firebase (CDN, modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUUNSYxoWNUsK0C-C04qTUm6KM5756fvg",
      authDomain: "ureten-eller-v2.firebaseapp.com",
      projectId: "ureten-eller-v2",
      storageBucket: "ureten-eller-v2.firebasestorage.app",
      messagingSenderId: "621494781131",
      appId: "1:621494781131:web:13cc3b061a5e94b7cf874e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    function setInput(id, val){ const el = $(id); if(el) el.value = val || ''; }
    function setText(id, val){ const el = $(id); if(el) el.textContent = (val && String(val).trim()) ? val : '—'; }

    function fillFields(data={}, user=null){
      const first = data.firstName || '';
      const last  = data.lastName  || '';
      const uname = data.username  || '';
      const phone = data.phone     || '';
      const email = data.email || user?.email || '';

      setText('#displayName', `${first} ${last}`.trim() || '—');
      setText('#usernameBadge', uname ? '@'+uname : '@—');
      setInput('#inpFirst', first);
      setInput('#inpLast',  last);
      setInput('#inpUsername', uname);
      setInput('#inpPhone', phone);
      setInput('#inpEmail', email);
    }

    // Avatar
    const AVATAR_KEY = 'tc_profile_avatar';
    const avatar = $('#avatar');
    (function(){
      const saved = localStorage.getItem(AVATAR_KEY);
      avatar.src = saved || 'https://dummyimage.com/300x300/ffffff/000&text=👤';
      $('#fileAvatar')?.addEventListener('change', e=>{
        const f = e.target.files?.[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = ()=>{ avatar.src = reader.result; localStorage.setItem(AVATAR_KEY, reader.result); };
        reader.readAsDataURL(f);
      });
    })();

    // Çıkış
    async function doLogout(){ try{ await signOut(auth);}catch{} location.href='auth.html'; }
    $('#btnLogout')?.addEventListener('click', doLogout);
    $('#btnLogoutTop')?.addEventListener('click', doLogout);

    // Modal helper
    function openModal(){ $('#usernameModal').style.display='flex'; }
    function closeModal(){ $('#usernameModal').style.display='none'; }

    $('#cancelUsername')?.addEventListener('click', closeModal);
    $('#saveUsername')?.addEventListener('click', async ()=>{
      const val = $('#newUsername').value.trim().toLowerCase();
      if(!val) return;
      const user = auth.currentUser;
      if(!user) return;
      try{
        await setDoc(doc(db,'usernames',val),{uid:user.uid});
        await setDoc(doc(db,'users',user.uid),{username:val,email:user.email,firstName:user.displayName?.split(' ')[0]||'',lastName:user.displayName?.split(' ')[1]||''},{merge:true});
        closeModal();
        location.reload();
      }catch(err){ alert("Bu kullanıcı adı alınmış olabilir."); }
    });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ fillFields(); return; }
      try{
        const ref = doc(db,'users',user.uid);
        const snap = await getDoc(ref);
        if(snap.exists()){
          const data = snap.data();
          fillFields(data,user);
          if(!data.username){ openModal(); }
        }else{
          // yeni kullanıcı
          const nameParts = (user.displayName||'').split(' ');
          await setDoc(ref,{email:user.email,firstName:nameParts[0]||'',lastName:nameParts[1]||''});
          fillFields({},user);
          openModal();
        }
      }catch(e){
        console.error(e);
        fillFields({},user);
      }
    });

    // Ortalama yıldız (dummy)
    function setAvgStars(val){
      $('#avgText').textContent = `${val}/5 • 0 oy`;
    }
    setAvgStars(0);
  </script>
</body>
</html>
