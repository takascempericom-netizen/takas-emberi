<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profil • Takas Çemberi</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0a0a; --card:#111418; --muted:#8aa0b8; --line:#1f2630;
      --ok:#00d084; --warn:#f59e0b; --err:#ef4444; --brand:#ff002b; --chip:#18202b;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 700px at 100% -10%, #1d0a0c 10%, transparent 60%),
               radial-gradient(1200px 700px at -10% 120%, #0a1321 10%, transparent 60%),
               linear-gradient(180deg, #0a0f16, #0a0a0a);
      color:#e8eef6; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:1100px; margin:0 auto; padding:20px 16px 100px}

    .topbar{position:sticky; top:0; backdrop-filter:saturate(1.2) blur(6px); background:linear-gradient(180deg, rgba(10,10,10,.9), rgba(10,10,10,.65)); z-index:20; border-bottom:1px solid var(--line)}
    .topbar .row{display:flex; align-items:center; gap:12px; padding:14px 16px; max-width:1100px; margin:0 auto}
    .logo{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
    .logo .flag{position:relative; width:30px; height:20px; border-radius:4px; background:#e10600; box-shadow:0 0 24px rgba(255,0,43,.35) inset, 0 8px 22px rgba(255,0,43,.18)}
    .logo .flag:before{content:""; position:absolute; inset:0; background:radial-gradient(60% 120% at 20% 40%, rgba(255,255,255,.3), transparent 60%)}
    .logo .flag:after{content:"★ ★ ★ ★ ★"; position:absolute; left:3px; right:3px; top:1px; font-size:10px; color:#fff; opacity:.95; filter:drop-shadow(0 1px 2px rgba(0,0,0,.5)); animation:wave 3s ease-in-out infinite}
    @keyframes wave{0%,100%{transform:translateY(0)}50%{transform:translateY(1px)}}

    .sp{flex:1}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:#121821; color:#e8eef6; font-weight:600; cursor:pointer; transition:.2s box-shadow,.2s transform,.2s background}
    .btn:hover{box-shadow:0 6px 18px rgba(17,24,33,.35); transform:translateY(-1px)}
    .btn.red{background:linear-gradient(180deg,#ff2246,#e10600); border-color:#ff3a62}
    .btn.ghost{background:transparent}

    .grid{display:grid; grid-template-columns:360px 1fr; gap:18px}
    @media (max-width:940px){.grid{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); border:1px solid var(--line); border-radius:16px; overflow:hidden}
    .card .hd{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line); font-weight:700; letter-spacing:.3px}
    .card .bd{padding:14px 16px}
    .muted{color:var(--muted)}
    .row{display:flex; gap:12px; align-items:center}

    .avatar{position:relative; width:108px; height:108px; border-radius:20px; overflow:hidden; border:2px solid #243246; background:#0d1117}
    .avatar img{width:100%; height:100%; object-fit:cover}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-weight:600; background:var(--chip); border:1px solid var(--line)}
    .name{font-size:20px; font-weight:800}
    .uname{font-weight:700; color:#fff; background:linear-gradient(180deg,#fff,#cfe9ff); -webkit-background-clip:text; background-clip:text; color:transparent}

    .inputs{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .inputs .col{display:flex; flex-direction:column; gap:6px}
    .inputs label{font-size:12px; color:var(--muted)}
    .inputs input{height:40px; border-radius:10px; background:#0f131a; border:1px solid var(--line); color:#e8eef6; padding:0 12px; outline:none}

    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tabs .t{padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:#0f1520; cursor:pointer; font-weight:700}
    .tabs .t.active{background:linear-gradient(180deg,#ff2246,#e10600); border-color:#ff3a62}

    .list{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; margin-top:10px}
    @media (max-width:720px){.list{grid-template-columns:1fr}}
    .it{display:flex; gap:10px; padding:10px; border:1px solid var(--line); border-radius:14px; background:#0d121a}
    .it .ph{width:76px; height:76px; border-radius:10px; background:#0a0f16; overflow:hidden}
    .it .ph img{width:100%; height:100%; object-fit:cover}
    .it .ttl{font-weight:700}
    .tag{font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--line)}
    .tag.green{background:rgba(0,208,132,.12); border-color:rgba(0,208,132,.4)}
    .tag.orange{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.45)}
    .tag.red{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.45)}

    .bottomnav{position:fixed; left:0; right:0; bottom:0; backdrop-filter:saturate(1.2) blur(6px); background:linear-gradient(0deg, rgba(10,10,10,.92), rgba(10,10,10,.6)); border-top:1px solid var(--line); z-index:30}
    .bottomnav .row{max-width:1100px; margin:0 auto; display:grid; grid-template-columns:repeat(3,1fr); gap:8px; padding:8px 16px}
    .bottomnav a{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; padding:8px 6px; border-radius:12px; border:1px solid transparent; font-weight:700}
    .bottomnav a:hover{border-color:var(--line); background:#0f1622}

    .divider{height:1px; background:var(--line); margin:10px 0}
    .right{display:flex; align-items:center; gap:8px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="row">
      <div class="logo"><span class="flag"></span><span>Takas Çemberi</span></div>
      <div class="sp"></div>
      <a id="btnHome" class="btn ghost" href="home.html">🏠 Ana Sayfa</a>
      <button id="btnLogout" class="btn red hidden">🚪 Çıkış</button>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- Profil Kartı -->
      <section class="card" id="profileCard">
        <div class="hd">Profil</div>
        <div class="bd">
          <div class="row" style="align-items:flex-start">
            <div class="avatar"><img id="avatarImg" alt="profil" src=""/></div>
            <div style="flex:1; min-width:240px">
              <div class="name" id="name">—</div>
              <div class="row" style="flex-wrap:wrap; gap:8px; margin:6px 0 8px">
                <span class="chip">@<span id="username">—</span></span>
                <span class="chip"><small class="muted">Üyelik:</small> <span id="provider">—</span></span>
              </div>
              <div class="muted" style="font-size:13px">E-posta: <span id="email">—</span></div>
              <div class="divider"></div>

              <div class="inputs">
                <div class="col" style="grid-column:span 2">
                  <label>Profil Fotoğrafı</label>
                  <input type="file" id="avatarFile" accept="image/*" />
                  <div class="row"><button class="btn" id="btnUploadAvatar">📷 Yükle</button><span class="muted" id="avatarMsg"></span></div>
                </div>
                <div class="col">
                  <label>Ad</label>
                  <input id="inpFirst" placeholder="Ad" />
                </div>
                <div class="col">
                  <label>Soyad</label>
                  <input id="inpLast" placeholder="Soyad" />
                </div>
                <div class="col">
                  <label>Kullanıcı Adı (1 defa değiştirilebilir)</label>
                  <input id="inpUname" placeholder="ornek_kullanici" />
                </div>
                <div class="col">
                  <label>Telefon</label>
                  <input id="inpPhone" placeholder="5xx xxx xx xx" />
                </div>
              </div>
              <div class="row" style="margin-top:10px">
                <button class="btn" id="btnSave">💾 Kaydet</button>
                <span class="muted" id="saveMsg"></span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- İlanlar Kartı -->
      <section class="card" style="grid-column:1/-1">
        <div class="hd">
          <span>İlanlarım</span>
          <div class="right muted" id="counts">—</div>
        </div>
        <div class="bd">
          <div class="tabs">
            <button class="t active" data-tab="active">Yayında</button>
            <button class="t" data-tab="pending">Onay Bekleyen</button>
            <button class="t" data-tab="expired">Süresi Biten</button>
          </div>
          <div class="list" id="list"></div>
          <div class="row" style="margin-top:10px">
            <a class="btn" href="ilan-ekle.html">➕ Yeni İlan Ekle</a>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Alt Gezinme -->
  <nav class="bottomnav">
    <div class="row">
      <a href="home.html">🏠 <span>Ana Sayfa</span></a>
      <a href="messages.html">💬 <span>Mesajlar</span></a>
      <a href="notifications.html">🔔 <span>Bildirimler</span></a>
    </div>
  </nav>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

    // Firebase config (senin verdiğin)
    const firebaseConfig = {
      apiKey: "AIzaSyBUUNSYxoWNUsK0C-C04qTUm6KM5756fvg",
      authDomain: "ureten-eller-v2.firebaseapp.com",
      projectId: "ureten-eller-v2",
      storageBucket: "ureten-eller-v2.firebasestorage.app",
      messagingSenderId: "621494781131",
      appId: "1:621494781131:web:13cc3b061a5e94b7cf874e"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // UI refs
    const el = (id)=>document.getElementById(id);
    const avatarImg = el('avatarImg');
    const avatarFile = el('avatarFile');
    const avatarMsg = el('avatarMsg');
    const nameEl = el('name');
    const usernameEl = el('username');
    const emailEl = el('email');
    const providerEl = el('provider');
    const btnSave = el('btnSave');
    const saveMsg = el('saveMsg');
    const inpFirst = el('inpFirst');
    const inpLast  = el('inpLast');
    const inpUname = el('inpUname');
    const inpPhone = el('inpPhone');
    const btnUploadAvatar = el('btnUploadAvatar');
    const counts = el('counts');
    const listEl = el('list');

    const btnLogout = el('btnLogout');

    // Helpers
    const sanitizeUname = (s)=> (s||'').toLowerCase().replace(/[^a-z0-9_\\.]/g,'_').replace(/^_+|_+$/g,'').slice(0,24);
    const byId = (uid)=>doc(db,'users',uid);

    // Çıkış
    btnLogout.addEventListener('click', ()=>signOut(auth));

    // Avatar upload
    btnUploadAvatar.addEventListener('click', async()=>{
      const f = avatarFile.files?.[0];
      if(!auth.currentUser){ return alert('Önce giriş yapın'); }
      if(!f){ return alert('Bir resim seçin'); }
      if(f.size > 4*1024*1024) return alert('Maksimum 4MB');
      avatarMsg.textContent = 'Yükleniyor…';
      try{
        const r = ref(storage, `users/${auth.currentUser.uid}/avatar.jpg`);
        await uploadBytes(r, f, {contentType: f.type});
        const url = await getDownloadURL(r);
        avatarImg.src = url;
        await updateDoc(byId(auth.currentUser.uid), { photoURL:url, updatedAt: serverTimestamp() });
        avatarMsg.textContent = 'Güncellendi.';
      }catch(e){ avatarMsg.textContent = 'Hata: '+e.message; }
    });

    // Save profile (name, phone, username once)
    btnSave.addEventListener('click', saveProfileOnce);

    async function saveProfileOnce(){
      const u = auth.currentUser; if(!u) return alert('Giriş gerekli');
      saveMsg.textContent = 'Kaydediliyor…';
      try{
        const userRef = byId(u.uid);
        const snap = await getDoc(userRef);
        const data = snap.exists()? snap.data(): {};

        let nextUname = sanitizeUname(inpUname.value);
        const wantUnameChange = nextUname && nextUname !== (data.username||'');

        if(wantUnameChange){
          if(data.canChangeUsername === false){
            saveMsg.textContent = 'Kullanıcı adını sadece 1 defa değiştirebilirsiniz.'; return;
          }
          const q = query(collection(db,'users'), where('username','==', nextUname));
          const qs = await getDocs(q);
          if(!qs.empty){ saveMsg.textContent = 'Bu kullanıcı adı alınmış.'; return; }
        }

        await updateDoc(userRef, {
          firstName: (inpFirst.value||'').trim(),
          lastName:  (inpLast.value||'').trim(),
          phone:     (inpPhone.value||'').trim(),
          ...(wantUnameChange? { username: nextUname, canChangeUsername:false }:{}),
          updatedAt: serverTimestamp(),
        });
        saveMsg.textContent = 'Kaydedildi.';
        if(wantUnameChange){ usernameEl.textContent = nextUname; }
      }catch(e){ saveMsg.textContent = 'Hata: '+e.message; }
    }

    // Listings
    let myListings = [];
    async function fetchMyListings(){
      const u = auth.currentUser; if(!u) return;
      const q1 = query(collection(db,'listings'), where('ownerId','==', u.uid));
      const qs = await getDocs(q1);
      myListings = qs.docs.map(d=>({ id:d.id, ...d.data() }));
      renderCounts();
      renderMyListings();
    }
    function renderCounts(){
      const a = myListings.filter(x=>x.status==='active').length;
      const p = myListings.filter(x=>x.status==='pending').length;
      const e = myListings.filter(x=>x.status==='expired').length;
      counts.textContent = `Yayında: ${a} • Onay bekleyen: ${p} • Süresi biten: ${e}`;
    }
    function renderMyListings(){
      const activeTab = document.querySelector('.tabs .t.active')?.dataset.tab || 'active';
      const items = myListings.filter(x=>x.status===activeTab);
      listEl.innerHTML = items.map(x=>{
        const img = (x.images && x.images[0]) || x.coverImage || '';
        const tag = x.status==='active' ? '<span class="tag green">Yayında</span>' : (x.status==='pending' ? '<span class="tag orange">Onay Bekliyor</span>' : '<span class="tag red">Süresi Bitti</span>');
        return `<div class="it">
          <div class="ph">${img?`<img src="${img}" alt="${x.title||''}">`:' '}</div>
          <div style="flex:1; min-width:0">
            <div class="row" style="justify-content:space-between">
              <div class="ttl">${x.title||'İsimsiz İlan'}</div>
              ${tag}
            </div>
            <div class="muted" style="font-size:12px; margin-top:4px">${x.category||'Kategori'} • ${x.city||'Şehir'}</div>
          </div>
        </div>`;
      }).join('') || '<div class="muted">Bu sekmede ilan yok.</div>';
    }
    const tabBtns = Array.from(document.querySelectorAll('.tabs .t'));
    tabBtns.forEach(b=>b.addEventListener('click',()=>{ tabBtns.forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderMyListings(); }));

    // ensure user doc + default username
    async function ensureUserDoc(u){
      const userRef = byId(u.uid);
      const snap = await getDoc(userRef);
      const providerId = (u.providerData[0]?.providerId)||'password';
      const isGoogle = providerId.includes('google');
      const emailLocal = (u.email||'').split('@')[0];
      const derivedUname = sanitizeUname(emailLocal);
      if(!snap.exists()){
        await setDoc(userRef, {
          uid: u.uid,
          email: u.email || '',
          displayName: u.displayName || '',
          firstName: (u.displayName||'').split(' ')[0]||'',
          lastName:  (u.displayName||'').split(' ').slice(1).join(' ')||'',
          username: isGoogle ? derivedUname : (derivedUname||''),
          canChangeUsername: true,
          photoURL: u.photoURL || '',
          provider: isGoogle? 'Google':'Email/Parola',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        });
      }
      return { isGoogle, providerId };
    }

    // Profili doldur
    async function fillProfile(u){
      const userRef = byId(u.uid);
      const snap = await getDoc(userRef);
      const data = snap.exists()? snap.data() : {};

      avatarImg.src = data.photoURL || u.photoURL || 'https://i.pravatar.cc/160?img=3';
      const fullName = ((data.firstName||'') + (data.lastName? ' '+data.lastName:'')).trim();
      nameEl.textContent = fullName || (u.displayName||'İsimsiz');
      usernameEl.textContent = data.username || 'kullanici';
      providerEl.textContent = data.provider || ((u.providerData[0]?.providerId||'password').includes('google')?'Google':'Email/Parola');
      emailEl.textContent = u.email||'';

      inpFirst.value = data.firstName||'';
      inpLast.value  = data.lastName||'';
      inpUname.value = data.username||'';
      inpPhone.value = data.phone||'';

      await fetchMyListings();
    }

    // Auth state (giriş yoksa auth.html'e at)
    onAuthStateChanged(auth, async (u)=>{
      if(!u){ window.location.href = 'auth.html'; return; }
      btnLogout.classList.remove('hidden');
      await ensureUserDoc(u);
      await fillProfile(u);
    });
  </script>
</body>
</html>
