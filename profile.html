<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profil ‚Ä¢ Takas √áemberi</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0b10; --card:#12131a; --muted:#6b7a99; --txt:#f6f7fb; --accent:#ff1f3d;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#0b0b10;color:var(--txt);font:15px/1.6 Inter,system-ui,Segoe UI,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:16px 16px 96px}
    header.hd{display:flex;align-items:center;gap:16px;padding:16px;border:1px solid #222;border-radius:20px;background:#111420;flex-wrap:wrap}
    .avatar{position:relative;width:96px;height:96px;border-radius:50%;background:#0e0f16;border:2px solid #22263a;overflow:hidden;cursor:pointer}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .info{flex:1;min-width:200px}
    .info h1{font-size:22px;margin:0 0 4px}
    .handle{opacity:.9;color:#cfd4ff;font-weight:700}
    .row{display:flex;gap:16px;flex-wrap:wrap;margin-top:16px}
    .card{flex:1 1 280px;border:1px solid #222;border-radius:20px;background:#141827;padding:16px}
    .card h2{margin:0 0 12px;font-size:17px}
    label{display:block;font-size:13px;color:var(--muted);margin:8px 0 4px}
    input{width:100%;padding:10px;border-radius:12px;border:1px solid #24273a;background:#0f1220;color:var(--txt)}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid #2a2e46;background:#171b2b;color:#fff;font-weight:700;cursor:pointer;display:inline-block;margin-top:8px}
    .btn.primary{background:linear-gradient(180deg,#ff3956,#ff1f3d);border-color:#ff3d5b}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .stars3d{display:flex;gap:8px;align-items:center;margin-top:6px}
    .star{width:30px;height:30px;display:grid;place-items:center;border-radius:6px;background:#0f1320;border:1px solid #24293d;cursor:pointer;transition:.15s}
    .star:hover{transform:translateY(-1px)}
    .star.active{background:var(--accent)}
    .btmnav{position:fixed;left:0;right:0;bottom:0;background:#0b0b10;border-top:1px solid #1f2234}
    .btmnav .bar{max-width:980px;margin:0 auto;display:grid;grid-template-columns:repeat(3,1fr)}
    .btmnav a{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px 6px;color:#cfd4ff;font-weight:700}
    .btmnav a.active{color:#fff}
    @media(max-width:600px){
      .row{flex-direction:column}
      header.hd{flex-direction:column;align-items:flex-start}
      .btn{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hd">
      <div class="avatar" id="avatarArea" title="Resim Se√ß">
        <img id="avatarImg" alt="Profil Fotoƒürafƒ±" src="">
      </div>
      <div class="info">
        <h1 id="fullName">‚Äî</h1>
        <div class="handle" id="handle">@kullanici</div>
        <div class="stars3d" id="starsBlock"></div>
      </div>
      <button class="btn" id="btnLogout">üö™ √áƒ±kƒ±≈ü</button>
    </header>

    <div class="row">
      <section class="card">
        <h2>≈ûifre Deƒüi≈ütir</h2>
        <label>Yeni ≈ûifre</label>
        <input id="inpPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <button class="btn primary" id="btnPass">≈ûifreyi G√ºncelle</button>
      </section>
    </div>
  </div>

  <nav class="btmnav">
    <div class="bar">
      <a href="home.html" id="navHome">üè† Ana Sayfa</a>
      <a href="notifications.html" id="navNotif">üîî Bildirimler</a>
      <a href="messages.html" id="navMsg">üí¨ Mesajlar</a>
    </div>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, updatePassword, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

    // ‚Äî‚Äî‚Äî Firebase Config (senin verdiƒüin) ‚Äî‚Äî‚Äî
    const firebaseConfig = {
      apiKey: "AIzaSyBUUNSYxoWNUsK0C-C04qTUm6KM5756fvg",
      authDomain: "ureten-eller-v2.firebaseapp.com",
      projectId: "ureten-eller-v2",
      storageBucket: "ureten-eller-v2.appspot.com",
      messagingSenderId: "621494781131",
      appId: "1:621494781131:web:13cc3b061a5e94b7cf874e"
    };

    // ‚Äî‚Äî‚Äî Firebase init ‚Äî‚Äî‚Äî
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ‚Äî‚Äî‚Äî DOM ‚Äî‚Äî‚Äî
    const avatarImg = document.getElementById('avatarImg');
    const avatarArea = document.getElementById('avatarArea');
    const btnPass    = document.getElementById('btnPass');
    const inpPass    = document.getElementById('inpPass');
    const starsBlock = document.getElementById('starsBlock');

    let currentUser = null;
    let targetUserId = null;

    // ‚Äî‚Äî‚Äî Auth state ‚Äî‚Äî‚Äî
    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = 'auth.html?next=profile.html'; return; }
      currentUser = user;
      targetUserId = user.uid; // bu sayfa kendi profilini g√∂steriyor

      document.getElementById('fullName').textContent = user.displayName || '‚Äî';
      document.getElementById('handle').textContent = '@' + (user.email ? user.email.split('@')[0] : 'kullanici');
      avatarImg.src = user.photoURL || 'https://i.pravatar.cc/200?img=8';

      // Kendi profili: oylama pasif
      renderStars(starsBlock, 0, true);
    });

    // ‚Äî‚Äî‚Äî ≈ûifre g√ºncelle ‚Äî‚Äî‚Äî
    btnPass.addEventListener('click', async () => {
      if (!(currentUser && inpPass.value)) return;
      btnPass.disabled = true; const oldTxt = btnPass.textContent; btnPass.textContent = 'G√ºncelleniyor‚Ä¶';
      try {
        await updatePassword(currentUser, inpPass.value);
        alert('≈ûifre g√ºncellendi');
        inpPass.value = '';
      } catch (err) {
        if (err?.code === 'auth/requires-recent-login') {
          await sendPasswordResetEmail(auth, currentUser.email);
          alert('G√ºvenlik doƒürulamasƒ± gerekiyor. E-postana ≈üifre sƒ±fƒ±rlama baƒülantƒ±sƒ± g√∂nderdik.');
        } else {
          alert('Hata: ' + (err?.message || err));
        }
      } finally {
        btnPass.disabled = false; btnPass.textContent = oldTxt;
      }
    });

    // ‚Äî‚Äî‚Äî √áƒ±kƒ±≈ü ‚Äî‚Äî‚Äî
    document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

    // ‚Äî‚Äî‚Äî Avatar: galeriden se√ß & Storage‚Äôa y√ºkle ‚Äî‚Äî‚Äî
    avatarArea.addEventListener('click', async () => {
      if (!currentUser) return;
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async (e) => {
        const file = e.target.files?.[0]; if (!file) return;
        try {
          const r = ref(storage, `profile_photos/${currentUser.uid}.jpg`);
          await uploadBytes(r, file);
          const url = await getDownloadURL(r);
          await setDoc(doc(db, 'users', currentUser.uid), { photoURL: url, updatedAt: serverTimestamp() }, { merge: true });
          avatarImg.src = url;
        } catch (err) {
          alert('Y√ºkleme hatasƒ±: ' + (err?.message || err));
        }
      };
      input.click();
    });

    // ‚Äî‚Äî‚Äî YILDIZ OYLAMA (avg g√∂stermiyoruz; bu sayfa kendi profilinde pasif) ‚Äî‚Äî‚Äî
    function renderStars(container, current = 0, disabled = false) {
      container.innerHTML = '';
      for (let i = 1; i <= 5; i++) {
        const s = document.createElement('div');
        s.className = 'star' + (i <= current ? ' active' : '');
        s.title = i + ' yƒ±ldƒ±z';
        const ico = document.createElement('i');
        ico.style.fontStyle = 'normal';
        ico.textContent = '‚òÖ';
        s.appendChild(ico);
        if (disabled) s.style.cursor = 'not-allowed';
        container.appendChild(s);
      }
    }

    // ‚Äî‚Äî‚Äî Alt men√º aktif durumu ‚Äî‚Äî‚Äî
    const path = location.pathname.split('/').pop() || '';
    if (path.includes('home')) document.getElementById('navHome').classList.add('active');
    if (path.includes('notifications')) document.getElementById('navNotif').classList.add('active');
    if (path.includes('messages')) document.getElementById('navMsg').classList.add('active');
  </script>

  <!-- FIRESTORE RULES (√∂zet)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      function isSignedIn(){ return request.auth != null; }
      function isOwner(uid){ return request.auth != null && request.auth.uid == uid; }

      match /users/{uid} {
        allow read: if true;
        allow create, update: if isOwner(uid);
      }
      match /ratings/{rid} {
        allow read: if true;
        allow create, update: if isSignedIn() && request.resource.data.raterId == request.auth.uid;
      }
    }
  }
  -->
</body>
</html>
