<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profil ‚Ä¢ Takas √áemberi</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --fg:#0b0b0b; --muted:#6b7280; --line:#e6e8ee; --red:#e10600; --redDark:#b70500; }
    *{box-sizing:border-box} html,body{height:100%;}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--fg);
      background:linear-gradient(135deg,#fff0f0,#fffbe7,#e7f8ff,#f3e7ff);background-size:400% 400%;animation:bgAnim 18s ease infinite;}
    @keyframes bgAnim{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    a{text-decoration:none;color:inherit}
    .wrap{max-width:980px;margin:0 auto;padding:16px 16px 120px;}
    .header{display:flex;align-items:center;gap:16px;margin:8px 0 16px}
    .h1{font-size:22px;font-weight:800} .sub{font-size:13px;color:var(--muted)}
    .card{background:#fff;border:1px solid var(--line);border-radius:20px;box-shadow:0 6px 18px rgba(0,0,0,.06);overflow:hidden;margin-bottom:12px}
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:700}
    .card .bd{padding:16px}
    .profile{display:grid;grid-template-columns:96px 1fr;gap:16px;align-items:center}
    .avatar{width:96px;height:96px;border-radius:999px;border:3px solid #fff;box-shadow:0 8px 20px rgba(0,0,0,.12);background:#f3f4f6;position:relative;overflow:hidden;cursor:pointer}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .ava-btn{position:absolute;bottom:6px;right:6px;background:var(--red);color:#fff;border:none;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
    .uname{font-weight:700;color:#111827;font-size:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px} @media (max-width:840px){.grid{grid-template-columns:1fr}}
    label{font-size:12px;color:#4b5563;margin-bottom:6px;display:block}
    input{font:inherit;width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:12px;background:#fff}
    input:focus{outline:none;border-color:#d1d5db;box-shadow:0 0 0 4px rgba(225,6,0,.08)}
    .btn{padding:11px 14px;border-radius:12px;border:1px solid var(--line);cursor:pointer;background:var(--red);color:#fff;font-weight:700}
    .tabs{display:flex;gap:8px;justify-content:space-around;margin-bottom:12px}
    .tab{flex:1;text-align:center;padding:12px;border:1px solid var(--line);border-radius:12px;font-size:14px;cursor:pointer;background:#fff;transition:.2s;min-height:44px;user-select:none}
    .tab.active{background:var(--red);border-color:var(--redDark);color:#fff;font-weight:700}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .listing{border:1px solid var(--line);border-radius:16px;overflow:hidden;background:#fff}
    .listing .ph{aspect-ratio:16/10;background:#f3f4f6;position:relative;overflow:hidden}
    .listing .ph img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block}
    .listing .ttl{padding:10px 12px;font-weight:700}
    .bottom{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(3,1fr);z-index:50}
    .tabb{padding:10px 8px;text-align:center;display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center}
    .tabb .ico{font-size:18px} .tabb .lbl{font-size:11px;color:#374151} .tabb.active .lbl{color:var(--red)}
    .toast{position:fixed;left:50%;bottom:100px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 12px;border-radius:10px;font-size:13px;display:none}
    .toast.ok{background:#065f46}.toast.err{background:#7f1d1d}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="h1">Profil</div>
      <div class="sub">Ger√ßek ad gizli ‚Ä¢ Herkese a√ßƒ±k: @kullanici, avatar, ≈üehir</div>
    </div>

    <div class="card" id="cardProfile">
      <div class="hd">Hesap √ñzeti</div>
      <div class="bd profile">
        <div class="avatar" id="avatarBox" title="Profil fotoƒürafƒ±nƒ± deƒüi≈ütir">
          <img id="avatarImg" alt="Profil fotoƒürafƒ±" src="assets/img/seffaf.png">
          <button class="ava-btn" id="btnPick">üì∑</button>
          <input type="file" id="fileInput" accept="image/*" hidden>
        </div>
        <div>
          <div class="uname" id="uname">@kullanici</div>
          <div class="sub" id="emailLbl">‚Äì</div>
          <div class="note">Ger√ßek ad ve telefon √∂zel alanda saklanƒ±r.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">Bilgiler</div>
      <div class="bd">
        <div class="grid">
          <div>
            <label for="username">Kullanƒ±cƒ± Adƒ± (herkese a√ßƒ±k)</label>
            <input id="username" placeholder="ornek_kullanici" maxlength="24" />
          </div>
          <div>
            <label for="city">≈ûehir (herkese a√ßƒ±k)</label>
            <input id="city" placeholder="ƒ∞l / ƒ∞l√ße" />
          </div>
          <div>
            <label for="fname">ƒ∞sim (√∂zel)</label>
            <input id="fname" placeholder="Sadece sen ve admin g√∂r√ºr" />
          </div>
          <div>
            <label for="lname">Soyisim (√∂zel)</label>
            <input id="lname" placeholder="Sadece sen ve admin g√∂r√ºr" />
          </div>
          <div>
            <label for="phone">Telefon (√∂zel)</label>
            <input id="phone" placeholder="05xx ..." />
          </div>
          <div>
            <label for="email">E-posta</label>
            <input id="email" disabled />
          </div>
        </div>
        <div style="margin-top:14px">
          <button class="btn" id="btnSaveAll">Kaydet</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">≈ûifre Deƒüi≈ütir</div>
      <div class="bd">
        <div class="grid">
          <div>
            <label for="pwdCurrent">Mevcut ≈ûifre</label>
            <input id="pwdCurrent" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
          <div>
            <label for="pwdNew">Yeni ≈ûifre</label>
            <input id="pwdNew" type="password" placeholder="En az 6 karakter" />
          </div>
          <div>
            <label for="pwdNew2">Yeni ≈ûifre (Tekrar)</label>
            <input id="pwdNew2" type="password" placeholder="Tekrar yazƒ±n" />
          </div>
        </div>
        <div style="margin-top:14px">
          <button class="btn" id="btnChangePwd">≈ûifreyi G√ºncelle</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">ƒ∞lanlarƒ±m</div>
      <div class="bd">
        <div class="tabs" id="tabs">
          <div class="tab active" data-key="active">Yayƒ±ndakiler</div>
          <div class="tab" data-key="pending">Onay Bekleyenler</div>
          <div class="tab" data-key="expired">S√ºresi Dolanlar</div>
        </div>
        <div class="cards" id="cards"></div>
      </div>
    </div>
  </div>

  <nav class="bottom">
    <a class="tabb" href="home.html"><div class="ico">üè†</div><div class="lbl">Ana Sayfa</div></a>
    <a class="tabb" href="messages.html"><div class="ico">üí¨</div><div class="lbl">Mesajlar</div></a>
    <a class="tabb active" href="#"><div class="ico">üë§</div><div class="lbl">Profil</div></a>
  </nav>

  <div class="toast" id="toast">Kaydedildi</div>

  <!-- √ñNEMLƒ∞: Bu dosyada window.firebaseConfig tanƒ±mlƒ± olmalƒ± -->
  <script src="js/firebase-config.js"></script>

  <script type="module">
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
    import { getAuth, onAuthStateChanged, reauthenticateWithCredential, EmailAuthProvider, updatePassword } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, collection, query, where, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js';

    const $ = s => document.querySelector(s);
    const toast = (m,t)=>{const el=$('#toast');el.textContent=m;el.className='toast '+(t||'');el.style.display='block';setTimeout(()=>el.style.display='none',2000)};

    // Config guard
    const cfg = window.firebaseConfig;
    if(!cfg){ alert('firebase-config eksik (js/firebase-config.js)'); throw new Error('Missing firebaseConfig'); }

    const app = getApps().length? getApps()[0]:initializeApp(cfg);
    const auth=getAuth(app), db=getFirestore(app), storage=getStorage(app);

    // UI refs
    const avatarBox=$('#avatarBox'), avatarImg=$('#avatarImg'), btnPick=$('#btnPick'), fileInput=$('#fileInput');
    const unameLbl=$('#uname'), inpUser=$('#username'), inpCity=$('#city'), inpF=$('#fname'), inpL=$('#lname'), inpPhone=$('#phone'), inpEmail=$('#email'), btnSaveAll=$('#btnSaveAll');
    const inpPwdCur=$('#pwdCurrent'), inpPwdNew=$('#pwdNew'), inpPwdNew2=$('#pwdNew2'), btnChangePwd=$('#btnChangePwd');
    const cards=$('#cards'); const tabs=document.querySelectorAll('.tab');

    // Image tools
    async function fileToWebp(file,max=640){
      const bm=await createImageBitmap(file);
      const sc=Math.min(1,max/Math.max(bm.width,bm.height));
      const w=Math.max(1,Math.round(bm.width*sc)), h=Math.max(1,Math.round(bm.height*sc));
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      c.getContext('2d').drawImage(bm,0,0,w,h);
      const bl=await new Promise(r=>c.toBlob(b=>r(b),'image/webp',0.9));
      return new File([bl],'profile.webp',{type:'image/webp'});
    }
    async function uploadAvatar(uid,file){
      const sm=await fileToWebp(file,640);
      const r=ref(storage,`avatars/${uid}/profile.webp`);
      await uploadBytes(r,sm,{contentType:sm.type});
      const url=await getDownloadURL(r);
      avatarImg.src=url;
      await setDoc(doc(db,'publicUsers',uid),{avatarURL:url},{merge:true});
      toast('Profil fotoƒürafƒ± g√ºncellendi','ok');
    }
    async function loadAvatar(uid){
      try{ const r=ref(storage,`avatars/${uid}/profile.webp`); const url=await getDownloadURL(r); avatarImg.src=url; }catch(e){}
    }

    // Data load/save
    async function loadAll(uid){
      const pRef=doc(db,'publicUsers',uid), pSnap=await getDoc(pRef);
      if(pSnap.exists()){const d=pSnap.data(); if(d.username){inpUser.value=d.username; unameLbl.textContent='@'+d.username;} if(d.city){inpCity.value=d.city;}}
      const uRef=doc(db,'users',uid), uSnap=await getDoc(uRef);
      if(uSnap.exists()){const d=uSnap.data(); if(d.firstName) inpF.value=d.firstName; if(d.lastName) inpL.value=d.lastName; if(d.phone) inpPhone.value=d.phone;}
      const u=auth.currentUser;
      if(u){
        if(!inpEmail.value) inpEmail.value=u.email||'';
        if(!inpF.value && u.displayName){const parts=u.displayName.split(' '); inpF.value=parts[0]||''; if(parts.length>1) inpL.value=parts.slice(1).join(' ');}
        if(!inpUser.value){ const fromMail=(u.email||'').split('@')[0]||('user_'+u.uid.slice(0,6)); const un=fromMail.replace(/[^a-zA-Z0-9_.-]/g,'').toLowerCase(); inpUser.value=un; unameLbl.textContent='@'+un; }
      }
      await loadAvatar(uid);
    }
    async function savePublic(uid){
      const username=inpUser.value.trim().replace(/[^a-zA-Z0-9_.-]/g,'').toLowerCase();
      const city=inpCity.value.trim();
      if(!username){toast('Kullanƒ±cƒ± adƒ± bo≈ü olamaz','err');return;}
      await setDoc(doc(db,'publicUsers',uid),{username,city},{merge:true});
      unameLbl.textContent='@'+username;
      toast('Bilgiler g√ºncellendi','ok');
    }
    async function savePrivate(uid){
      await setDoc(doc(db,'users',uid),{firstName:inpF.value.trim(),lastName:inpL.value.trim(),phone:inpPhone.value.trim()},{merge:true});
    }

    // Listings
    function cardHTML(d){
      const t=d.title||'ƒ∞simsiz ƒ∞lan', p=d.price!=null?`${d.price} TL`:'';
      return `<div class="listing"><div class="ph"><img alt="${t}" data-src="${d._img||''}"/></div><div class="ttl">${t}${p?' ‚Ä¢ '+p:''}</div></div>`;
    }
    async function resolveImage(uid,lid,docData){
      if(docData&&Array.isArray(docData.images)&&docData.images[0]) return docData.images[0];
      try{const r=ref(storage,`listings/${uid}/${lid}/1.webp`);return await getDownloadURL(r);}catch(e){return '';}
    }
    async function loadListingsTab(key,uid){
      try{
        cards.innerHTML='<div class="sub" style="padding:8px">Y√ºkleniyor‚Ä¶</div>';
        const baseCol=collection(db,'listings',uid,'items');
        let q=query(baseCol,orderBy('createdAt','desc'),limit(30));
        try{ q=query(baseCol,where('status','==',key),orderBy('createdAt','desc'),limit(30)); }catch(e){}
        const snap=await getDocs(q);
        const docs=[]; snap.forEach(x=>docs.push({id:x.id,...x.data()}));
        const filtered=docs.filter(d=>!d.status?(key==='active'):(d.status===key));
        for(const d of filtered){ d._img=await resolveImage(uid,d.id,d); }
        cards.innerHTML = filtered.length===0
          ? '<div class="sub" style="padding:8px">Bu sekmede ilan yok.</div>'
          : filtered.map(cardHTML).join('');
        cards.querySelectorAll('img[data-src]').forEach(img=>{ const s=img.getAttribute('data-src'); if(s) img.src=s; });
      }catch(err){
        console.error(err);
        const msg=(err&&err.code==='permission-denied')?'ƒ∞lanlar okunamƒ±yor (Firestore Rules).':'ƒ∞lanlar y√ºklenemedi.';
        cards.innerHTML = `<div class="sub" style="padding:8px">${msg}</div>`;
      }
    }

    // Auth & handlers
    onAuthStateChanged(auth, async user=>{
      if(!user){ location.href='auth.html?next=profile.html'; return; }
      inpEmail.value=user.email||'';
      await loadAll(user.uid);

      const triggerPick=()=>fileInput.click();
      btnPick.onclick=triggerPick; avatarBox.onclick=triggerPick; avatarImg.onclick=triggerPick;

      fileInput.onchange=async e=>{
        const f=e.target.files?.[0]; if(!f) return;
        try{ await uploadAvatar(user.uid,f); }
        catch(err){ console.error(err); toast('Y√ºkleme hatasƒ±: '+(err?.code||''),'err'); }
      };

      btnSaveAll.onclick=async()=>{ try{ await savePrivate(user.uid); await savePublic(user.uid); toast('Bilgiler g√ºncellendi','ok'); } catch(e){ toast('Kaydedilemedi','err'); } };

      if(btnChangePwd){
        btnChangePwd.onclick=async()=>{
          const cur=inpPwdCur.value, nw=inpPwdNew.value, nw2=inpPwdNew2.value;
          if(!cur||!nw||!nw2){toast('T√ºm ≈üifre alanlarƒ±nƒ± doldurun','err');return;}
          if(nw!==nw2){toast('Yeni ≈üifreler e≈üle≈ümiyor','err');return;}
          try{
            const cred=EmailAuthProvider.credential(user.email||'',cur);
            await reauthenticateWithCredential(user,cred);
            await updatePassword(user,nw);
            inpPwdCur.value=''; inpPwdNew.value=''; inpPwdNew2.value='';
            toast('≈ûifre g√ºncellendi','ok');
          }catch(e){
            const map={
              "auth/wrong-password":"Mevcut ≈üifre yanlƒ±≈ü",
              "auth/weak-password":"Zayƒ±f ≈üifre",
              "auth/too-many-requests":"√áok deneme, sonra tekrar deneyin",
              "auth/requires-recent-login":"G√ºvenlik i√ßin yeniden giri≈ü gerekli"
            };
            toast(map[e?.code]||('Hata: '+e?.code),'err');
          }
        };
      }

      // Sekmeler
      tabs.forEach(el=>{
        el.addEventListener('click', async ()=>{
          tabs.forEach(x=>x.classList.remove('active'));
          el.classList.add('active');
          await loadListingsTab(el.getAttribute('data-key'), user.uid);
        });
      });
      await loadListingsTab('active', user.uid);
    });
  </script>
</body>
</html>
