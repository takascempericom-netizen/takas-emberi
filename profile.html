<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profil • Takas Çemberi</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0b10; --card:#12131a; --muted:#6b7a99; --txt:#f6f7fb; --accent:#ff1f3d; --accent-2:#ff3d5b;
      --stroke:#222434; --ok:#28c76f; --warn:#ff9f43;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -10%, #1b1e2d 0%, #0b0b10 60%),linear-gradient(135deg,#0b0b10,#0b0b10 60%);color:var(--txt);font:16px/1.6 Inter,system-ui,Segoe UI,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:16px 16px 108px}
    header.hd{display:flex;align-items:center;gap:16px;padding:16px;border:1px solid var(--stroke);border-radius:20px;background:linear-gradient(180deg,#151828,#111420)}
    .avatar{position:relative;width:96px;height:96px;border-radius:50%;background:#0e0f16;border:2px solid #22263a;box-shadow:0 8px 24px rgba(0,0,0,.5), inset 0 0 40px rgba(255,255,255,.04);overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .avatar input{position:absolute;inset:0;opacity:0;cursor:pointer}
    .badge{position:absolute;bottom:-4px;right:-4px;background:linear-gradient(180deg,var(--accent),var(--accent-2));border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700;box-shadow:0 6px 18px rgba(255,61,91,.45)}
    .info{flex:1;min-width:0}
    .info h1{font-size:24px;line-height:1.2;margin:0 0 4px}
    .info .handle{color:var(--muted);font-weight:600}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{flex:1 1 300px;border:1px solid var(--stroke);border-radius:20px;background:linear-gradient(180deg,#141827,#0f1320);padding:16px;min-width:260px}
    .card h2{margin:0 0 12px;font-size:18px}
    label{display:block;font-size:13px;color:var(--muted);margin:8px 0 6px}
    input, textarea, select{width:100%;padding:12px 14px;border-radius:14px;border:1px solid #24273a;background:#0f1220;color:var(--txt);outline:none}
    input:focus, textarea:focus, select:focus{border-color:#35406b;box-shadow:0 0 0 4px rgba(53,64,107,.25)}
    textarea{min-height:100px;resize:vertical}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:14px;border:1px solid #2a2e46;background:linear-gradient(180deg,#1a1f34,#171b2b);color:#fff;font-weight:700;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#ff3956,#ff1f3d);border-color:#ff3d5b;box-shadow:0 10px 30px rgba(255,61,91,.35)}
    .btn.ghost{background:transparent}

    /* 3D yıldızlar */
    .stars3d{display:flex;gap:8px;align-items:center;perspective:600px}
    .star{width:34px;height:34px;display:inline-grid;place-items:center;border-radius:10px;background:linear-gradient(180deg,#0f1320,#0c0f19);border:1px solid #24293d;cursor:pointer;transform-style:preserve-3d;transition:transform .2s ease, border-color .2s}
    .star:hover{transform:translateY(-2px) rotateX(8deg);border-color:#3a4166}
    .star.active{background:radial-gradient(120% 80% at 50% -20%, #ff8aa0 0%, #ff1f3d 60%);border-color:#ff6a84;box-shadow:0 6px 26px rgba(255,61,91,.45)}
    .star i{font-style:normal;font-weight:800;filter:drop-shadow(0 6px 10px rgba(255,61,91,.25))}
    .avg{margin-left:10px;color:var(--muted);font-weight:700}

    /* Alt menü */
    .btmnav{position:fixed;left:0;right:0;bottom:0;background:rgba(10,12,18,.7);backdrop-filter:blur(10px);border-top:1px solid #1f2234}
    .btmnav .bar{max-width:980px;margin:0 auto;display:grid;grid-template-columns:repeat(3,1fr);}
    .btmnav a{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px 6px;color:#cfd4ff;font-weight:700}
    .btmnav a .ic{font-size:20px;line-height:1}
    .btmnav a.active{color:#fff}

    /* İlan sekmeleri */
    .tabs{display:flex;gap:8px;margin:4px 0 12px}
    .tab{padding:8px 12px;border:1px solid #2a2e46;border-radius:999px;background:#12162a;color:#e6e8ff;font-weight:700;cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#ff3956,#ff1f3d);border-color:#ff6a84}
    .list{display:grid;gap:10px}
    .item{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;border:1px solid #22263a;background:#0f1322;border-radius:14px;padding:10px}
    .thumb{width:64px;height:64px;border-radius:10px;background:#0e0f16;overflow:hidden;border:1px solid #272b42}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .status{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2a2e46;background:#141a2d;color:#c9d0ff}
    .actions{display:flex;gap:8px}

    .hide{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hd">
      <div class="avatar" title="Resim Ekle / Değiştir">
        <img id="avatarImg" alt="Profil Fotoğrafı" src="" onerror="this.src='https://i.pravatar.cc/200?img=8'">
        <input id="avatarFile" type="file" accept="image/*" />
        <div class="badge">📷</div>
      </div>
      <div class="info">
        <h1 id="fullName">—</h1>
        <div class="handle" id="handle">@kullanici</div>
        <div class="stars3d" id="starsBlock"><!-- 3D yıldızlar --></div>
      </div>
      <button class="btn ghost" id="btnLogout">🚪 Çıkış</button>
    </header>

    <div class="row" style="margin-top:16px">
      <section class="card">
        <h2>Bilgiler</h2>
        <label>İsim</label>
        <input id="inpFirst" placeholder="İsim">
        <label>Soyisim</label>
        <input id="inpLast" placeholder="Soyisim">
        <label>Kullanıcı Adı</label>
        <input id="inpHandle" placeholder="kullanici">
        <label>Telefon</label>
        <input id="inpPhone" placeholder="5xx xxx xx xx">
        <label>E‑posta</label>
        <input id="inpEmail" placeholder="mail@ornek.com" disabled>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" id="btnSave">Kaydet</button>
          <button class="btn" id="btnRefresh">Yenile</button>
          <button class="btn" id="btnChangePass">Şifre Değiştir</button>
        </div>
      </section>

      <section class="card">
        <h2>Hakkında</h2>
        <p id="aboutText" style="opacity:.9">Takas Çemberi; insanların ihtiyaçlarına uygun ürünleri takas ettiği, güven odaklı bir platformdur. Profilini güncelle, fotoğrafını ekle ve güven puanını artırmak için oylara katkı ver.</p>
        <div style="margin-top:8px;font-size:14px;color:var(--muted)">Ortalama Puan: <b id="avgScore">—</b> • Oy sayısı: <b id="ratingsCount">—</b></div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h2>İlanlarım</h2>
      <div class="tabs">
        <button class="tab active" data-tab="pending">Onay Bekleyen</button>
        <button class="tab" data-tab="active">Yayında</button>
        <button class="tab" data-tab="expired">Süresi Dolan</button>
      </div>

      <!-- Yeni ilan formu -->
      <div style="display:grid;gap:8px;margin-bottom:12px">
        <label>Başlık</label>
        <input id="adTitle" placeholder="Örn: Akıllı Saat (A ile takas olur)">
        <label>Açıklama</label>
        <textarea id="adDesc" placeholder="Durum, takas şartları, istenenler…"></textarea>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="adPhoto" type="file" accept="image/*">
          <button class="btn primary" id="btnAddAd">İlan Ver (Onaya Gider)</button>
        </div>
      </div>

      <!-- Listeler -->
      <div id="list-pending" class="list"></div>
      <div id="list-active" class="list hide"></div>
      <div id="list-expired" class="list hide"></div>
    </section>
  </div>

  <!-- Alt menü -->
  <nav class="btmnav">
    <div class="bar">
      <a href="home.html" id="navHome"><span class="ic">🏠</span> Ana Sayfa</a>
      <a href="notifications.html" id="navNotif"><span class="ic">🔔</span> Bildirimler</a>
      <a href="messages.html" id="navMsg"><span class="ic">💬</span> Mesajlar</a>
    </div>
  </nav>

  <script type="module">
    /* === Firebase v10 (Modüler) === */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, collection, addDoc, query, where, getDocs, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

    // ——— Kullanıcının verdiği Firebase config ———
    const firebaseConfig = {
      apiKey: "AIzaSyBUUNSYxoWNUsK0C-C04qTUm6KM5756fvg",
      authDomain: "ureten-eller-v2.firebaseapp.com",
      projectId: "ureten-eller-v2",
      storageBucket: "ureten-eller-v2.firebasestorage.app",
      messagingSenderId: "621494781131",
      appId: "1:621494781131:web:13cc3b061a5e94b7cf874e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const el = (id)=>document.getElementById(id);
    const avatarImg = el('avatarImg');
    const avatarFile = el('avatarFile');
    const fullName = el('fullName');
    const handle = el('handle');
    const starsBlock = el('starsBlock');
    const avgScoreEl = el('avgScore');
    const ratingsCountEl = el('ratingsCount');

    const inpFirst = el('inpFirst');
    const inpLast = el('inpLast');
    const inpHandle = el('inpHandle');
    const inpPhone = el('inpPhone');
    const inpEmail = el('inpEmail');

    const btnSave = el('btnSave');
    const btnRefresh = el('btnRefresh');
    const btnLogout = el('btnLogout');
    const btnChangePass = el('btnChangePass');

    // İlan elemanları
    const adTitle = el('adTitle');
    const adDesc = el('adDesc');
    const adPhoto = el('adPhoto');
    const btnAddAd = el('btnAddAd');

    const listPending = el('list-pending');
    const listActive = el('list-active');
    const listExpired = el('list-expired');

    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const k = t.dataset.tab;
        listPending.classList.toggle('hide', k!=='pending');
        listActive.classList.toggle('hide', k!=='active');
        listExpired.classList.toggle('hide', k!=='expired');
      })
    });

    let currentUser = null;     // oturum sahibi
    let targetUserId = null;    // görüntülenen profil
    let currentUserData = null; // isAdmin vb.

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = 'auth.html?next=profile.html';
        return;
      }
      currentUser = user;
      inpEmail.value = user.email || '';

      // kendi profilin
      const params = new URLSearchParams(location.search);
      targetUserId = params.get('uid') || user.uid;

      currentUserData = (await getDoc(doc(db,'users', user.uid))).data() || {};

      await loadProfile(targetUserId);
      await loadRatingsSummary(targetUserId);
      renderStars(starsBlock, 0, targetUserId === currentUser.uid);

      await refreshListings();
    });

    async function loadProfile(uid){
      const uref = doc(db, 'users', uid);
      const snap = await getDoc(uref);
      if(!snap.exists()){
        await setDoc(uref, { createdAt: serverTimestamp(), averageRating: 0, ratingsCount: 0 }, { merge:true });
      }
      const data = (await getDoc(uref)).data() || {};
      const first = data.firstName || '';
      const last = data.lastName || '';
      const uname = data.username || data.handle || 'kullanici';
      const photo = data.photoURL || '';

      avatarImg.src = photo || `https://api.dicebear.com/7.x/thumbs/svg?seed=${encodeURIComponent(uname)}`;
      fullName.textContent = (first || last) ? `${first} ${last}`.trim() : (data.displayName || '—');
      handle.textContent = `@${uname}`;

      inpFirst.value = first; inpLast.value = last; inpHandle.value = uname; inpPhone.value = data.phone || '';
    }

    async function loadRatingsSummary(uid){
      const uref = doc(db, 'users', uid);
      const snap = await getDoc(uref);
      const data = snap.data() || {};
      avgScoreEl.textContent = (data.averageRating ?? '—');
      ratingsCountEl.textContent = (data.ratingsCount ?? '—');

      if(currentUser && uid !== currentUser.uid){
        const qref = query(collection(db, 'ratings'), where('targetId','==',uid), where('raterId','==',currentUser.uid));
        const qs = await getDocs(qref);
        const my = qs.empty ? null : qs.docs[0].data();
        if(my){
          renderStars(starsBlock, my.stars, false);
        }
      }
    }

    // === PROFIL KAYDET ===
    btnSave.addEventListener('click', async ()=>{
      if(!currentUser) return;
      const uref = doc(db, 'users', currentUser.uid);
      await setDoc(uref, {
        firstName: inpFirst.value.trim(),
        lastName: inpLast.value.trim(),
        username: inpHandle.value.trim().replace(/\s+/g,'').toLowerCase(),
        phone: inpPhone.value.trim(),
        updatedAt: serverTimestamp()
      }, { merge:true });
      await loadProfile(targetUserId);
      alert('Kaydedildi.');
    });

    btnRefresh.addEventListener('click', ()=> loadProfile(targetUserId));

    btnLogout.addEventListener('click', async ()=>{ await signOut(auth); });

    btnChangePass.addEventListener('click', async ()=>{
      if(!currentUser?.email){ alert('E‑posta bağlı değil.'); return; }
      await sendPasswordResetEmail(auth, currentUser.email);
      alert('E‑postana şifre sıfırlama bağlantısı gönderdik.');
    });

    // === AVATAR YÜKLE (galeriden kalıcı) ===
    avatarFile.addEventListener('change', async (e)=>{
      if(!currentUser) return;
      const file = e.target.files?.[0];
      if(!file) return;
      const r = ref(storage, `profile_photos/${currentUser.uid}.jpg`);
      await uploadBytes(r, file);
      const url = await getDownloadURL(r);
      await updateDoc(doc(db,'users', currentUser.uid), { photoURL: url, updatedAt: serverTimestamp() });
      avatarImg.src = url; // tüm kullanıcılar görür (public URL)
    });

    // === 3D YILDIZLAR + Firestore'a Oy Yaz ===
    function renderStars(container, current = 0, disabled=false){
      container.innerHTML = '';
      const avg = document.createElement('span');
      avg.className = 'avg';
      avg.textContent = 'Oy ver';

      for(let i=1;i<=5;i++){
        const s = document.createElement('div');
        s.className = 'star' + (i <= current ? ' active' : '');
        s.title = `${i} yıldız`;
        const ico = document.createElement('i');
        ico.textContent = '★';
        s.appendChild(ico);

        if(!disabled){
          s.addEventListener('click', async()=>{
            const stars = i;
            if(!currentUser){ alert('Giriş yapmalısın.'); return; }
            if(!targetUserId){ return; }
            if(currentUser.uid === targetUserId){ alert('Kendi profilini oylayamazsın.'); return; }
            await submitRating(targetUserId, stars);
            renderStars(container, stars, false);
            await recomputeAndUpdateAverage(targetUserId);
            await loadRatingsSummary(targetUserId);
          });
        } else {
          s.style.cursor = 'not-allowed';
          s.title = 'Kendi profilin';
        }
        container.appendChild(s);
      }
      container.appendChild(avg);
    }

    async function submitRating(targetId, stars){
      const key = `${targetId}_${currentUser.uid}`;
      const rdoc = doc(db, 'ratings', key);
      await setDoc(rdoc, { targetId, raterId: currentUser.uid, stars, updatedAt: serverTimestamp(), createdAt: serverTimestamp() }, { merge:true });
    }

    async function recomputeAndUpdateAverage(targetId){
      const qref = query(collection(db, 'ratings'), where('targetId','==',targetId));
      const qs = await getDocs(qref);
      let sum=0, cnt=0; qs.forEach(d=>{ const v=d.data().stars|0; if(v>0){ sum+=v; cnt++; } });
      const avg = cnt? +(sum/cnt).toFixed(2) : 0;
      await updateDoc(doc(db,'users', targetId), { averageRating: avg, ratingsCount: cnt, ratingsUpdatedAt: serverTimestamp() });
    }

    // === İLAN İŞLEMLERİ ===
    btnAddAd.addEventListener('click', async()=>{
      if(!currentUser) return alert('Giriş yapmalısın.');
      const title = adTitle.value.trim();
      const desc = adDesc.value.trim();
      if(!title) return alert('Başlık gerekli');
      let photoURL = '';
      const f = adPhoto.files?.[0];
      if(f){
        const p = ref(storage, `listing_photos/${currentUser.uid}_${Date.now()}.jpg`);
        await uploadBytes(p, f); photoURL = await getDownloadURL(p);
      }
      await addDoc(collection(db,'listings'),{
        title, desc, photoURL,
        ownerId: currentUser.uid,
        status: 'pending',
        createdAt: serverTimestamp(),
        approvedAt: null,
        expiresAt: null
      });
      adTitle.value=''; adDesc.value=''; adPhoto.value='';
      alert('İlan alındı. Admin onayından sonra yayınlanacak.');
      await refreshListings();
    });

    async function refreshListings(){
      await ensureExpireTransitions();
      await loadByStatus('pending', listPending);
      await loadByStatus('active', listActive);
      await loadByStatus('expired', listExpired);
    }

    async function loadByStatus(status, container){
      container.innerHTML = '';
      const qref = query(collection(db,'listings'), where('ownerId','==', targetUserId), where('status','==', status), orderBy('createdAt','desc'));
      const qs = await getDocs(qref);
      if(qs.empty){ container.innerHTML = `<div style="color:var(--muted)">Bu bölümde ilan yok.</div>`; return; }
      qs.forEach(docu=>{
        const d = docu.data(); const id = docu.id;
        const it = document.createElement('div'); it.className='item';
        const th = document.createElement('div'); th.className='thumb'; th.innerHTML = `<img src="${d.photoURL||'https://picsum.photos/seed/takas/120/120'}" alt="thumb">`;
        const body = document.createElement('div');
        body.innerHTML = `<div style="font-weight:800">${escapeHtml(d.title||'İlan')}</div>
                          <div style="font-size:13px;color:var(--muted);margin-top:2px">${escapeHtml((d.desc||'').slice(0,120))}</div>
                          <div style="margin-top:6px" class="status">Durum: ${statusLabel(status)}</div>`;
        const acts = document.createElement('div'); acts.className='actions';

        // Şikayet et
        const btnRep = document.createElement('button'); btnRep.className='btn'; btnRep.textContent='⚠️ Şikayet et';
        btnRep.addEventListener('click',()=>reportListing(id));
        acts.appendChild(btnRep);

        // Admin onayla / yayından kaldır
        if(currentUserData?.isAdmin){
          if(status==='pending'){
            const b = document.createElement('button'); b.className='btn primary'; b.textContent='Onayla → Yayına Al';
            b.addEventListener('click',()=>approveListing(id)); acts.appendChild(b);
          }
          if(status==='active'){
            const b2 = document.createElement('button'); b2.className='btn'; b2.textContent='Yayından Kaldır';
            b2.addEventListener('click',()=>expireListingNow(id)); acts.appendChild(b2);
          }
        }

        it.appendChild(th); it.appendChild(body); it.appendChild(acts);
        container.appendChild(it);
      });
    }

    function statusLabel(s){
      return s==='pending'?'Onay Bekliyor': s==='active'?'Yayında':'Süresi Doldu';
    }

    async function approveListing(id){
      const now = Timestamp.now();
      const expires = Timestamp.fromMillis(now.toMillis() + 30*24*60*60*1000);
      await updateDoc(doc(db,'listings', id), { status:'active', approvedAt: now, expiresAt: expires });
      await refreshListings();
    }

    async function expireListingNow(id){
      await updateDoc(doc(db,'listings', id), { status:'expired' });
      await refreshListings();
    }

    async function ensureExpireTransitions(){
      // aktif ilanların süresi dolmuşsa expired yap
      const now = Timestamp.now();
      const qref = query(collection(db,'listings'), where('ownerId','==', targetUserId), where('status','==','active'));
      const qs = await getDocs(qref);
      for(const d of qs.docs){
        const data = d.data();
        if(data.expiresAt && data.expiresAt.toMillis() < now.toMillis()){
          await updateDoc(doc(db,'listings', d.id), { status:'expired' });
        }
      }
    }

    async function reportListing(listingId){
      if(!currentUser) return alert('Giriş yapmalısın.');
      const reason = prompt('Şikayet nedeni:');
      if(!reason) return;
      await addDoc(collection(db,'reports'),{
        listingId, reason, reporterId: currentUser.uid, createdAt: serverTimestamp(), handled:false
      });
      alert('Şikayet alındı. Admin inceleyecek.');
    }

    // Basit XSS koruması için
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    // === Alt menü aktif durum ===
    const path = location.pathname.split('/').pop() || '';
    if(path.includes('home')) document.getElementById('navHome').classList.add('active');
    if(path.includes('notifications')) document.getElementById('navNotif').classList.add('active');
    if(path.includes('messages')) document.getElementById('navMsg').classList.add('active');
  </script>

  <!-- FIRESTORE RULES (özet) – prod için daraltın)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      function isSignedIn(){ return request.auth != null; }
      function isOwner(uid){ return request.auth != null && request.auth.uid == uid; }

      match /users/{uid} {
        allow read: if true;
        allow create, update: if isOwner(uid);
      }
      match /ratings/{rid} {
        allow read: if true;
        allow create, update: if isSignedIn() && request.resource.data.raterId == request.auth.uid;
      }
      match /listings/{id} {
        allow read: if true;
        allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid && request.resource.data.status == 'pending';
        allow update: if isSignedIn() && (
          (isOwner(resource.data.ownerId) && request.resource.data.status == resource.data.status)
          ||
          (request.auth.token.admin == true)
        );
      }
      match /reports/{id} {
        allow read: if request.auth.token.admin == true; // sadece admin
        allow create: if isSignedIn() && request.resource.data.reporterId == request.auth.uid;
      }
    }
  }
  -->
</body>
</html>
