<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profil ‚Ä¢ Takas √áemberi</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0b10; --card:#12131a; --muted:#6b7a99; --txt:#f6f7fb; --accent:#ff1f3d;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#0b0b10;color:var(--txt);font:15px/1.6 Inter,sans-serif}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:16px 16px 96px}
    header.hd{display:flex;align-items:center;gap:16px;padding:16px;border:1px solid #222;border-radius:20px;background:#111420;flex-wrap:wrap}
    .avatar{position:relative;width:96px;height:96px;border-radius:50%;background:#0e0f16;border:2px solid #22263a;overflow:hidden;cursor:pointer}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .info{flex:1;min-width:200px}
    .info h1{font-size:22px;margin:0 0 4px}
    .row{display:flex;gap:16px;flex-wrap:wrap;margin-top:16px}
    .card{flex:1 1 280px;border:1px solid #222;border-radius:20px;background:#141827;padding:16px}
    .card h2{margin:0 0 12px;font-size:17px}
    label{display:block;font-size:13px;color:var(--muted);margin:8px 0 4px}
    input{width:100%;padding:10px;border-radius:12px;border:1px solid #24273a;background:#0f1220;color:var(--txt)}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid #2a2e46;background:#171b2b;color:#fff;font-weight:600;cursor:pointer;display:inline-block;margin-top:8px}
    .btn.primary{background:var(--accent)}
    .stars3d{display:flex;gap:8px;align-items:center;margin-top:6px}
    .star{width:30px;height:30px;display:grid;place-items:center;border-radius:6px;background:#0f1320;border:1px solid #24293d;cursor:pointer}
    .star.active{background:var(--accent)}
    .btmnav{position:fixed;left:0;right:0;bottom:0;background:#0b0b10;border-top:1px solid #1f2234}
    .btmnav .bar{max-width:980px;margin:0 auto;display:grid;grid-template-columns:repeat(3,1fr)}
    .btmnav a{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px 6px;color:#cfd4ff;font-weight:700}
    @media(max-width:600px){
      .row{flex-direction:column}
      header.hd{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hd">
      <div class="avatar" id="avatarArea" title="Resim Se√ß">
        <img id="avatarImg" alt="Profil Fotoƒürafƒ±" src="">
      </div>
      <div class="info">
        <h1 id="fullName">‚Äî</h1>
        <div id="handle">@kullanici</div>
        <div class="stars3d" id="starsBlock"></div>
      </div>
      <button class="btn" id="btnLogout">√áƒ±kƒ±≈ü</button>
    </header>

    <div class="row">
      <section class="card">
        <h2>≈ûifre Deƒüi≈ütir</h2>
        <label>Yeni ≈ûifre</label>
        <input id="inpPass" type="password">
        <button class="btn primary" id="btnPass">≈ûifreyi G√ºncelle</button>
      </section>
    </div>
  </div>

  <nav class="btmnav">
    <div class="bar">
      <a href="home.html">üè† Ana Sayfa</a>
      <a href="notifications.html">üîî Bildirimler</a>
      <a href="messages.html">üí¨ Mesajlar</a>
    </div>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, updatePassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUUNSYxoWNUsK0C-C04qTUm6KM5756fvg",
      authDomain: "ureten-eller-v2.firebaseapp.com",
      projectId: "ureten-eller-v2",
      storageBucket: "ureten-eller-v2.appspot.com",
      messagingSenderId: "621494781131",
      appId: "1:621494781131:web:13cc3b061a5e94b7cf874e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const avatarImg=document.getElementById('avatarImg');
    const avatarArea=document.getElementById('avatarArea');
    const btnPass=document.getElementById('btnPass');
    const inpPass=document.getElementById('inpPass');

    let currentUser=null;

    onAuthStateChanged(auth,async(user)=>{
      if(!user){location.href='auth.html';return;}
      currentUser=user;
      if(user.displayName) document.getElementById('fullName').textContent=user.displayName;
      if(user.email) document.getElementById('handle').textContent='@'+user.email.split('@')[0];
      if(user.photoURL) avatarImg.src=user.photoURL;
    });

    btnPass.addEventListener('click',async()=>{
      if(currentUser&&inpPass.value){
        await updatePassword(currentUser,inpPass.value);
        alert('≈ûifre g√ºncellendi');
        inpPass.value='';
      }
    });

    // Avatar resim se√ßme
    avatarArea.addEventListener('click',async()=>{
      if(!currentUser) return;
      const input=document.createElement('input');
      input.type='file';
      input.accept='image/*';
      input.onchange=async(e)=>{
        const file=e.target.files?.[0]; if(!file) return;
        const r=ref(storage,`profile_photos/${currentUser.uid}.jpg`);
        await uploadBytes(r,file);
        const url=await getDownloadURL(r);
        await updateDoc(doc(db,'users',currentUser.uid),{photoURL:url,updatedAt:serverTimestamp()});
        avatarImg.src=url;
      };
      input.click();
    });

    document.getElementById('btnLogout').addEventListener('click',()=>signOut(auth));
  </script>
</body>
</html>

    // ‚Äî‚Äî‚Äî YILDIZ OYLAMA: Firestore'a yaz (avg g√∂stermiyoruz) ‚Äî‚Äî‚Äî
    function renderStars(container,current=0,disabled=false){
      container.innerHTML='';
      for(let i=1;i<=5;i++){
        const s=document.createElement('div'); s.className='star'+(i<=current?' active':''); s.title=i+' yƒ±ldƒ±z';
        const ico=document.createElement('i'); ico.style.fontStyle='normal'; ico.textContent='‚òÖ'; s.appendChild(ico);
        if(!disabled){ s.addEventListener('click',()=>saveRating(i)); }
        else { s.style.cursor='not-allowed'; }
        container.appendChild(s);
      }
    }
    async function saveRating(stars){
      if(!currentUser) return alert('Giri≈ü yapmalƒ±sƒ±n.');
      if(currentUser.uid===targetUserId) return alert('Kendi profilini oylayamazsƒ±n.');
      const key=`${targetUserId}_${currentUser.uid}`;
      await setDoc(doc(db,'ratings',key),{targetId:targetUserId,raterId:currentUser.uid,stars,updatedAt:serverTimestamp(),createdAt:serverTimestamp()},{merge:true});
      renderStars(starsBlock,stars,false);
      alert('Oyun kaydedildi.');
    }

    // ‚Äî‚Äî‚Äî ƒ∞LANLAR: pending ‚Üí admin onayƒ±yla active ‚Üí 30 g√ºnde expired ‚Äî‚Äî‚Äî
    async function refreshListings(){
      await ensureExpireTransitions();
      await loadByStatus('pending',listPending);
      await loadByStatus('active',listActive);
      await loadByStatus('expired',listExpired);
    }
    async function loadByStatus(status,container){
      container.innerHTML='';
      const qref=query(collection(db,'listings'), where('ownerId','==',targetUserId), where('status','==',status), orderBy('createdAt','desc'));
      const qs=await getDocs(qref);
      if(qs.empty){ container.innerHTML='<div style="color:var(--muted)">Bu b√∂l√ºmde ilan yok.</div>'; return; }
      qs.forEach(docu=>{
        const d=docu.data(); const id=docu.id;
        const it=document.createElement('div'); it.className='item';
        const th=document.createElement('div'); th.className='thumb'; th.innerHTML=`<img src="${d.photoURL||'https://picsum.photos/seed/takas/120/120'}" alt="thumb">`;
        const body=document.createElement('div'); body.innerHTML=`<div style="font-weight:800">${escapeHtml(d.title||'ƒ∞lan')}</div>
          <div style="font-size:13px;color:var(--muted);margin-top:2px">${escapeHtml((d.desc||'').slice(0,120))}</div>
          <div style="margin-top:6px" class="status">Durum: ${statusLabel(status)}</div>`;
        const acts=document.createElement('div'); acts.className='actions';

        // ≈ûikayet et
        const rep=document.createElement('button'); rep.className='btn'; rep.textContent='‚ö†Ô∏è ≈ûikayet et'; rep.addEventListener('click',()=>reportListing(id)); acts.appendChild(rep);
        // Admin aksiyonlarƒ±
        if(currentUserData?.isAdmin){
          if(status==='pending'){ const b=document.createElement('button'); b.className='btn primary'; b.textContent='Onayla ‚Üí Yayƒ±na Al'; b.addEventListener('click',()=>approveListing(id)); acts.appendChild(b); }
          if(status==='active'){ const b2=document.createElement('button'); b2.className='btn'; b2.textContent='Yayƒ±ndan Kaldƒ±r'; b2.addEventListener('click',()=>expireListingNow(id)); acts.appendChild(b2); }
        }

        it.appendChild(th); it.appendChild(body); it.appendChild(acts); container.appendChild(it);
      });
    }
    function statusLabel(s){ return s==='pending'?'Onay Bekliyor': s==='active'?'Yayƒ±nda':'S√ºresi Doldu'; }
    async function approveListing(id){ const now=Timestamp.now(); const expires=Timestamp.fromMillis(now.toMillis()+30*24*60*60*1000); await updateDoc(doc(db,'listings',id),{status:'active',approvedAt:now,expiresAt:expires}); await refreshListings(); }
    async function expireListingNow(id){ await updateDoc(doc(db,'listings',id),{status:'expired'}); await refreshListings(); }
    async function ensureExpireTransitions(){ const now=Timestamp.now(); const qs=await getDocs(query(collection(db,'listings'), where('ownerId','==',targetUserId), where('status','==','active'))); for(const d of qs.docs){ const x=d.data(); if(x.expiresAt && x.expiresAt.toMillis()<now.toMillis()){ await updateDoc(doc(db,'listings',d.id),{status:'expired'}); } } }

    async function reportListing(listingId){
      if(!currentUser) return alert('Giri≈ü yapmalƒ±sƒ±n.');
      const reason=prompt('≈ûikayet nedeni:'); if(!reason) return;
      await addDoc(collection(db,'reports'),{listingId,reason,reporterId:currentUser.uid,createdAt:serverTimestamp(),handled:false});
      alert('≈ûikayet alƒ±ndƒ±.');
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    // Alt men√º aktif durumu
    const path = location.pathname.split('/').pop() || '';
    if(path.includes('home')) $('navHome').classList.add('active');
    if(path.includes('notifications')) $('navNotif').classList.add('active');
    if(path.includes('messages')) $('navMsg').classList.add('active');
  </script>

  <!-- FIRESTORE RULES (√∂zet)
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      function isSignedIn(){ return request.auth != null; }
      function isOwner(uid){ return request.auth != null && request.auth.uid == uid; }

      match /users/{uid} {
        allow read: if true;
        allow create, update: if isOwner(uid);
      }
      match /ratings/{rid} {
        allow read: if true;
        allow create, update: if isSignedIn() && request.resource.data.raterId == request.auth.uid;
      }
      match /listings/{id} {
        allow read: if true;
        allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid && request.resource.data.status == 'pending';
        allow update: if isSignedIn() && (
          (isOwner(resource.data.ownerId) && request.resource.data.status == resource.data.status)
          || (request.auth.token.admin == true)
        );
      }
      match /reports/{id} {
        allow read: if request.auth.token.admin == true; // sadece admin
        allow create: if isSignedIn() && request.resource.data.reporterId == request.auth.uid;
      }
    }
  }
  -->
</body>
</html>
