<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profil • Takas Çemberi</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --txt:#0b1020; --muted:#2b3b62; --pri:#5b8aff;
      --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --stroke:rgba(0,0,0,.12);
      --g1:#ff7a7a; --g2:#ffd166; --g3:#6ee7ff; --g4:#9b8cff; --g5:#4ade80;
      --card:rgba(255,255,255,.86); --card2:rgba(255,255,255,.94);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--txt);
      background:linear-gradient(120deg,var(--g1),var(--g2),var(--g3),var(--g4),var(--g5));
      background-size:300% 300%;animation:gradientShift 18s ease infinite;min-height:100vh}
    @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}

    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    header.hd{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 14px;margin-bottom:14px;position:sticky;top:0;background:rgba(255,255,255,.7);backdrop-filter:blur(8px);border:1px solid var(--stroke);border-radius:16px;z-index:50}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:38px;width:38px;border-radius:12px;border:1px solid var(--stroke)}
    .brand b{font-weight:800;letter-spacing:.3px}

    nav.desktop{display:none;gap:8px;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid var(--stroke);padding:10px 14px;border-radius:12px;background:var(--card);color:#0b1020;cursor:pointer}
    .btn.ghost{background:transparent}
    .btn.pri{background:var(--pri);border-color:transparent;color:white}
    .btn.warn{background:transparent;border-color:var(--warn);color:#8a5400}

    /* GRID ALANLARI */
    .grid{display:grid;grid-template-columns:1fr;gap:16px;grid-template-areas:
      "left"
      "right"
      "full";
    }
    #secProfile{grid-area:left}
    #secPassword{grid-area:right}
    #secListings{grid-area:full}

    @media(min-width:880px){
      nav.desktop{display:flex}
      .grid{grid-template-columns:1fr 1fr;grid-template-areas:
        "left right"
        "full full";
      }
    }

    .card{background:var(--card);border:1px solid var(--stroke);border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--stroke);font-weight:800;color:#0b1020;background:var(--card2)}
    .card .bd{padding:16px}

    .profileRow{display:grid;grid-template-columns:96px 1fr;gap:16px;align-items:center}
    .avatar{width:96px;height:96px;border-radius:18px;overflow:hidden;border:1px solid var(--stroke);background:linear-gradient(135deg,#ffffff,#f5f7ff);display:grid;place-items:center}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .muted{color:var(--muted);font-size:.92rem}

    .fields{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:.86rem;color:var(--muted)}
    .field input{height:44px;background:#ffffff;border:1px solid var(--stroke);border-radius:12px;padding:0 12px;color:#0b1020}
    .field input[disabled]{opacity:.8}

    .pwgrid{display:grid;grid-template-columns:1fr;gap:10px;max-width:420px}
    .pwgrid input{height:44px;background:#ffffff;border:1px solid var(--stroke);border-radius:12px;padding:0 12px;color:#0b1020}

    .listings{display:grid;grid-template-columns:repeat( auto-fit, minmax(220px, 1fr) );gap:12px}
    .listing{border:1px solid var(--stroke);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.92)}
    .listing .thumb{height:140px;background:#f3f6ff;display:grid;place-items:center}
    .listing .thumb img{width:100%;height:100%;object-fit:cover}
    .listing .meta{padding:10px 12px;display:grid;gap:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--stroke);border-radius:999px;font-size:.8rem;color:#334155;background:#ffffff}
    .badge.ok{border-color:#1b5e32;color:#166534;background:#e8f9ef}
    .badge.warn{border-color:#6b4a0a;color:#92400e;background:#fff4e5}
    .badge.err{border-color:#5b1a1a;color:#7f1d1d;background:#ffecec}

    .stars{display:inline-flex;gap:3px}
    .stars button, .stars span{font-size:20px;line-height:1;background:none;border:none;color:#f59e0b;cursor:pointer}
    .stars.readonly button{cursor:default}

    .row{display:flex;gap:8px;flex-wrap:wrap}
    .spacer{height:8px}

    .mbnav{position:fixed;bottom:0;left:0;right:0;display:grid;grid-template-columns:repeat(5,1fr);gap:6px;padding:8px;background:rgba(255,255,255,.7);backdrop-filter:blur(8px);border-top:1px solid var(--stroke)}
    .mbnav a{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:8px 4px;border-radius:10px;border:1px solid transparent;color:#0b1020}
    .mbnav a.active{border-color:var(--stroke)}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hd">
      <div class="brand">
        <img src="/logo-64.png" alt="TC" onerror="this.src='https://dummyimage.com/96x96/ffffff/000&text=TC'"/>
        <div>
          <b>Takas Çemberi</b>
          <div class="muted" id="hdrSub">Profil</div>
        </div>
      </div>
      <nav class="desktop">
        <a class="btn ghost" href="home.html">🏠 Sayfa</a>
        <a class="btn ghost" href="messages.html">💬 Mesajlar</a>
        <a class="btn ghost" href="notifications.html">🔔 Bildirimler</a>
        <a class="btn pri" href="ilan-ekle.html">➕ İlan Ekle</a>
        <a class="btn ghost" href="profile.html">👤 Profil</a>
        <button class="btn warn" id="btnLogout">🚪 Çıkış</button>
      </nav>
    </header>

    <div class="grid">
      <!-- SOL: Profil + Puanlama -->
      <section id="secProfile" class="card">
        <div class="hd">Profil</div>
        <div class="bd">
          <div class="profileRow">
            <div class="avatar"><img id="avatar" alt="Profil"/></div>
            <div>
              <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                <h2 id="displayName" style="margin:0;font-size:1.4rem"></h2>
                <span class="badge" id="usernameBadge"></span>
              </div>
              <div class="muted" id="publicInfo"></div>
              <div class="spacer"></div>
              <div class="row" id="ownerActions" style="display:none">
                <label class="btn">
                  📷 Resmi Değiştir
                  <input type="file" id="fileAvatar" accept="image/*" style="display:none" />
                </label>
              </div>
              <div class="row" id="visitorActions" style="display:none">
                <a class="btn pri" id="btnMsg">💬 Mesaj Gönder</a>
              </div>
            </div>
          </div>

          <div class="spacer"></div>

          <div class="fields">
            <div class="field">
              <label>İsim</label>
              <input id="inpFirst" disabled>
            </div>
            <div class="field">
              <label>Soyisim</label>
              <input id="inpLast" disabled>
            </div>
            <div class="field">
              <label>Kullanıcı Adı</label>
              <input id="inpUsername" disabled>
            </div>
            <div class="field">
              <label>Telefon (yalnızca size görünür)</label>
              <input id="inpPhone" disabled>
            </div>
          </div>

          <div class="spacer" style="height:14px"></div>

          <div class="card" style="margin-top:8px">
            <div class="hd">Puanlama</div>
            <div class="bd">
              <div class="row" style="align-items:center;justify-content:space-between">
                <div>
                  <div class="stars readonly" id="avgStars"></div>
                  <div class="muted" id="avgText">0/5 • 0 oy</div>
                </div>
                <div id="rateBox" style="display:none">
                  <div class="muted" style="margin-bottom:4px">Bu kullanıcıyı puanla (1‑5)</div>
                  <div class="stars" id="rateStars"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- SAĞ: Şifre Değiştir -->
      <section id="secPassword" class="card">
        <div class="hd">Şifre Değiştir</div>
        <div class="bd">
          <div class="pwgrid">
            <input type="password" id="pwOld" placeholder="Mevcut şifre" autocomplete="current-password"/>
            <input type="password" id="pwNew" placeholder="Yeni şifre" autocomplete="new-password"/>
            <input type="password" id="pwNew2" placeholder="Yeni şifre (tekrar)" autocomplete="new-password"/>
            <button class="btn pri" id="btnPw">Değişikliği Onayla</button>
            <div class="muted" id="pwHint">• Eski şifre sorulur. • Yeni şifre iki kez girilir.</div>
            <div id="pwMsg" class="muted"></div>
          </div>
        </div>
      </section>

      <!-- ALTA: İlanlar (tam genişlik) -->
      <section id="secListings" class="card">
        <div class="hd">İlanlar</div>
        <div class="bd">
          <div class="muted" id="listInfo" style="margin-bottom:10px"></div>

          <h3 style="margin:6px 0">Yayındakiler</h3>
          <div class="listings" id="listActive"></div>

          <div class="spacer"></div>
          <h3 style="margin:6px 0">Onay Bekleyenler</h3>
          <div class="listings" id="listPending"></div>

          <div class="spacer"></div>
          <h3 style="margin:6px 0">Süresi Dolanlar</h3>
          <div class="listings" id="listExpired"></div>
        </div>
      </section>
    </div>
  </div>

  <nav class="mbnav">
    <a href="home.html">🏠<small>Sayfa</small></a>
    <a href="messages.html">💬<small>Mesajlar</small></a>
    <a href="notifications.html">🔔<small>Bildir.</small></a>
    <a href="ilan-ekle.html">➕<small>İlan Ekle</small></a>
    <a href="profile.html" class="active">👤<small>Profil</small></a>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    const firebaseConfig = {
      // TODO: kendi config'iniz
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const $ = s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
    const fmtDaysLeft = ms=>{const d=Math.ceil(ms/86400000);return d<=0?'Süre doldu':`${d} gün kaldı`};
    const byParam = k=> new URL(location.href).searchParams.get(k);
    const state={me:null,viewUid:null,isOwner:false,viewUser:null};

    $('#btnLogout')?.addEventListener('click', async()=>{try{await signOut(auth);location.href='auth.html?next=home.html'}catch(e){alert('Çıkış başarısız: '+e.message)}});

    function renderStars(el,val){el.innerHTML='';for(let i=1;i<=5;i++){const s=document.createElement('span');s.textContent=i<=val?'★':'☆';el.appendChild(s)}}
    function buildClickableStars(el,onPick){el.innerHTML='';for(let i=1;i<=5;i++){const b=document.createElement('button');b.type='button';b.textContent='☆';b.addEventListener('mouseenter',()=>{$$('#rateStars button').forEach((x,ix)=>x.textContent=ix<i?'★':'☆')});b.addEventListener('mouseleave',()=>{$$('#rateStars button').forEach(x=>x.textContent='☆')});b.addEventListener('click',()=>onPick(i));el.appendChild(b)}}

    async function ensureUserDoc(uid){const uref=doc(db,'users',uid);const s=await getDoc(uref);if(!s.exists()) await setDoc(uref,{createdAt:serverTimestamp(),ratingAvg:0,ratingCount:0});return uref}
    async function submitRating(targetUid,raterUid,val){const rref=doc(db,'ratings',targetUid,'by',raterUid);const rs=await getDoc(rref);if(rs.exists()) throw new Error('Bu kullanıcıyı zaten puanladınız.');await setDoc(rref,{value:val,ts:serverTimestamp()});const uref=await ensureUserDoc(targetUid);const us=await getDoc(uref);const {ratingAvg=0,ratingCount=0}=us.data()||{};const newCount=ratingCount+1;const newAvg=((ratingAvg*ratingCount)+val)/newCount;await updateDoc(uref,{ratingAvg:newAvg,ratingCount:newCount});return {newAvg,newCount}}
    async function loadAvg(uid){const us=await getDoc(doc(db,'users',uid));const {ratingAvg=0,ratingCount=0}=us.exists()?(us.data()||{}):{ratingAvg:0,ratingCount:0};renderStars($('#avgStars'),Math.round(ratingAvg));$('#avgText').textContent=`${(ratingAvg||0).toFixed(1)}/5 • ${ratingCount} oy`}

    async function loadProfile(uid){const uref=doc(db,'users',uid);const s=await getDoc(uref);if(!s.exists()) throw new Error('Kullanıcı profili bulunamadı');const u=s.data();state.viewUser=u;$('#displayName').textContent=(u.displayName||`${u.firstName||''} ${u.lastName||''}`).trim();$('#usernameBadge').textContent='@'+(u.username||'kullanici');$('#avatar').src=u.photoURL||'https://dummyimage.com/300x300/ffffff/000&text=👤';$('#inpFirst').value=u.firstName||'';$('#inpLast').value=u.lastName||'';$('#inpUsername').value=u.username||'';$('#inpPhone').value=(state.isOwner?(u.phone||''):'Gizli');if(state.isOwner){$('#publicInfo').textContent=u.email?`E-posta: ${u.email} (gizli) • Telefon: ${(u.phone||'—')} (gizli)`:'';$('#ownerActions').style.display='flex';$('#visitorActions').style.display='none'}else{$('#publicInfo').textContent='İsim, soyisim, telefon ve e‑posta gizlidir.';$('#ownerActions').style.display='none';$('#visitorActions').style.display='flex'}await loadAvg(uid);if(state.me && !state.isOwner){const gave=await getDoc(doc(db,'ratings',uid,'by',state.me.uid));$('#rateBox').style.display=gave.exists()?'none':'block'}$('#btnMsg')?.addEventListener('click',()=>{location.href=`messages.html?to=${encodeURIComponent(uid)}`})}

    $('#fileAvatar')?.addEventListener('change',async(e)=>{if(!state.isOwner) return;const f=e.target.files?.[0];if(!f) return;try{const r=sRef(storage,`profiles/${state.me.uid}.jpg`);await uploadBytes(r,f);const url=await getDownloadURL(r);await updateDoc(doc(db,'users',state.me.uid),{photoURL:url});$('#avatar').src=url;alert('Profil fotoğrafı güncellendi.')}catch(err){alert('Yükleme hatası: '+err.message)}});

    $('#btnPw')?.addEventListener('click',async()=>{const oldP=$('#pwOld').value.trim();const np=$('#pwNew').value.trim();const np2=$('#pwNew2').value.trim();const msg=$('#pwMsg');msg.textContent='';if(!oldP||!np||!np2){msg.textContent='Lütfen tüm alanları doldurun.';return}if(np!==np2){msg.textContent='Yeni şifreler eşleşmiyor.';return}try{const user=auth.currentUser;if(!user) throw new Error('Oturum bulunamadı');const cred=EmailAuthProvider.credential(user.email,oldP);await reauthenticateWithCredential(user,cred);await updatePassword(user,np);msg.textContent='✅ Şifre değiştirildi.';$('#pwOld').value=$('#pwNew').value=$('#pwNew2').value=''}catch(e){msg.textContent='❌ '+e.message}});

    buildClickableStars($('#rateStars'), async(val)=>{try{await submitRating(state.viewUid,state.me.uid,val);await loadAvg(state.viewUid);$('#rateBox').style.display='none';alert('Teşekkürler! Oy verdiniz.')}catch(e){alert(e.message)}});

    const DAYS30=30*86400000;
    function card(item,badgeType,badgeText,daysLeft){const d=document.createElement('div');d.className='listing';d.innerHTML=`<div class="thumb">${ item.coverURL?`<img src="${item.coverURL}" alt="">`:'<span class="muted">Görsel yok</span>'}</div><div class="meta"><div style="font-weight:600">${item.title||'İlan'}</div><div class="row" style="justify-content:space-between;align-items:center"><span class="badge ${badgeType}">${badgeText}</span><span class="muted" style="font-size:.85rem">${daysLeft||''}</span></div></div>`;return d}

    async function loadListings(uid){const q1=query(collection(db,'listings'), where('ownerId','==',uid), orderBy('createdAt','desc'));const snap=await getDocs(q1);const now=Date.now();const active=[],pending=[],expired=[];snap.forEach(docu=>{const it=docu.data();const ts=it.createdAt?.toMillis?it.createdAt.toMillis():(it.createdAt||0);const left=(ts? ts+DAYS30-now:-1);const isExpired=left<=0;const isApproved=it.status==='approved';const isPending=it.status==='pending';if(isPending) pending.push({it,left}); else if(isApproved && !isExpired) active.push({it,left}); else expired.push({it,left})});const L=id=>document.getElementById(id);L('listActive').innerHTML='';L('listPending').innerHTML='';L('listExpired').innerHTML='';active.forEach(({it,left})=>L('listActive').appendChild(card(it,'ok','Yayında',fmtDaysLeft(left))));pending.forEach(({it,left})=>L('listPending').appendChild(card(it,'warn','Onay bekliyor',fmtDaysLeft(left))));expired.forEach(({it,left})=>L('listExpired').appendChild(card(it,'err','Süresi doldu','—')));if(!state.isOwner){const h3=Array.from(document.querySelectorAll('h3')).find(h=>h.textContent.includes('Onay Bekleyenler'));if(h3){h3.style.display='none'}L('listPending').style.display='none'}$('#listInfo').textContent='İlanlar 30 gün yayında kalır. 1 ücretsiz ilan hakkı bulunur (ücret detayları sonra).'}

    async function ensureFreeQuotaFlag(uid){const uref=await ensureUserDoc(uid);const s=await getDoc(uref);return !!(s.data()?.freeQuotaUsed)}

    onAuthStateChanged(auth, async(user)=>{const paramUid=byParam('uid');if(!user && !paramUid){location.href='auth.html?next=profile.html';return}state.me=user||null;state.viewUid=paramUid||(user?user.uid:null);state.isOwner=!!(user && state.viewUid===user.uid);$('#hdrSub').textContent=state.isOwner?'Profilim':'Kullanıcı Profili';try{await loadProfile(state.viewUid);await loadListings(state.viewUid);if(state.isOwner){const used=await ensureFreeQuotaFlag(state.viewUid);if(!used){console.log('Ücretsiz ilan hakkınız mevcut. İlan eklerken kullanılacaktır.')}}}catch(e){alert('Profil yüklenemedi: '+e.message)}});
  </script>
</body>
</html>
