<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Profil ‚Ä¢ Takas √áemberi</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --txt:#0b1020; --muted:#2b3b62; --pri:#5b8aff;
      --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --stroke:rgba(0,0,0,.12);
      --g1:#ff7a7a; --g2:#ffd166; --g3:#6ee7ff; --g4:#9b8cff; --g5:#4ade80;
      --card:rgba(255,255,255,.86); --card2:rgba(255,255,255,.94);
      --mbnav-h:72px;
      --star-fill:#ffffff; --star-stroke:#b91c1c;
    }
    *{box-sizing:border-box}
    html,body{height:100%;overflow-x:hidden}
    body{
      margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--txt);
      background:linear-gradient(120deg,var(--g1),var(--g2),var(--g3),var(--g4),var(--g5));
      background-size:300% 300%;animation:gradientShift 18s ease infinite;min-height:100vh
    }
    @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}

    .wrap{max-width:1100px;margin:0 auto;padding:16px;padding-bottom:calc(var(--mbnav-h) + 72px + env(safe-area-inset-bottom,0px))}
    header.hd{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 14px;margin-bottom:14px;position:sticky;top:0;background:rgba(255,255,255,.7);backdrop-filter:blur(8px);border:1px solid var(--stroke);border-radius:16px;z-index:50}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:38px;width:38px;border-radius:12px;border:1px solid var(--stroke);object-fit:contain;background:#fff}

    nav.desktop{display:none;gap:8px;align-items:center}
    nav.mobileTop{display:flex;gap:8px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid var(--stroke);padding:10px 14px;border-radius:12px;background:var(--card);color:#0b1020;cursor:pointer}
    .btn.warn{background:transparent;border-color:var(--warn);color:#8a5400}
    @media(min-width:880px){nav.desktop{display:flex}nav.mobileTop{display:none}}

    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:880px){
      .grid{grid-template-columns:1fr 1fr;grid-template-areas:"left right" "full1 full1" "full2 full2"}
      #secProfile{grid-area:left} #secPassword{grid-area:right} #secRating{grid-area:full1} #secListings{grid-area:full2}
    }

    .card{background:var(--card);border:1px solid var(--stroke);border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--stroke);font-weight:800;color:#0b1020;background:var(--card2)}
    .card .bd{padding:16px}

    .profileRow{display:grid;grid-template-columns:96px 1fr;gap:16px;align-items:center}
    .avatar{width:96px;height:96px;border-radius:18px;overflow:hidden;border:1px solid var(--stroke);background:linear-gradient(135deg,#ffffff,#f5f7ff);display:grid;place-items:center}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .muted{color:var(--muted);font-size:.92rem}

    /* Profil alanlarƒ± */
    .fields{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:8px}
    .field label{font-size:1rem;color:var(--muted);font-weight:600}
    .field input{
      width:100%;height:52px;background:#ffffff;border:1px solid var(--stroke);
      border-radius:12px;padding:0 14px;color:#0b1020;font-size:1rem
    }
    .field input[disabled]{opacity:.95}
    @media(max-width:879px){ .fields{grid-template-columns:1fr} }

    /* ≈ûifre alanlarƒ± ‚Äî b√ºy√ºk ve alt alta */
    .pwgrid{display:grid;grid-template-columns:1fr;gap:12px}
    .pwgrid input{
      height:54px;background:#ffffff;border:1px solid var(--stroke);
      border-radius:12px;padding:0 14px;color:#0b1020;font-size:1rem
    }
    .pwgrid .btn{height:54px;font-size:1rem;font-weight:700}

    /* 5 adet Flag-Flip yƒ±ldƒ±z */
    .ownerStars{display:flex;gap:12px;justify-content:flex-start;margin-bottom:8px;animation:starColorFlip 3.6s ease-in-out infinite}
    .ownerStars svg{width:36px;height:36px}
    @keyframes wave{0%,100%{transform:translateY(0)}25%{transform:translateY(-4px)}75%{transform:translateY(4px)}}
    .ownerStars svg:nth-child(1){animation:wave 2.2s ease-in-out 0s infinite}
    .ownerStars svg:nth-child(2){animation:wave 2.2s ease-in-out .2s infinite}
    .ownerStars svg:nth-child(3){animation:wave 2.2s ease-in-out .4s infinite}
    .ownerStars svg:nth-child(4){animation:wave 2.2s ease-in-out .6s infinite}
    .ownerStars svg:nth-child(5){animation:wave 2.2s ease-in-out .8s infinite}
    @keyframes starColorFlip{
      0%  { --star-fill:#ffffff; --star-stroke:#ffffff; }
      50% { --star-fill:#b91c1c; --star-stroke:#b91c1c; }
      100%{ --star-fill:#ffffff; --star-stroke:#ffffff; }
    }

    /* Liste ba≈ülƒ±klarƒ±nƒ± gizle, sekme butonlarƒ±nƒ± b√ºy√ºt ve masa√ºst√ºnde de g√∂ster */
    .col h3{display:none}
    .list-tabs{display:flex;gap:10px;margin:0 0 14px 0;flex-wrap:wrap}
    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      padding:14px 18px;border-radius:999px;border:1px solid var(--stroke);
      background:#fff;color:#0b1020;cursor:pointer;font-size:1rem;font-weight:700
    }
    .pill.active{background:#0b1020;color:#fff}

    .lists-triple{display:grid;gap:12px}
    .col{background:rgba(255,255,255,.88);border:1px solid var(--stroke);border-radius:14px;padding:12px}
    .listings{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:880px){ .lists-triple{grid-template-columns:repeat(3,1fr)} .col{display:block} }
    @media(max-width:879px){ .lists-triple{grid-template-columns:1fr} .col{display:none} .col.show{display:block} }

    .mbnav{position:fixed;bottom:0;left:0;right:0;height:var(--mbnav-h);display:grid;grid-template-columns:repeat(3,1fr);gap:6px;padding:8px;background:rgba(255,255,255,.96);backdrop-filter:blur(8px);border-top:1px solid var(--stroke);z-index:60}
    .mbnav a{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;color:#0b1020}
    .mbnav a.active{border:1px solid var(--stroke);border-radius:8px}
    @media(min-width:880px){ .mbnav{display:none} }

    @media (prefers-reduced-motion: reduce){ .ownerStars, .ownerStars svg{animation:none !important} }

    /* ===== Username se√ßimi modal (Google i√ßin tek seferlik) ===== */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);
      display:none;align-items:center;justify-content:center;z-index:1000;
    }
    .modal{width:min(520px,92vw);background:#fff;border:1px solid var(--stroke);border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.2)}
    .modal .mhd{padding:14px 16px;border-bottom:1px solid var(--stroke);font-weight:800}
    .modal .mbd{padding:16px;display:grid;gap:12px}
    .modal .row{display:grid;gap:8px}
    .modal input{
      height:50px;border:1px solid var(--stroke);border-radius:12px;padding:0 14px;font-size:1rem
    }
    .modal .actions{display:flex;gap:10px;justify-content:flex-end}
    .modal .btn{height:46px;font-weight:700}
    .helper{font-size:.9rem;color:var(--muted)}
    .err{color:var(--err);font-weight:600}
    .ok{color:var(--ok);font-weight:600}
  </style>
</head>

<body>
  <div class="wrap">
    <header class="hd">
      <div class="brand">
        <img src="./assets/img/seffaf.png" alt="Logo">
        <div>
          <b>Takas √áemberi</b>
          <div class="muted">Profil</div>
        </div>
      </div>
      <nav class="desktop">
        <a class="btn" href="home.html">üè† Ana Sayfa</a>
        <a class="btn" href="messages.html">üí¨ Mesajlar</a>
        <a class="btn" href="notifications.html">üîî Bildirimler</a>
        <button class="btn warn" id="btnLogout">üö™ √áƒ±kƒ±≈ü</button>
      </nav>
      <nav class="mobileTop">
        <button class="btn warn" id="btnLogoutTop">üö™ √áƒ±kƒ±≈ü</button>
      </nav>
    </header>

    <div class="grid">
      <!-- Profil -->
      <section id="secProfile" class="card">
        <div class="hd">Profil</div>
        <div class="bd">
          <div class="profileRow">
            <div class="avatar"><img id="avatar" alt="Profil"></div>
            <div>
              <h2 id="displayName" style="margin:0;font-size:1.4rem">‚Äî</h2>
              <span class="badge" id="usernameBadge">@‚Äî</span>

              <div class="row" style="margin-top:8px">
                <label class="btn" style="padding:8px 12px">
                  üì∑ Resim Ekle / Deƒüi≈ütir
                  <input type="file" id="fileAvatar" accept="image/*" style="display:none">
                </label>
              </div>

              <div class="muted">ƒ∞sim, soyisim, telefon ve e-posta a≈üaƒüƒ±da g√∂r√ºn√ºr.</div>
            </div>
          </div>

          <div class="fields">
            <div class="field"><label>ƒ∞sim</label><input id="inpFirst" disabled></div>
            <div class="field"><label>Soyisim</label><input id="inpLast" disabled></div>
            <div class="field"><label>Kullanƒ±cƒ± Adƒ±</label><input id="inpUsername" disabled></div>
            <div class="field"><label>Telefon</label><input id="inpPhone" disabled></div>
            <div class="field"><label>E-posta</label><input id="inpEmail" disabled></div>
          </div>
        </div>
      </section>

      <!-- ≈ûifre (b√ºy√ºk ve alt alta) -->
      <section id="secPassword" class="card">
        <div class="hd">≈ûifre Deƒüi≈ütir</div>
        <div class="bd">
          <div class="pwgrid">
            <input type="password" id="pwOld" placeholder="Mevcut ≈üifre">
            <input type="password" id="pwNew" placeholder="Yeni ≈üifre">
            <input type="password" id="pwNew2" placeholder="Yeni ≈üifre (tekrar)">
            <button class="btn pri" id="btnPw">Deƒüi≈üikliƒüi Onayla</button>
          </div>
        </div>
      </section>

      <!-- Puanlama (sadece 5 Flag-Flip yƒ±ldƒ±z) -->
      <section id="secRating" class="card">
        <div class="hd">Puanlama</div>
        <div class="bd">
          <div class="ownerStars" id="ownerStars">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.6 5.3 5.9.86-4.25 4.14 1 5.86L12 16.9 6.75 18.7l1-5.86L3.5 8.66l5.9-.86L12 2.5z" fill="var(--star-fill)" stroke="var(--star-stroke)" stroke-width=".7"/></svg>
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.6 5.3 5.9.86-4.25 4.14 1 5.86L12 16.9 6.75 18.7l1-5.86L3.5 8.66l5.9-.86L12 2.5z" fill="var(--star-fill)" stroke="var(--star-stroke)" stroke-width=".7"/></svg>
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.6 5.3 5.9.86-4.25 4.14 1 5.86L12 16.9 6.75 18.7l1-5.86L3.5 8.66l5.9-.86L12 2.5z" fill="var(--star-fill)" stroke="var(--star-stroke)" stroke-width=".7"/></svg>
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.6 5.3 5.9.86-4.25 4.14 1 5.86L12 16.9 6.75 18.7l1-5.86L3.5 8.66l5.9-.86L12 2.5z" fill="var(--star-fill)" stroke="var(--star-stroke)" stroke-width=".7"/></svg>
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.6 5.3 5.9.86-4.25 4.14 1 5.86L12 16.9 6.75 18.7l1-5.86L3.5 8.66l5.9-.86L12 2.5z" fill="var(--star-fill)" stroke="var(--star-stroke)" stroke-width=".7"/></svg>
          </div>
        </div>
      </section>

      <!-- ƒ∞lanlar -->
      <section id="secListings" class="card">
        <div class="hd">ƒ∞lanlar</div>
        <div class="bd>
          <div class="list-tabs">
            <button class="pill active" data-target="colActive">Yayƒ±ndakiler</button>
            <button class="pill" data-target="colPending">Onay Bekleyenler</button>
            <button class="pill" data-target="colExpired">S√ºresi Dolanlar</button>
          </div>
          <div class="lists-triple">
            <div class="col show" id="colActive"><div class="listings" id="listActive"></div></div>
            <div class="col" id="colPending"><div class="listings" id="listPending"></div></div>
            <div class="col" id="colExpired"><div class="listings" id="listExpired"></div></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <nav class="mbnav">
    <a href="home.html" class="active">üè†<small>Ana Sayfa</small></a>
    <a href="messages.html">üí¨<small>Mesajlar</small></a>
    <a href="notifications.html">üîî<small>Bildirimler</small></a>
  </nav>

  <!-- Username Se√ßimi Modal (Google i√ßin, tek seferlik) -->
  <div class="modal-backdrop" id="unameModal">
    <div class="modal">
      <div class="mhd">Kullanƒ±cƒ± Adƒ±nƒ± Se√ß</div>
      <div class="mbd">
        <div class="helper">Bir defaya mahsus kullanƒ±cƒ± adƒ±nƒ± belirle. Sonradan deƒüi≈ütirilemez.</div>
        <div class="row">
          <input id="unameInput" placeholder="kullanici_adi" maxlength="20" />
          <div class="helper" id="unameHint">‚Ä¢ Harf/rakam . _ - kullanƒ±labilir, 3‚Äì20 karakter.</div>
          <div class="helper err" id="unameErr" style="display:none"></div>
          <div class="helper ok"  id="unameOk"  style="display:none">Uygun!</div>
        </div>
        <div class="actions">
          <button class="btn" id="unameCancel">Vazge√ß</button>
          <button class="btn" id="unameSave">Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase (CDN, modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBUUNSYxoWNUsK0C-C04qTUm6KM5756fvg",
      authDomain: "ureten-eller-v2.firebaseapp.com",
      projectId: "ureten-eller-v2",
      storageBucket: "ureten-eller-v2.firebasestorage.app",
      messagingSenderId: "621494781131",
      appId: "1:621494781131:web:13cc3b061a5e94b7cf874e"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---- utils ----
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const setInput = (sel,v)=>{const el=$(sel); if(el) el.value = v||'';}
    const setText  = (sel,v)=>{const el=$(sel); if(el) el.textContent = (v && String(v).trim()) ? v : '‚Äî';}

    const normalize = s => (s||'').toLowerCase()
      .replace(/√ß/g,"c").replace(/ƒü/g,"g").replace(/ƒ±/g,"i").replace(/√∂/g,"o").replace(/≈ü/g,"s").replace(/√º/g,"u")
      .replace(/[^\w._-]/g,"").replace(/^_+|_+$/g,"");

    function splitDisplay(name){
      if(!name) return {first:'', last:''};
      const p = name.trim().split(/\s+/);
      return { first: p[0]||'', last: p.length>1 ? p.slice(1).join(' ') : '' };
    }

    // e-postadan isim/soyisim √ßƒ±kar ‚Äî yalnƒ±zca Google oturumunda fallback i√ßin
    function namesFromEmail(email){
      const local = (email||'').split('@')[0] || '';
      const norm  = normalize(local);
      const parts = norm.split(/[._-]+/).filter(Boolean);
      const cap = s => s ? s[0].toUpperCase() + s.slice(1) : '';
      if (parts.length >= 2){
        return { first: cap(parts[0]), last: cap(parts[1]) };
      }
      return { first:'', last:'' };
    }

    // provider kontrol√º
    const isGoogle = (user)=> (user?.providerData||[]).some(p=>p.providerId==='google.com');
    const isPassword = (user)=> (user?.providerData||[]).some(p=>p.providerId==='password');

    // username rezerve et (usernames/{uname}) + users/{uid}.username = uname
    async function reserveAndSaveUsername(uname, uid){
      const refName = doc(db, "usernames", uname);
      await runTransaction(db, async (tx)=>{
        const s = await tx.get(refName);
        if (s.exists()) throw new Error('taken');
        tx.set(refName, { ownerUid: uid, createdAt: Date.now() });
        tx.set(doc(db,"users",uid), { username: uname }, { merge:true });
      });
    }

    // isim/soyisim/email alanlarƒ±nƒ± doldur (kural: password hesabƒ±nda mailden isim t√ºretme YOK)
    function fillFields(data={}, authUser=null, username='', useEmailFallback=false){
      const dn  = splitDisplay(authUser?.displayName);
      const em  = useEmailFallback ? namesFromEmail(authUser?.email || '') : {first:'', last:''};
      const first = data.firstName || data.ad || dn.first || em.first || '';
      const last  = data.lastName  || data.soyad || dn.last  || em.last  || '';
      const email = data.email || authUser?.email || '';
      const phone = data.phone || data.telefon || data.gsm || '';
      const uname = username || data.username || '';

      setText('#displayName', (first||last) ? `${first} ${last}`.trim() : '‚Äî');
      setText('#usernameBadge', uname ? '@'+uname : '@‚Äî');
      setInput('#inpFirst', first);
      setInput('#inpLast',  last);
      setInput('#inpUsername', uname);
      setInput('#inpPhone', phone);
      setInput('#inpEmail', email);
    }

    // Avatar (local)
    const AVATAR_KEY='tc_profile_avatar';
    (function(){
      const img = $('#avatar');
      const saved = localStorage.getItem(AVATAR_KEY);
      img.src = saved || 'https://dummyimage.com/300x300/ffffff/000&text=üë§';
      $('#fileAvatar')?.addEventListener('change', (e)=>{
        const f = e.target.files?.[0]; if(!f) return;
        const r = new FileReader();
        r.onload = ()=>{ img.src = r.result; try{ localStorage.setItem(AVATAR_KEY, r.result); }catch(_){} };
        r.readAsDataURL(f);
      });
    })();

    // √áƒ±kƒ±≈ü
    async function doLogout(){ try{ await signOut(auth); }catch(_){ } location.href='auth.html'; }
    $('#btnLogout')?.addEventListener('click', doLogout);
    $('#btnLogoutTop')?.addEventListener('click', doLogout);

    // Sekmeler
    (function(){
      const pills = $$('.list-tabs .pill');
      const cols = { colActive: $('#colActive'), colPending: $('#colPending'), colExpired: $('#colExpired') };
      function activate(key){
        Object.values(cols).forEach(c=>c.classList.remove('show'));
        cols[key].classList.add('show');
      }
      pills.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          pills.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          activate(btn.dataset.target);
        });
      });
      activate('colActive');
    })();

    // ===== Username Modal kontrol =====
    const modal = $('#unameModal');
    const unameInput = $('#unameInput');
    const unameErr = $('#unameErr');
    const unameOk  = $('#unameOk');
    const showModal = (val='')=>{
      unameInput.value = val;
      unameErr.style.display='none'; unameOk.style.display='none';
      modal.style.display='flex';
      unameInput.focus();
    };
    const hideModal = ()=>{ modal.style.display='none'; };

    function suggestFromEmail(email){
      const local = (email||'').split('@')[0] || '';
      let s = normalize(local);
      s = s.replace(/[^a-z0-9._-]/g,'').slice(0,20);
      if(s.length<3) s = 'user'+Math.floor(Math.random()*1000);
      return s;
    }
    function validateUname(u){
      if(!/^[a-z0-9._-]{3,20}$/.test(u)) return '3‚Äì20 karakter; harf/rakam . _ - kullanƒ±labilir.';
      if(/^[._-]/.test(u) || /[._-]$/.test(u)) return 'Ba≈üta/sonda . _ - olamaz.';
      if(/(\.\.|__|--)/.test(u)) return 'Ardƒ±≈üƒ±k ayra√ß kullanmayƒ±n.';
      return '';
    }

    async function checkAvailable(u){
      const s = await getDoc(doc(db,"usernames",u));
      return !s.exists();
    }

    $('#unameCancel').addEventListener('click', hideModal);
    $('#unameSave').addEventListener('click', async ()=>{
      const raw = normalize(unameInput.value);
      const err = validateUname(raw);
      if(err){ unameErr.textContent = err; unameErr.style.display='block'; unameOk.style.display='none'; return; }
      unameErr.style.display='none';
      try{
        const available = await checkAvailable(raw);
        if(!available){ unameErr.textContent='Bu kullanƒ±cƒ± adƒ± alƒ±nmƒ±≈ü.'; unameErr.style.display='block'; return; }
        // auth.user burada mevcut; onAuthStateChanged i√ßinde baƒülanacak
        const u = auth.currentUser;
        await reserveAndSaveUsername(raw, u.uid);
        unameOk.style.display='block';
        setTimeout(()=>{ hideModal(); }, 400);
        // rozet ve inputu g√ºncelle
        setText('#usernameBadge','@'+raw);
        setInput('#inpUsername', raw);
      }catch(e){
        unameErr.textContent='Kaydedilemedi. Tekrar deneyin.'; unameErr.style.display='block';
      }
    });

    // ---- Auth akƒ±≈üƒ± ----
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ fillFields({}, null, '', false); return; }

      try{
        const uref = doc(db,'users', user.uid);
        const snap = await getDoc(uref);
        const data = snap.exists() ? snap.data() : {};

        // Kullanƒ±cƒ± adƒ±:
        if (data.username){
          setText('#usernameBadge','@'+data.username);
          setInput('#inpUsername', data.username);
        } else if (isGoogle(user)) {
          // Google ile giri≈ü: kullanƒ±cƒ±ya bir defalƒ±k se√ßim yaptƒ±r
          const suggestion = suggestFromEmail(user.email || '');
          showModal(suggestion);
        } else {
          // email/password kaydƒ±: username zaten kayƒ±t akƒ±≈üƒ±nda belirlenmi≈ü olmalƒ±; yoksa bo≈ü bƒ±rak
          setText('#usernameBadge','@‚Äî');
          setInput('#inpUsername','');
        }

        // ƒ∞Sƒ∞M/SOYƒ∞Sƒ∞M DOLDURMA
        // Google: displayName varsa kullan; yoksa e-postadan t√ºret.
        // Password: SADECE Firestore'daki firstName/lastName'ƒ± g√∂ster (mailden t√ºretme YOK).
        const useEmailFallback = isGoogle(user);
        fillFields(data, user, data.username || '', useEmailFallback);

        // E-posta alanƒ±
        if (!data.email && user.email){
          await setDoc(uref, { email: user.email }, { merge:true });
        }

        // Eƒüer Google ve first/last bo≈üsa, displayName/email'den bir kere yaz (kayƒ±t i√ßin)
        if (isGoogle(user) && (!data.firstName || !data.lastName)){
          const dn = splitDisplay(user.displayName);
          const em = namesFromEmail(user.email||'');
          const payload = {};
          if (!data.firstName) payload.firstName = dn.first || em.first || '';
          if (!data.lastName)  payload.lastName  = dn.last  || em.last  || '';
          if (Object.keys(payload).length){
            await setDoc(uref, payload, { merge:true });
          }
        }

      }catch(e){
        console.error('Profil doldurma hatasƒ±:', e);
        // Yine de ekranda minimum bilgiyi g√∂ster
        setText('#usernameBadge','@‚Äî');
        fillFields({}, user, '', isGoogle(user));
      }
    });
  </script>
</body>
</html>
