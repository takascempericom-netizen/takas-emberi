<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Profil • Takas Çemberi</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0a0a;--panel:#101214;--panel2:#15181b;--line:#1f2429;--fg:#e8edf3;--muted:#9aa7b5;--pri:#38bdf8;--ok:#22c55e;--bad:#ef4444}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .hdr{display:flex;align-items:center;gap:14px;padding:16px 18px;border-bottom:1px solid var(--line)}
    .hdr .avatar{width:56px;height:56px;border-radius:50%;overflow:hidden;border:1px solid var(--line)}
    .hdr .avatar img{width:100%;height:100%;object-fit:cover}
    .hdr .meta{display:flex;flex-direction:column}
    .hdr .name{font-weight:800}
    .hdr .uid{font-size:12px;color:var(--muted)}
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--line);padding:10px 16px}
    .tab{padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;color:#cbd5e1}
    .tab.active{background:var(--panel2);color:#fff}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:14px;padding:16px}
    @media (max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:680px){.grid{grid-template-columns:1fr}}
    .listing-card{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0d0f12}
    .ph{background:#0b0d10;height:180px;display:block}
    .ph img{width:100%;height:180px;object-fit:cover;display:block}
    .body{padding:12px}
    .title{font-size:15px;font-weight:800;margin:0 0 6px}
    .muted{color:var(--muted);font-size:12px}
    .note{display:none;margin:6px 16px 0;color:#cbd5e1}
    .stat{padding:10px 16px;border-top:1px solid var(--line);font-size:12px;color:var(--muted)}
    .row{display:flex;gap:14px;padding:16px}
    @media (max-width:980px){.row{flex-direction:column}}
    .col{flex:1}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn-pri{background:var(--pri);color:#00111a}
    .btn-ghost{background:transparent;border:1px solid var(--line);color:#e5e7eb}
    .set{margin-top:14px}
    .set form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .set label{font-size:12px;color:var(--muted)}
    .set input{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0d0f12;color:#fff}
    .full{grid-column:1/-1}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="hdr">
      <div class="avatar"><img id="profileAvatar" src="https://i.imgur.com/3SgkGmQ.png" alt="avatar"></div>
      <div class="meta">
        <div class="name" id="profileName">Profil</div>
        <div class="uid"><span id="profileUid">—</span></div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="btn btn-ghost" id="btnRefresh">Yenile</button>
        <button class="btn btn-ghost" id="btnLogout" style="display:none">Çıkış</button>
        <button class="btn btn-pri" id="btnGoogle" style="display:none">Google ile Giriş</button>
        <button class="btn btn-ghost" id="btnEdit">Ayarlar</button>
      </div>
    </div>

    <div id="gate" style="padding:12px 16px;color:#f59e0b;display:none">Giriş yapın veya URL'ye <code>?uid=&lt;kullanıcıUid&gt;</code> ekleyin.</div>

    <div class="tabs">
      <div class="tab active" data-tab="pub">Yayında <span id="cntPub">0</span></div>
      <div class="tab" data-tab="pend">Onay bekleyen <span id="cntPend">0</span></div>
      <div class="tab" data-tab="exp">Süresi dolan <span id="cntExp">0</span></div>
    </div>

    <div class="note" id="note">İlanlar yükleniyor…</div>
    <div class="grid" id="list"></div>
    <div class="stat" id="stat">—</div>
  </div>

  <div class="card set" id="settings" style="display:none">
    <div class="hdr"><div style="font-weight:800">Ayarlar</div></div>
    <div class="row">
      <div class="col">
        <form onsubmit="return false">
          <div class="full"><label>Görünen İsim</label><input id="inpDisplayName" type="text" placeholder="Ad Soyad"></div>
          <div><label>Kullanıcı Adı</label><input id="inpUsername" type="text" placeholder="ornek_kullanici"></div>
          <div><label>E-posta</label><input id="inpEmail" type="email" placeholder="mail@ornek.com"></div>
          <div class="full"><label>Profil Fotoğrafı</label><input id="inpAvatar" type="file" accept="image/*"></div>
          <div><label>Şifre (opsiyonel)</label><input id="inpPass" type="password" placeholder="Yeni şifre (min 6)"></div>
          <div class="full" style="display:flex;gap:8px">
            <button class="btn btn-pri" id="btnSaveProfile">Profili Kaydet</button>
            <button class="btn btn-ghost" id="btnSendReset">Şifre Sıfırlama E-postası</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, updatePassword, sendPasswordResetEmail, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, getDocs, getDoc, doc, query, where, collection, limit, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, getDownloadURL, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const cfg = {
  apiKey: "AIzaSyBUUNSYxoWNUsK0C-C04qTUm6fvg",
  authDomain: "ureten-eller-v2.firebaseapp.com",
  projectId: "ureten-eller-v2",
  storageBucket: "ureten-eller-v2.firebasestorage.app",
  messagingSenderId: "621494781131",
  appId: "1:621494781131:web:13cc3b061a5e94b7cf874e"
};

// DEFAULT app
const app = (getApps().length ? getApp() : initializeApp(cfg));
const auth = getAuth(app);
const db   = getFirestore(app);
const st   = getStorage(app);

// UI refs
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const avatar=$("#profileAvatar"), nameEl=$("#profileName"), uidEl=$("#profileUid"),
      listEl=$("#list"), note=$("#note"), stat=$("#stat"), gate=$("#gate"),
      btnGoogle=$("#btnGoogle"), btnLogout=$("#btnLogout"), btnEdit=$("#btnEdit"), btnRefresh=$("#btnRefresh"),
      settings=$("#settings"), cntPub=$("#cntPub"), cntPend=$("#cntPend"), cntExp=$("#cntExp"),
      inpDisplayName=$("#inpDisplayName"), inpUsername=$("#inpUsername"), inpEmail=$("#inpEmail"),
      inpAvatar=$("#inpAvatar"), inpPass=$("#inpPass"), btnSaveProfile=$("#btnSaveProfile"), btnSendReset=$("#btnSendReset");

// --- Heuristik: oturum yoksa bile localStorage'daki son kullanıcıyı çek ---
function getAuthUserFromLocalStorage(){
  try{
    for(const k of Object.keys(localStorage)){
      if(k.startsWith("firebase:authUser:")){
        const j=JSON.parse(localStorage.getItem(k)||"null");
        if(j && j.uid) return j; // {uid, email, displayName, photoURL, ...}
      }
    }
  }catch{}
  return null;
}
function getTargetUid(){
  const p = new URLSearchParams(location.search);
  return p.get("uid") || p.get("id") || null;
}
function classify(d){
  const now=Date.now();
  const s=(d?.status||d?.state||"").toString().toLowerCase();
  const approved = d?.approved===true || d?.isApproved===true || ["approved","active","yayında","yayinda","published"].includes(s);
  const pending  = ["pending","waiting","bekleyen","onay-bekliyor"].includes(s) || d?.moderation==="pending" || (d?.approved===false||d?.isApproved===false);
  const expTs = d?.expiresAt?.toMillis ? d.expiresAt.toMillis() : (typeof d?.expiresAt==="number"?d.expiresAt:null);
  const expired = (expTs && expTs<now) || ["expired","passive","suresi-dolan"].includes(s);
  if (expired) return "exp"; if (pending) return "pend"; if (approved) return "pub"; return "pub";
}
function cardTpl(it){
  const t=it.title||"-", price=(it.price!=null?`${it.price}₺`:""), loc=[it.city,it.district].filter(Boolean).join(" / ");
  return `<div class="listing-card" data-doc-id="${it.id}"><a class="ph"><img alt="${t}" loading="lazy" decoding="async"></a><div class="body"><h3 class="title">${t}</h3><div class="muted">${loc}</div><div class="muted">${price}</div></div></div>`;
}
async function resolveImageURL(d){
  const list=[];
  for (const k of ["coverPhoto","coverUrl","cover","thumbnail","thumb","mainImage","primaryImage","image","imageUrl","photo","photoUrl"]) if(d?.[k]) list.push(d[k]);
  for (const k of ["photos","images","imageUrls","gallery","media","files","attachments"]) if(Array.isArray(d?.[k])) list.push(...d[k]);
  for (let x of list){
    let u=null; if(typeof x==="string") u=x; else if (x&&typeof x==="object") u=x.url||x.src||x.path||x.storagePath||x.fullPath||x.downloadURL||x.downloadUrl||null;
    if(!u) continue;
    if(/^https?:\/\//i.test(u)) return u;
    if(/^gs:\/\//i.test(u)){ const p=u.replace(/^gs:\/\/[^/]+\//i,""); try{return await getDownloadURL(ref(st,p));}catch{} }
    try{ return await getDownloadURL(ref(st,u)); }catch{}
  }
  return null;
}
async function renderListings(uid, tab="pub"){
  try{
    listEl.innerHTML=""; note.style.display="block"; note.textContent="İlanlar yükleniyor…"; stat.textContent="—";
    const snap = await getDocs(query(collection(db,"listings"), where("ownerId","==",uid), limit(300)));
    if(snap.empty){ cntPub.textContent="0"; cntPend.textContent="0"; cntExp.textContent="0"; listEl.innerHTML=""; note.textContent="Bu kullanıcıya ait ilan bulunamadı."; stat.textContent="0 ilan"; return; }
    const all=[]; snap.forEach(docu=>{ const d=docu.data(); all.push({ id:docu.id, title:d.title||"", price:d.price??null, city:d.city||"", district:d.district||"", _raw:d }); });
    const buckets={pub:[],pend:[],exp:[]}; for(const it of all) buckets[classify(it._raw)].push(it);
    cntPub.textContent=buckets.pub.length; cntPend.textContent=buckets.pend.length; cntExp.textContent=buckets.exp.length;
    const show=buckets[tab]||[]; listEl.innerHTML=show.map(cardTpl).join("");
    let ok=0, fail=0;
    for(const el of $$(".listing-card")){
      const id=el.getAttribute("data-doc-id");
      const it=show.find(x=>x.id===id);
      const url=await resolveImageURL(it?._raw); const img=el.querySelector("img");
      if(url){ img.src=url; img.srcset=url; img.referrerPolicy="no-referrer"; ok++; } else { img.src="https://i.imgur.com/3SgkGmQ.png"; fail++; }
    }
    note.style.display="none"; stat.textContent=`${show.length} ilan • ${ok} görsel yüklendi${fail?`, ${fail} eksik görsel`:``}`;
  }catch(e){ console.error(e); note.style.display="block"; note.textContent="Hata: "+(e?.message||e); }
}
async function loadUser(uid){
  const s=await getDoc(doc(db,"users",uid)); const d=s.exists()?s.data():{};
  const display=d.displayName||d.username||d.email||"Profil"; const photo=d.photoURL||d.avatar||"https://i.imgur.com/3SgkGmQ.png";
  $("#profileAvatar").src=photo; $("#profileName").textContent=display; $("#profileUid").textContent=uid;
  $("#inpDisplayName").value=d.displayName||""; $("#inpUsername").value=d.username||""; $("#inpEmail").value=d.email||"";
}
function tabsWire(uid){
  $$(".tab").forEach(t=>{ t.setAttribute("role","button"); t.style.cursor="pointer";
    t.onclick=()=>{ $$(".tab").forEach(x=>x.classList.remove("active")); t.classList.add("active"); renderListings(uid,t.dataset.tab||"pub"); };
  });
}
function showGate(v){ $("#gate").style.display=v?"block":"none"; }
function showSettings(v){ $("#settings").style.display=v?"block":"none"; }
$("#btnEdit").onclick=()=>showSettings($("#settings").style.display==="none");
$("#btnRefresh").onclick=()=>location.reload();

// Giriş/Çıkış butonları
$("#btnGoogle").onclick=async()=>{ try{ await signInWithPopup(auth,new GoogleAuthProvider()); }catch(e){ alert(e?.message||e); } };
$("#btnLogout").onclick=async()=>{ try{ await signOut(auth); location.reload(); }catch(e){ alert(e?.message||e);} };

// Avatar yükleme
$("#inpAvatar").addEventListener("change", async ()=>{
  const f=$("#inpAvatar").files?.[0]; if(!f) return; const user=auth.currentUser; if(!user) return alert("Giriş gerekli");
  const path=`avatars/${user.uid}/avatar_${Date.now()}.jpg`; const task=uploadBytesResumable(ref(st,path),f,{contentType:f.type||"image/jpeg"});
  task.on("state_changed", null, e=>alert(e?.message||e), async ()=>{
    const url=await getDownloadURL(ref(st,path)); await updateProfile(user,{photoURL:url});
    await setDoc(doc(db,"users",user.uid),{photoURL:url,updatedAt:serverTimestamp()},{merge:true}); $("#profileAvatar").src=url; alert("Profil fotoğrafı güncellendi.");
  });
});
$("#btnSaveProfile").onclick=async()=>{
  const user=auth.currentUser; if(!user) return alert("Giriş gerekli");
  const data={ displayName:($("#inpDisplayName").value||"").trim()||null, username:($("#inpUsername").value||"").trim()||null, email:user.email||( $("#inpEmail").value||"").trim()||null, updatedAt:serverTimestamp() };
  try{
    if(data.displayName) await updateProfile(user,{displayName:data.displayName});
    await setDoc(doc(db,"users",user.uid),data,{merge:true});
    const pw=($("#inpPass").value||"").trim(); if(pw.length>=6){ try{ await updatePassword(user,pw); alert("Şifre güncellendi"); }catch(e){ alert("Şifre güncellenemedi: "+(e?.message||e)); } }
    alert("Profil kaydedildi.");
  }catch(e){ alert(e?.message||e); }
};
$("#btnSendReset").onclick=async()=>{
  const user=auth.currentUser; const email=user?.email || ($("#inpEmail").value||"").trim(); if(!email) return alert("E-posta bulunamadı.");
  try{ await sendPasswordResetEmail(auth,email); alert("Şifre sıfırlama e-postası gönderildi."); }catch(e){ alert(e?.message||e); }
};

// Başlatma: önce localStorage oturumunu dener, sonra auth state gelir
async function start(){
  const boot = getAuthUserFromLocalStorage(); // {uid,email,...} olabilir
  let usingUid = getTargetUid() || boot?.uid || null;
  if(usingUid){ showGate(false); $("#btnGoogle").style.display="none"; $("#btnLogout").style.display="inline-block"; await loadUser(usingUid); tabsWire(usingUid); await renderListings(usingUid,"pub"); }
  else { showGate(true); $("#btnGoogle").style.display="inline-block"; $("#btnLogout").style.display="none"; }

  onAuthStateChanged(auth, async (user)=>{
    const u2 = getTargetUid() || user?.uid || boot?.uid || null;
    showGate(!u2);
    $("#btnGoogle").style.display = u2 ? "none" : "inline-block";
    $("#btnLogout").style.display = user ? "inline-block" : "none";
    if(!u2) return;
    await loadUser(u2);
    $$(".tab").forEach(x=>x.classList.remove("active")); const fst=document.querySelector('.tab[data-tab="pub"]'); if(fst) fst.classList.add("active");
    tabsWire(u2); await renderListings(u2,"pub");
  });
}
document.addEventListener("DOMContentLoaded", start);
</script>
<style>
  .bottom-nav{
    position:fixed; left:0; right:0; bottom:0;
    background:var(--panel2); border-top:1px solid var(--line);
    display:flex; justify-content:space-around; gap:6px;
    padding:8px env(safe-area-inset-right) calc(8px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
    z-index:9999;
  }
  .bottom-nav .item{
    display:flex; flex-direction:column; align-items:center; gap:4px;
    color:var(--muted); text-decoration:none; font-size:11px; min-width:68px
  }
  .bottom-nav .item svg{ width:22px; height:22px }
  /* masaüstünde gizle (istersen kaldır) */
  @media (min-width: 900px){ .bottom-nav{ display:none; } }
</style>

<nav class="bottom-nav" id="bottomNav">
  <a href="/" class="item" id="nav-home" title="Ana Sayfa" aria-label="Ana Sayfa">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1z"/></svg>
    <span>Ana Sayfa</span>
  </a>
  <button class="item" id="nav-messages" title="Mesajlar" aria-label="Mesajlar" style="background:none;border:0;cursor:pointer">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15a4 4 0 0 1-4 4H8l-5 3 1.5-4.5A4 4 0 0 1 4 15V7a4 4 0 0 1 4-4h9a4 4 0 0 1 4 4z"/></svg>
    <span>Mesajlar</span>
  </button>
  <button class="item" id="nav-notif" title="Bildirimler" aria-label="Bildirimler" style="background:none;border:0;cursor:pointer">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 9h18c0-2-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
    <span>Bildirimler</span>
  </button>
  <button class="item" id="nav-logout" title="Çıkış" aria-label="Çıkış" style="background:none;border:0;cursor:pointer">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="M16 17l5-5-5-5"/><path d="M21 12H9"/></svg>
    <span>Çıkış</span>
  </button>
</nav>

<script type="module">
  import { getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  const app = (getApps().length ? getApp() : null);
  const auth = app ? getAuth(app) : null;

  const P_MESSAGES = ["/messages.html","/mesajlar.html","/support.html","/chat.html","/destek.html"];
  const P_NOTIF    = ["/notifications.html","/bildiriler.html","/bildirimler.html","/bildiri.html"];

  async function goFirst(paths){
    for(const p of paths){
      try{ const r = await fetch(p,{method:"HEAD"}); if(r.ok){ location.href=p; return; } }catch(e){}
    }
    // bulunamazsa ana sayfaya dön
    location.href="/";
  }

  document.getElementById("nav-messages")?.addEventListener("click", ()=>goFirst(P_MESSAGES));
  document.getElementById("nav-notif")?.addEventListener("click",   ()=>goFirst(P_NOTIF));
  document.getElementById("nav-logout")?.addEventListener("click",  async ()=>{
    try{ if(auth) await signOut(auth); }catch(e){}
    location.href="/";
  });

  // Giriş durumu: auth varsa Logout göster; yoksa gizle
  try{
    if(auth){
      auth.onAuthStateChanged(u=>{
        document.getElementById("nav-logout").style.display = u ? "flex" : "none";
      });
    }
  }catch{}
</script>

</body>
</html>
